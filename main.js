"use strict";var ut=Object.defineProperty;var is=Object.getOwnPropertyDescriptor;var as=Object.getOwnPropertyNames;var cs=Object.prototype.hasOwnProperty;var ls=(r,e)=>{for(var t in e)ut(r,t,{get:e[t],enumerable:!0})},us=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of as(e))!cs.call(r,n)&&n!==t&&ut(r,n,{get:()=>e[n],enumerable:!(s=is(e,n))||s.enumerable});return r};var ds=r=>us(ut({},"__esModule",{value:!0}),r);var zs={};ls(zs,{default:()=>at});module.exports=ds(zs);var os=require("obsidian");var C=require("obsidian"),Me=class extends C.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Cotton AI Settings"});let s=new C.Setting(e).setName("Claude API Key").addText(n=>n.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.apiKey).onChange(async o=>{this.plugin.settings.apiKey=o,await this.plugin.saveSettings()})).descEl.createDiv();s.appendText("Your Anthropic API key. "),s.createEl("a",{text:"Get your API key",href:"https://console.anthropic.com/settings/keys"}),new C.Setting(e).setName("Model").setDesc("Claude model to use for responses").addDropdown(n=>n.addOption("claude-sonnet-4-20250514","Claude Sonnet 4 (Recommended)").addOption("claude-opus-4-20250514","Claude Opus 4 (Most capable)").addOption("claude-3-5-haiku-20241022","Claude 3.5 Haiku (Fastest)").setValue(this.plugin.settings.model).onChange(async o=>{this.plugin.settings.model=o,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Preferences"}),new C.Setting(e).setName("Personal Preferences Path").setDesc("Path to your personal Cotton preferences (e.g., ~/.cotton/preferences)").addText(n=>n.setPlaceholder("~/.cotton/preferences").setValue(this.plugin.settings.personalPrefsPath).onChange(async o=>{this.plugin.settings.personalPrefsPath=o,await this.plugin.saveSettings()})),new C.Setting(e).setName("Team Preferences Path").setDesc("Path to team Cotton preferences (e.g., .cotton/preferences)").addText(n=>n.setPlaceholder(".cotton/preferences").setValue(this.plugin.settings.teamPrefsPath).onChange(async o=>{this.plugin.settings.teamPrefsPath=o,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Behavior"}),new C.Setting(e).setName("Stream Responses").setDesc("Show responses as they are generated").addToggle(n=>n.setValue(this.plugin.settings.streamResponses).onChange(async o=>{this.plugin.settings.streamResponses=o,await this.plugin.saveSettings()})),new C.Setting(e).setName("Context Lines").setDesc("Number of lines from current note to include as context").addSlider(n=>n.setLimits(0,500,10).setValue(this.plugin.settings.contextLines).setDynamicTooltip().onChange(async o=>{this.plugin.settings.contextLines=o,await this.plugin.saveSettings()})),new C.Setting(e).setName("Include Backlinks").setDesc("Include backlink information in context").addToggle(n=>n.setValue(this.plugin.settings.includeBacklinks).onChange(async o=>{this.plugin.settings.includeBacklinks=o,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Storage"}),new C.Setting(e).setName("Chat Folder").setDesc("Folder to save chat conversations and responses").addText(n=>n.setPlaceholder("Cotton/Chats").setValue(this.plugin.settings.chatFolder).onChange(async o=>{this.plugin.settings.chatFolder=o,await this.plugin.saveSettings()}))}};var U="0.39.0";var Bt=!1,H,dt,hs,ps,fs,It,ms,Ae,ht,Ft,pt,Re,Nt;function Dt(r,e={auto:!1}){if(Bt)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${r.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(H)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${r.kind}'\` after \`import '@anthropic-ai/sdk/shims/${H}'\``);Bt=e.auto,H=r.kind,dt=r.fetch,hs=r.Request,ps=r.Response,fs=r.Headers,It=r.FormData,ms=r.Blob,Ae=r.File,ht=r.ReadableStream,Ft=r.getMultipartRequestOptions,pt=r.getDefaultAgent,Re=r.fileFromPath,Nt=r.isFsReadStream}var Te=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function $t({manuallyImported:r}={}){let e=r?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n",t,s,n,o;try{t=fetch,s=Request,n=Response,o=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:s,Response:n,Headers:o,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,a)=>({...a,body:new Te(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:i=>!1}}H||Dt($t(),{auto:!0});var c=class extends Error{},y=class r extends c{constructor(e,t,s,n){super(`${r.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.request_id=n?.["request-id"],this.error=t}static makeMessage(e,t,s){let n=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new D({message:s,cause:Be(t)});let o=t;return e===400?new ie(e,o,s,n):e===401?new ae(e,o,s,n):e===403?new ce(e,o,s,n):e===404?new le(e,o,s,n):e===409?new ue(e,o,s,n):e===422?new de(e,o,s,n):e===429?new he(e,o,s,n):e>=500?new pe(e,o,s,n):new r(e,o,s,n)}},b=class extends y{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},D=class extends y{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},Q=class extends D{constructor({message:e}={}){super({message:e??"Request timed out."})}},ie=class extends y{},ae=class extends y{},ce=class extends y{},le=class extends y{},ue=class extends y{},de=class extends y{},he=class extends y{},pe=class extends y{};var Ie=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},W=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},E,B=class{constructor(){E.set(this,void 0),this.buffer=new Uint8Array,Ie(this,E,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,s=new Uint8Array(this.buffer.length+t.length);s.set(this.buffer),s.set(t,this.buffer.length),this.buffer=s;let n=[],o;for(;(o=ws(this.buffer,W(this,E,"f")))!=null;){if(o.carriage&&W(this,E,"f")==null){Ie(this,E,o.index,"f");continue}if(W(this,E,"f")!=null&&(o.index!==W(this,E,"f")+1||o.carriage)){n.push(this.decodeText(this.buffer.slice(0,W(this,E,"f")-1))),this.buffer=this.buffer.slice(W(this,E,"f")),Ie(this,E,null,"f");continue}let i=W(this,E,"f")!==null?o.preceding-1:o.preceding,a=this.decodeText(this.buffer.slice(0,i));n.push(a),this.buffer=this.buffer.slice(o.index),Ie(this,E,null,"f")}return n}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new c(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new c(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new c("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};E=new WeakMap;B.NEWLINE_CHARS=new Set([`
`,"\r"]);B.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function ws(r,e){for(let n=e??0;n<r.length;n++){if(r[n]===10)return{preceding:n,index:n+1,carriage:!1};if(r[n]===13)return{preceding:n,index:n+1,carriage:!0}}return null}function Lt(r){for(let s=0;s<r.length-1;s++){if(r[s]===10&&r[s+1]===10||r[s]===13&&r[s+1]===13)return s+2;if(r[s]===13&&r[s+1]===10&&s+3<r.length&&r[s+2]===13&&r[s+3]===10)return s+4}return-1}function fe(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var M=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;async function*n(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let i of bs(e,t)){if(i.event==="completion")try{yield JSON.parse(i.data)}catch(a){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),a}if(i.event==="message_start"||i.event==="message_delta"||i.event==="message_stop"||i.event==="content_block_start"||i.event==="content_block_delta"||i.event==="content_block_stop")try{yield JSON.parse(i.data)}catch(a){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),a}if(i.event!=="ping"&&i.event==="error")throw y.generate(void 0,`SSE Error: ${i.data}`,i.data,mt(e.headers))}o=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{o||t.abort()}}return new r(n,t)}static fromReadableStream(e,t){let s=!1;async function*n(){let i=new B,a=fe(e);for await(let h of a)for(let d of i.decode(h))yield d;for(let h of i.flush())yield h}async function*o(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let i=!1;try{for await(let a of n())i||a&&(yield JSON.parse(a));i=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{i||t.abort()}}return new r(o,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],s=this.iterator(),n=o=>({next:()=>{if(o.length===0){let i=s.next();e.push(i),t.push(i)}return o.shift()}});return[new r(()=>n(e),this.controller),new r(()=>n(t),this.controller)]}toReadableStream(){let e=this,t,s=new TextEncoder;return new ht({async start(){t=e[Symbol.asyncIterator]()},async pull(n){try{let{value:o,done:i}=await t.next();if(i)return n.close();let a=s.encode(JSON.stringify(o)+`
`);n.enqueue(a)}catch(o){n.error(o)}},async cancel(){await t.return?.()}})}};async function*bs(r,e){if(!r.body)throw e.abort(),new c("Attempted to iterate over a response with no body");let t=new ft,s=new B,n=fe(r.body);for await(let o of xs(n))for(let i of s.decode(o)){let a=t.decode(i);a&&(yield a)}for(let o of s.flush()){let i=t.decode(o);i&&(yield i)}}async function*xs(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,n=new Uint8Array(e.length+s.length);n.set(e),n.set(s,e.length),e=n;let o;for(;(o=Lt(e))!==-1;)yield e.slice(0,o),e=e.slice(o)}e.length>0&&(yield e)}var ft=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let o={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],o}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=_s(e,":");return n.startsWith(" ")&&(n=n.substring(1)),t==="event"?this.event=n:t==="data"&&this.data.push(n),null}};function _s(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}var Es=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",Ss=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&me(r),me=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function";async function Ot(r,e,t){if(r=await r,Ss(r))return r;if(Es(r)){let n=await r.blob();e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file");let o=me(n)?[await n.arrayBuffer()]:[n];return new Ae(o,e,t)}let s=await vs(r);if(e||(e=Ps(r)??"unknown_file"),!t?.type){let n=s[0]?.type;typeof n=="string"&&(t={...t,type:n})}return new Ae(s,e,t)}async function vs(r){let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(me(r))e.push(await r.arrayBuffer());else if(Cs(r))for await(let t of r)e.push(t);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${r?.constructor?.name}; props: ${ks(r)}`);return e}function ks(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function Ps(r){return gt(r.name)||gt(r.filename)||gt(r.path)?.split(/[\\/]/).pop()}var gt=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},Cs=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",yt=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody";var As=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},Rs=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},Fe;async function Wt(r){let{response:e}=r;if(r.options.stream)return Y("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):M.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let o=await e.json();return Y("response",e.status,e.url,e.headers,o),Vt(o,e)}let n=await e.text();return Y("response",e.status,e.url,e.headers,n),n}function Vt(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var De=class r extends Promise{constructor(e,t=Wt){super(s=>{s(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new r(this.responsePromise,async t=>Vt(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},$e=class{constructor({baseURL:e,maxRetries:t=2,timeout:s=6e5,httpAgent:n,fetch:o}){this.baseURL=e,this.maxRetries=wt("maxRetries",t),this.timeout=wt("timeout",s),this.httpAgent=n,this.fetch=o??dt}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Fs(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Os()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(async n=>{let o=n&&me(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:o}}))}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){e={...e};let{method:s,path:n,query:o,headers:i={}}=e,a=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:yt(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,h=this.calculateContentLength(a),d=this.buildURL(n,o);"timeout"in e&&wt("timeout",e.timeout),e.timeout=e.timeout??this.timeout;let f=e.httpAgent??this.httpAgent??pt(d),m=e.timeout+1e3;typeof f?.options?.timeout=="number"&&m>(f.options.timeout??0)&&(f.options.timeout=m),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let j=this.buildHeaders({options:e,headers:i,contentLength:h,retryCount:t});return{req:{method:s,...a&&{body:a},headers:j,...f&&{agent:f},signal:e.signal??null},url:d,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:s,retryCount:n}){let o={};s&&(o["content-length"]=s);let i=this.defaultHeaders(e);return Ht(o,i),Ht(o,t),yt(e.body)&&H!=="node"&&delete o["content-type"],Ne(i,"x-stainless-retry-count")===void 0&&Ne(t,"x-stainless-retry-count")===void 0&&(o["x-stainless-retry-count"]=String(n)),Ne(i,"x-stainless-timeout")===void 0&&Ne(t,"x-stainless-timeout")===void 0&&e.timeout&&(o["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(o,t),o}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new c("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,s,n){return y.generate(e,t,s,n)}request(e,t=null){return new De(this.makeRequest(e,t))}async makeRequest(e,t){let s=await e,n=s.maxRetries??this.maxRetries;t==null&&(t=n),await this.prepareOptions(s);let{req:o,url:i,timeout:a}=this.buildRequest(s,{retryCount:n-t});if(await this.prepareRequest(o,{url:i,options:s}),Y("request",i,s,o.headers),s.signal?.aborted)throw new b;let h=new AbortController,d=await this.fetchWithTimeout(i,o,a,h).catch(Be);if(d instanceof Error){if(s.signal?.aborted)throw new b;if(t)return this.retryRequest(s,t);throw d.name==="AbortError"?new Q:new D({cause:d})}let f=mt(d.headers);if(!d.ok){if(t&&this.shouldRetry(d)){let lt=`retrying, ${t} attempts remaining`;return Y(`response (error; ${lt})`,d.status,i,f),this.retryRequest(s,t,f)}let m=await d.text().catch(lt=>Be(lt).message),j=Ns(m),z=j?void 0:m;throw Y(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,d.status,i,f,z),this.makeStatusError(d.status,j,z,f)}return{response:d,options:s,controller:h}}requestAPIList(e,t){let s=this.makeRequest(t,null);return new bt(this,s,e)}buildURL(e,t){let s=$s(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return ge(n)||(t={...n,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s<"u").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new c(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,s,n){let{signal:o,...i}=t||{};o&&o.addEventListener("abort",()=>n.abort());let a=setTimeout(()=>n.abort(),s),h={signal:n.signal,...i};h.method&&(h.method=h.method.toUpperCase());let d=60*1e3,f=setTimeout(()=>{if(h&&h?.agent?.sockets)for(let m of Object.values(h?.agent?.sockets).flat())m?.setKeepAlive&&m.setKeepAlive(!0,d)},d);return this.fetch.call(void 0,e,h).finally(()=>{clearTimeout(a),clearTimeout(f)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s){let n,o=s?.["retry-after-ms"];if(o){let a=parseFloat(o);Number.isNaN(a)||(n=a)}let i=s?.["retry-after"];if(i&&!n){let a=parseFloat(i);Number.isNaN(a)?n=Date.parse(i)-Date.now():n=a*1e3}if(!(n&&0<=n&&n<60*1e3)){let a=e.maxRetries??this.maxRetries;n=this.calculateDefaultRetryTimeoutMillis(t,a)}return await Ls(n),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let o=t-e,i=Math.min(.5*Math.pow(2,o),8),a=1-Math.random()*.25;return i*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${U}`}},Le=class{constructor(e,t,s,n){Fe.set(this,void 0),As(this,Fe,e,"f"),this.options=n,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new c("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let s=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[n,o]of s)e.url.searchParams.set(n,o);t.query=void 0,t.path=e.url.toString()}return await Rs(this,Fe,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Fe=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},bt=class extends De{constructor(e,t,s){super(t,async n=>new s(e,n.response,await Wt(n),n.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},mt=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){let s=t.toString();return e[s.toLowerCase()]||e[s]}}),Ts={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},S=r=>typeof r=="object"&&r!==null&&!ge(r)&&Object.keys(r).every(e=>Kt(Ts,e)),Bs=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":jt(Deno.build.os),"X-Stainless-Arch":qt(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":jt(process.platform),"X-Stainless-Arch":qt(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let r=Is();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Is(){if(typeof navigator>"u"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let s=t.exec(navigator.userAgent);if(s){let n=s[1]||0,o=s[2]||0,i=s[3]||0;return{browser:e,version:`${n}.${o}.${i}`}}}return null}var qt=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",jt=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),Ut,Fs=()=>Ut??(Ut=Bs()),Ns=r=>{try{return JSON.parse(r)}catch{return}},Ds=/^[a-z][a-z0-9+.-]*:/i,$s=r=>Ds.test(r),Ls=r=>new Promise(e=>setTimeout(e,r)),wt=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new c(`${r} must be an integer`);if(e<0)throw new c(`${r} must be a positive integer`);return e},Be=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(String(r))};var Oe=r=>{if(typeof process<"u")return process.env?.[r]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(r)?.trim()};function ge(r){if(!r)return!0;for(let e in r)return!1;return!0}function Kt(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function Ht(r,e){for(let t in e){if(!Kt(e,t))continue;let s=t.toLowerCase();if(!s)continue;let n=e[t];n===null?delete r[s]:n!==void 0&&(r[s]=n)}}function Y(r,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`Anthropic:DEBUG:${r}`,...e)}var Os=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),Xt=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",qs=r=>typeof r?.get=="function";var Ne=(r,e)=>{let t=e.toLowerCase();if(qs(r)){let s=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(n,o,i)=>o+i.toUpperCase());for(let n of[e,t,e.toUpperCase(),s]){let o=r.get(n);if(o)return o}}for(let[s,n]of Object.entries(r))if(s.toLowerCase()===t)return Array.isArray(n)?(n.length<=1||console.warn(`Received ${n.length} entries for the ${e} header, using the first entry.`),n[0]):n};var A=class extends Le{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){if(this.options.query?.before_id){let t=this.first_id;return t?{params:{before_id:t}}:null}let e=this.last_id;return e?{params:{after_id:e}}:null}};var w=class{constructor(e){this._client=e}};var V=class extends w{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return S(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",Z,{query:e,...t})}},Z=class extends A{};V.BetaModelInfosPage=Z;var ee=class r{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new B;for await(let t of this.iterator)for(let s of e.decode(t))yield JSON.parse(s);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new c("Attempted to iterate over a response with no body");return new r(fe(e.body),t)}};var K=class extends w{create(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/batches?beta=true",{body:n,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}retrieve(e,t={},s){if(S(t))return this.retrieve(e,{},t);let{betas:n}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}list(e={},t){if(S(e))return this.list({},e);let{betas:s,...n}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",te,{query:n,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}delete(e,t={},s){if(S(t))return this.delete(e,{},t);let{betas:n}=t;return this._client.delete(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}cancel(e,t={},s){if(S(t))return this.cancel(e,{},t);let{betas:n}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}async results(e,t={},s){if(S(t))return this.results(e,{},t);let n=await this.retrieve(e);if(!n.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);let{betas:o}=t;return this._client.get(n.results_url,{...s,headers:{"anthropic-beta":[...o??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...s?.headers},__binaryResponse:!0})._thenUnwrap((i,a)=>ee.fromResponse(a.response,a.controller))}},te=class extends A{};K.BetaMessageBatchesPage=te;var Ws=r=>{let e=0,t=[];for(;e<r.length;){let s=r[e];if(s==="\\"){e++;continue}if(s==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(s==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(s==="["){t.push({type:"paren",value:"["}),e++;continue}if(s==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(s===":"){t.push({type:"separator",value:":"}),e++;continue}if(s===","){t.push({type:"delimiter",value:","}),e++;continue}if(s==='"'){let a="",h=!1;for(s=r[++e];s!=='"';){if(e===r.length){h=!0;break}if(s==="\\"){if(e++,e===r.length){h=!0;break}a+=s+r[e],s=r[++e]}else a+=s,s=r[++e]}s=r[++e],h||t.push({type:"string",value:a});continue}if(s&&/\s/.test(s)){e++;continue}let o=/[0-9]/;if(s&&o.test(s)||s==="-"||s==="."){let a="";for(s==="-"&&(a+=s,s=r[++e]);s&&o.test(s)||s===".";)a+=s,s=r[++e];t.push({type:"number",value:a});continue}let i=/[a-z]/i;if(s&&i.test(s)){let a="";for(;s&&i.test(s)&&e!==r.length;)a+=s,s=r[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},se=r=>{if(r.length===0)return r;let e=r[r.length-1];switch(e.type){case"separator":return r=r.slice(0,r.length-1),se(r);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return r=r.slice(0,r.length-1),se(r);case"string":let s=r[r.length-2];if(s?.type==="delimiter")return r=r.slice(0,r.length-1),se(r);if(s?.type==="brace"&&s.value==="{")return r=r.slice(0,r.length-1),se(r);break;case"delimiter":return r=r.slice(0,r.length-1),se(r);break}return r},Vs=r=>{let e=[];return r.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?r.push({type:"brace",value:"}"}):t==="]"&&r.push({type:"paren",value:"]"})}),r},Ks=r=>{let e="";return r.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},qe=r=>JSON.parse(Ks(Vs(se(Ws(r)))));var x=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},l=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},v,$,ye,je,we,be,Ue,xe,I,_e,He,We,ne,Ve,Ke,xt,Jt,_t,Et,St,vt,Gt,zt="__json_buf",Xe=class r{constructor(){v.add(this),this.messages=[],this.receivedMessages=[],$.set(this,void 0),this.controller=new AbortController,ye.set(this,void 0),je.set(this,()=>{}),we.set(this,()=>{}),be.set(this,void 0),Ue.set(this,()=>{}),xe.set(this,()=>{}),I.set(this,{}),_e.set(this,!1),He.set(this,!1),We.set(this,!1),ne.set(this,!1),Ve.set(this,void 0),Ke.set(this,void 0),_t.set(this,e=>{if(x(this,He,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new b),e instanceof b)return x(this,We,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),x(this,ye,new Promise((e,t)=>{x(this,je,e,"f"),x(this,we,t,"f")}),"f"),x(this,be,new Promise((e,t)=>{x(this,Ue,e,"f"),x(this,xe,t,"f")}),"f"),l(this,ye,"f").catch(()=>{}),l(this,be,"f").catch(()=>{})}get response(){return l(this,Ve,"f")}get request_id(){return l(this,Ke,"f")}async withResponse(){let e=await l(this,ye,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let o of t.messages)n._addMessageParam(o);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,_t,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),l(this,v,"m",Et).call(this);let{response:o,data:i}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(o);for await(let a of i)l(this,v,"m",St).call(this,a);if(i.controller.signal?.aborted)throw new b;l(this,v,"m",vt).call(this)}_connected(e){this.ended||(x(this,Ve,e,"f"),x(this,Ke,e?.headers.get("request-id"),"f"),l(this,je,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,_e,"f")}get errored(){return l(this,He,"f")}get aborted(){return l(this,We,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,I,"f")[e]||(l(this,I,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=l(this,I,"f")[e];if(!s)return this;let n=s.findIndex(o=>o.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(l(this,I,"f")[e]||(l(this,I,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{x(this,ne,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){x(this,ne,!0,"f"),await l(this,be,"f")}get currentMessage(){return l(this,$,"f")}async finalMessage(){return await this.done(),l(this,v,"m",xt).call(this)}async finalText(){return await this.done(),l(this,v,"m",Jt).call(this)}_emit(e,...t){if(l(this,_e,"f"))return;e==="end"&&(x(this,_e,!0,"f"),l(this,Ue,"f").call(this));let s=l(this,I,"f")[e];if(s&&(l(this,I,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!l(this,ne,"f")&&!s?.length&&Promise.reject(n),l(this,we,"f").call(this,n),l(this,xe,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!l(this,ne,"f")&&!s?.length&&Promise.reject(n),l(this,we,"f").call(this,n),l(this,xe,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,v,"m",xt).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,v,"m",Et).call(this),this._connected(null);let n=M.fromReadableStream(e,this.controller);for await(let o of n)l(this,v,"m",St).call(this,o);if(n.controller.signal?.aborted)throw new b;l(this,v,"m",vt).call(this)}[($=new WeakMap,ye=new WeakMap,je=new WeakMap,we=new WeakMap,be=new WeakMap,Ue=new WeakMap,xe=new WeakMap,I=new WeakMap,_e=new WeakMap,He=new WeakMap,We=new WeakMap,ne=new WeakMap,Ve=new WeakMap,Ke=new WeakMap,_t=new WeakMap,v=new WeakSet,xt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Jt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},Et=function(){this.ended||x(this,$,void 0,"f")},St=function(t){if(this.ended)return;let s=l(this,v,"m",Gt).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let n=s.content.at(-1);switch(t.delta.type){case"text_delta":{n.type==="text"&&this._emit("text",t.delta.text,n.text||"");break}case"citations_delta":{n.type==="text"&&this._emit("citation",t.delta.citation,n.citations??[]);break}case"input_json_delta":{n.type==="tool_use"&&n.input&&this._emit("inputJson",t.delta.partial_json,n.input);break}case"thinking_delta":{n.type==="thinking"&&this._emit("thinking",t.delta.thinking,n.thinking);break}case"signature_delta":{n.type==="thinking"&&this._emit("signature",n.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{x(this,$,s,"f");break}case"content_block_start":case"message_delta":break}},vt=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=l(this,$,"f");if(!t)throw new c("request ended without sending any chunks");return x(this,$,void 0,"f"),t},Gt=function(t){let s=l(this,$,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let n=s.content.at(t.index);switch(t.delta.type){case"text_delta":{n?.type==="text"&&(n.text+=t.delta.text);break}case"citations_delta":{n?.type==="text"&&(n.citations??(n.citations=[]),n.citations.push(t.delta.citation));break}case"input_json_delta":{if(n?.type==="tool_use"){let o=n[zt]||"";o+=t.delta.partial_json,Object.defineProperty(n,zt,{value:o,enumerable:!1,writable:!0}),o&&(n.input=qe(o))}break}case"thinking_delta":{n?.type==="thinking"&&(n.thinking+=t.delta.thinking);break}case"signature_delta":{n?.type==="thinking"&&(n.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let o=t.shift();o?o.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((o,i)=>t.push({resolve:o,reject:i})).then(o=>o?{value:o,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new M(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Qt={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"},L=class extends w{constructor(){super(...arguments),this.batches=new K(this._client)}create(e,t){let{betas:s,...n}=e;return n.model in Qt&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${Qt[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:n,timeout:this._client._options.timeout??(n.stream?6e5:this._client._calculateNonstreamingTimeout(n.max_tokens)),...t,headers:{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0,...t?.headers},stream:e.stream??!1})}stream(e,t){return Xe.createMessage(this,e,t)}countTokens(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:n,...t,headers:{"anthropic-beta":[...s??[],"token-counting-2024-11-01"].toString(),...t?.headers}})}};L.Batches=K;L.BetaMessageBatchesPage=te;var R=class extends w{constructor(){super(...arguments),this.models=new V(this._client),this.messages=new L(this._client)}};R.Models=V;R.BetaModelInfosPage=Z;R.Messages=L;var X=class extends w{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}};var J=class extends w{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return S(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",re,{query:e,...t})}delete(e,t){return this._client.delete(`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let s=await this.retrieve(e);if(!s.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})._thenUnwrap((n,o)=>ee.fromResponse(o.response,o.controller))}},re=class extends A{};J.MessageBatchesPage=re;var _=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},u=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},k,O,Ee,Je,Se,ve,Ge,ke,F,Pe,ze,Qe,oe,Ye,Ze,kt,Yt,Pt,Ct,Mt,At,Zt,es="__json_buf",et=class r{constructor(){k.add(this),this.messages=[],this.receivedMessages=[],O.set(this,void 0),this.controller=new AbortController,Ee.set(this,void 0),Je.set(this,()=>{}),Se.set(this,()=>{}),ve.set(this,void 0),Ge.set(this,()=>{}),ke.set(this,()=>{}),F.set(this,{}),Pe.set(this,!1),ze.set(this,!1),Qe.set(this,!1),oe.set(this,!1),Ye.set(this,void 0),Ze.set(this,void 0),Pt.set(this,e=>{if(_(this,ze,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new b),e instanceof b)return _(this,Qe,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),_(this,Ee,new Promise((e,t)=>{_(this,Je,e,"f"),_(this,Se,t,"f")}),"f"),_(this,ve,new Promise((e,t)=>{_(this,Ge,e,"f"),_(this,ke,t,"f")}),"f"),u(this,Ee,"f").catch(()=>{}),u(this,ve,"f").catch(()=>{})}get response(){return u(this,Ye,"f")}get request_id(){return u(this,Ze,"f")}async withResponse(){let e=await u(this,Ee,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let o of t.messages)n._addMessageParam(o);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},u(this,Pt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),u(this,k,"m",Ct).call(this);let{response:o,data:i}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(o);for await(let a of i)u(this,k,"m",Mt).call(this,a);if(i.controller.signal?.aborted)throw new b;u(this,k,"m",At).call(this)}_connected(e){this.ended||(_(this,Ye,e,"f"),_(this,Ze,e?.headers.get("request-id"),"f"),u(this,Je,"f").call(this,e),this._emit("connect"))}get ended(){return u(this,Pe,"f")}get errored(){return u(this,ze,"f")}get aborted(){return u(this,Qe,"f")}abort(){this.controller.abort()}on(e,t){return(u(this,F,"f")[e]||(u(this,F,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=u(this,F,"f")[e];if(!s)return this;let n=s.findIndex(o=>o.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(u(this,F,"f")[e]||(u(this,F,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{_(this,oe,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){_(this,oe,!0,"f"),await u(this,ve,"f")}get currentMessage(){return u(this,O,"f")}async finalMessage(){return await this.done(),u(this,k,"m",kt).call(this)}async finalText(){return await this.done(),u(this,k,"m",Yt).call(this)}_emit(e,...t){if(u(this,Pe,"f"))return;e==="end"&&(_(this,Pe,!0,"f"),u(this,Ge,"f").call(this));let s=u(this,F,"f")[e];if(s&&(u(this,F,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!u(this,oe,"f")&&!s?.length&&Promise.reject(n),u(this,Se,"f").call(this,n),u(this,ke,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!u(this,oe,"f")&&!s?.length&&Promise.reject(n),u(this,Se,"f").call(this,n),u(this,ke,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",u(this,k,"m",kt).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),u(this,k,"m",Ct).call(this),this._connected(null);let n=M.fromReadableStream(e,this.controller);for await(let o of n)u(this,k,"m",Mt).call(this,o);if(n.controller.signal?.aborted)throw new b;u(this,k,"m",At).call(this)}[(O=new WeakMap,Ee=new WeakMap,Je=new WeakMap,Se=new WeakMap,ve=new WeakMap,Ge=new WeakMap,ke=new WeakMap,F=new WeakMap,Pe=new WeakMap,ze=new WeakMap,Qe=new WeakMap,oe=new WeakMap,Ye=new WeakMap,Ze=new WeakMap,Pt=new WeakMap,k=new WeakSet,kt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Yt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},Ct=function(){this.ended||_(this,O,void 0,"f")},Mt=function(t){if(this.ended)return;let s=u(this,k,"m",Zt).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let n=s.content.at(-1);switch(t.delta.type){case"text_delta":{n.type==="text"&&this._emit("text",t.delta.text,n.text||"");break}case"citations_delta":{n.type==="text"&&this._emit("citation",t.delta.citation,n.citations??[]);break}case"input_json_delta":{n.type==="tool_use"&&n.input&&this._emit("inputJson",t.delta.partial_json,n.input);break}case"thinking_delta":{n.type==="thinking"&&this._emit("thinking",t.delta.thinking,n.thinking);break}case"signature_delta":{n.type==="thinking"&&this._emit("signature",n.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{_(this,O,s,"f");break}case"content_block_start":case"message_delta":break}},At=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=u(this,O,"f");if(!t)throw new c("request ended without sending any chunks");return _(this,O,void 0,"f"),t},Zt=function(t){let s=u(this,O,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let n=s.content.at(t.index);switch(t.delta.type){case"text_delta":{n?.type==="text"&&(n.text+=t.delta.text);break}case"citations_delta":{n?.type==="text"&&(n.citations??(n.citations=[]),n.citations.push(t.delta.citation));break}case"input_json_delta":{if(n?.type==="tool_use"){let o=n[es]||"";o+=t.delta.partial_json,Object.defineProperty(n,es,{value:o,enumerable:!1,writable:!0}),o&&(n.input=qe(o))}break}case"thinking_delta":{n?.type==="thinking"&&(n.thinking+=t.delta.thinking);break}case"signature_delta":{n?.type==="thinking"&&(n.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let o=t.shift();o?o.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((o,i)=>t.push({resolve:o,reject:i})).then(o=>o?{value:o,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new M(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var N=class extends w{constructor(){super(...arguments),this.batches=new J(this._client)}create(e,t){return e.model in ts&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${ts[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??(e.stream?6e5:this._client._calculateNonstreamingTimeout(e.max_tokens)),...t,stream:e.stream??!1})}stream(e,t){return et.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},ts={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};N.Batches=J;N.MessageBatchesPage=re;var q=class extends w{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return S(e)?this.list({},e):this._client.getAPIList("/v1/models",G,{query:e,...t})}},G=class extends A{};q.ModelInfosPage=G;var ss,p=class extends $e{constructor({baseURL:e=Oe("ANTHROPIC_BASE_URL"),apiKey:t=Oe("ANTHROPIC_API_KEY")??null,authToken:s=Oe("ANTHROPIC_AUTH_TOKEN")??null,...n}={}){let o={apiKey:t,authToken:s,...n,baseURL:e||"https://api.anthropic.com"};if(!o.dangerouslyAllowBrowser&&Xt())throw new c(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new X(this),this.messages=new N(this),this.models=new q(this),this.beta=new R(this),this._options=o,this.apiKey=t,this.authToken=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){let t=this.apiKeyAuth(e),s=this.bearerAuth(e);return t!=null&&!ge(t)?t:s!=null&&!ge(s)?s:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}};ss=p;p.Anthropic=ss;p.HUMAN_PROMPT=`

Human:`;p.AI_PROMPT=`

Assistant:`;p.DEFAULT_TIMEOUT=6e5;p.AnthropicError=c;p.APIError=y;p.APIConnectionError=D;p.APIConnectionTimeoutError=Q;p.APIUserAbortError=b;p.NotFoundError=le;p.ConflictError=ue;p.RateLimitError=he;p.BadRequestError=ie;p.AuthenticationError=ae;p.InternalServerError=pe;p.PermissionDeniedError=ce;p.UnprocessableEntityError=de;p.toFile=Ot;p.fileFromPath=Re;p.Completions=X;p.Messages=N;p.Models=q;p.ModelInfosPage=G;p.Beta=R;var{HUMAN_PROMPT:Tr,AI_PROMPT:Br}=p,ns=p;var tt=class{client=null;settings;constructor(e){this.settings=e,this.initClient()}initClient(){this.settings.apiKey&&(this.client=new ns({apiKey:this.settings.apiKey,dangerouslyAllowBrowser:!0}))}updateSettings(e){this.settings=e,this.initClient()}isConfigured(){return!!this.client&&!!this.settings.apiKey}async sendMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let n=e.map(a=>({role:a.role,content:a.content}));if(this.settings.streamResponses&&s)return this.streamMessage(n,t,s);let i=(await this.client.messages.create({model:this.settings.model,max_tokens:4096,system:t,messages:n})).content.find(a=>a.type==="text");return i?.type==="text"?i.text:""}async streamMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let n="",o=this.client.messages.stream({model:this.settings.model,max_tokens:4096,system:t,messages:e});for await(let i of o)if(i.type==="content_block_delta"&&i.delta.type==="text_delta"){let a=i.delta.text;n+=a,s(a)}return n}};var st=class{settings;preferences=[];constructor(e){this.settings=e}updateSettings(e){this.settings=e}async loadPreferences(){return this.preferences=[{id:"cotton-react",name:"Cotton React Conventions",priority:100,tags:["react","typescript"],content:`## React Conventions

- Use named exports, not default exports
- Use function declarations with forwardRef
- Add displayName for debugging
- Use semantic tokens, never primitives

## Example

\`\`\`tsx
export const CottonButton = forwardRef<HTMLButtonElement, Props>(
  function CottonButton(props, ref) {
    return <button ref={ref} {...props} />;
  }
);
CottonButton.displayName = 'CottonButton';
\`\`\``},{id:"cotton-tokens",name:"Cotton Design Tokens",priority:100,tags:["css","tokens"],content:"## Design Tokens\n\nAlways use semantic tokens:\n- `--cotton-color-text-primary` (not `--cotton-color-gray-900`)\n- `--cotton-color-action-primary` (not `--cotton-color-blue-500`)\n- `--cotton-spacing-4` (not `16px`)\n\n## BEM Naming\n\n```css\n.cotton-btn { }           /* Block */\n.cotton-btn--primary { }  /* Modifier */\n.cotton-btn__icon { }     /* Element */\n```"}],this.preferences}formatForSystemPrompt(){return this.preferences.length===0?"":`## Cotton AI Preferences

The following coding standards and conventions should be followed:

${this.preferences.sort((t,s)=>s.priority-t.priority).map(t=>`### ${t.name}

${t.content}`).join(`

---

`)}`}};var nt=class{app;settings;constructor(e,t){this.app=e,this.settings=t}updateSettings(e){this.settings=e}async buildContext(e,t){if(!e)return null;let s=await this.app.vault.read(e),n=this.app.metadataCache.getFileCache(e)?.frontmatter,o={path:e.path,name:e.basename,content:this.truncateContent(s),frontmatter:n,selection:t};return this.settings.includeBacklinks&&(o.backlinks=this.getBacklinks(e)),o}truncateContent(e){let t=e.split(`
`);return t.length<=this.settings.contextLines?e:t.slice(0,this.settings.contextLines).join(`
`)+`

[...truncated]`}getBacklinks(e){let t=[],s=this.app.metadataCache.resolvedLinks;for(let[n,o]of Object.entries(s))o[e.path]&&t.push(n);return t.slice(0,10)}formatContextForPrompt(e){let t=`## Current Note: ${e.name}

`;return e.frontmatter&&(t+=`### Frontmatter
\`\`\`yaml
${JSON.stringify(e.frontmatter,null,2)}
\`\`\`

`),e.selection&&(t+=`### Selected Text
\`\`\`
${e.selection}
\`\`\`

`),t+=`### Content
\`\`\`markdown
${e.content}
\`\`\`
`,e.backlinks&&e.backlinks.length>0&&(t+=`
### Backlinks
${e.backlinks.map(s=>`- [[${s}]]`).join(`
`)}
`),t}};var T=require("obsidian"),rt=class extends T.Modal{plugin;editor;context;inputEl=null;responseEl=null;constructor(e,t,s,n){super(e),this.plugin=t,this.editor=s,this.context=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-ask-claude-modal"),e.createEl("h2",{text:"Ask Claude"}),this.context&&e.createEl("p",{text:`Context: ${this.context.name}`,cls:"cotton-context-label"});let t=e.createDiv({cls:"cotton-input-container"});if(this.inputEl=new T.TextAreaComponent(t),this.inputEl.inputEl.addClass("cotton-input"),this.inputEl.setPlaceholder("Ask a question about this note..."),this.inputEl.inputEl.rows=3,this.context?.selection){let i=e.createDiv({cls:"cotton-selection-preview"});i.createEl("strong",{text:"Selected: "}),i.createEl("code",{text:this.context.selection.length>100?this.context.selection.slice(0,100)+"...":this.context.selection})}let s=e.createDiv({cls:"cotton-button-container"});s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),s.createEl("button",{text:"Ask",cls:"mod-cta"}).addEventListener("click",()=>this.handleAsk()),this.responseEl=e.createDiv({cls:"cotton-response"}),this.responseEl.style.display="none",this.inputEl.inputEl.focus(),this.inputEl.inputEl.addEventListener("keydown",i=>{i.key==="Enter"&&(i.metaKey||i.ctrlKey)&&this.handleAsk()})}async handleAsk(){let e=this.inputEl?.getValue();if(!e?.trim()){new T.Notice("Please enter a question");return}if(!this.plugin.claude.isConfigured()){new T.Notice("Claude API key not configured. Check settings.");return}this.responseEl&&(this.responseEl.style.display="block",this.responseEl.empty(),this.responseEl.createEl("p",{text:"Thinking...",cls:"cotton-thinking"}));try{let t=this.plugin.preferences.formatForSystemPrompt(),s=this.context?this.plugin.contextBuilder.formatContextForPrompt(this.context):"",n=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${t}

${s}

Respond concisely and helpfully. Use markdown formatting.`,o=[{role:"user",content:e,timestamp:Date.now()}],i="";if(this.responseEl&&this.responseEl.empty(),i=await this.plugin.claude.sendMessage(o,n,a=>{this.responseEl&&(this.responseEl.textContent=(this.responseEl.textContent||"")+a)}),this.responseEl&&i){this.responseEl.empty();let a=this.responseEl.createDiv({cls:"cotton-response-content"});a.innerHTML=i}}catch(t){new T.Notice(`Error: ${t instanceof Error?t.message:"Unknown error"}`),this.responseEl&&(this.responseEl.empty(),this.responseEl.createEl("p",{text:`Error: ${t instanceof Error?t.message:"Unknown error"}`,cls:"cotton-error"}))}}onClose(){let{contentEl:e}=this;e.empty()}};function rs(r){r.addCommand({id:"ask-claude",name:"Ask Claude",editorCallback:async(e,t)=>{let s=e.getSelection(),n=t.file,o=n?await r.contextBuilder.buildContext(n,s||void 0):null;new rt(r.app,r,e,o).open()}}),r.addCommand({id:"ask-claude-general",name:"Ask Claude (General)",callback:async()=>{let t=r.app.workspace.getActiveViewOfType(T.MarkdownView)?.file||null,s=t?await r.contextBuilder.buildContext(t):null;new rt(r.app,r,null,s).open()}})}var P=require("obsidian");var g=require("obsidian"),ot=class extends g.Modal{plugin;message;constructor(e,t,s){super(e),this.plugin=t,this.message=s}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Save Response"});let t=e.createDiv({cls:"cotton-save-options"}),s=[{id:"quick-save",label:"Quick Save",description:`Save to ${this.plugin.settings.chatFolder}/Responses`,icon:"zap",action:()=>this.quickSave()},{id:"current-note",label:"Append to Current Note",description:"Add response to the active note",icon:"file-plus",action:()=>this.appendToCurrentNote()},{id:"new-note",label:"Create New Note",description:"Save as a new note with custom name",icon:"file-text",action:()=>this.createNewNote()},{id:"browse",label:"Browse...",description:"Choose a specific folder",icon:"folder",action:()=>this.browseForFolder()}];for(let n of s){let o=t.createDiv({cls:"cotton-save-option"});o.addEventListener("click",async()=>{await n.action()});let i=o.createDiv({cls:"cotton-save-option-icon"});(0,g.setIcon)(i,n.icon);let a=o.createDiv({cls:"cotton-save-option-text"});a.createDiv({cls:"cotton-save-option-label",text:n.label}),a.createDiv({cls:"cotton-save-option-desc",text:n.description})}}formatResponseContent(){let e=new Date,t=e.toISOString(),s=e.toLocaleString();return`---
source: cotton-ai
saved: ${t}
model: ${this.getModelName()}
---

${this.message.content}

---
*Saved from Cotton AI on ${s}*
`}getModelName(){let e=this.plugin.settings.model;return e.includes("sonnet")?"Sonnet 4":e.includes("opus")?"Opus 4":e.includes("haiku")?"Haiku 3.5":"Claude"}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}generateFilename(){let e=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),t=this.message.content.slice(0,30).replace(/[^a-zA-Z0-9 ]/g,"").trim().replace(/\s+/g,"-")||"response";return`${e}-${t}`}async quickSave(){try{let e=this.plugin.settings.chatFolder||"Cotton/Chats",t=`${e}/Responses`;await this.ensureFolderExists(e),await this.ensureFolderExists(t);let s=`${t}/${this.generateFilename()}.md`,n=this.formatResponseContent();await this.app.vault.create(s,n),new g.Notice(`Saved to ${s}`),this.close()}catch(e){new g.Notice(`Failed to save: ${e instanceof Error?e.message:"Unknown error"}`)}}async appendToCurrentNote(){try{let e=this.app.workspace.getActiveFile();if(!e){new g.Notice("No active note to append to");return}let t=await this.app.vault.read(e),s=`

---

## AI Response

${this.message.content}

*Added from Cotton AI on ${new Date().toLocaleString()}*
`;await this.app.vault.modify(e,t+s),new g.Notice(`Appended to ${e.basename}`),this.close()}catch(e){new g.Notice(`Failed to append: ${e instanceof Error?e.message:"Unknown error"}`)}}async createNewNote(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Create New Note"});let t=e.createDiv({cls:"cotton-save-input-container"});t.createEl("label",{text:"Note name:",cls:"cotton-save-label"});let s=t.createEl("input",{type:"text",cls:"cotton-save-input",value:this.generateFilename()});t.createEl("label",{text:"Folder:",cls:"cotton-save-label"});let n=t.createEl("input",{type:"text",cls:"cotton-save-input",value:this.plugin.settings.chatFolder||"Cotton/Chats"}),o=e.createDiv({cls:"cotton-save-buttons"});o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),o.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",async()=>{let h=s.value.trim(),d=n.value.trim();if(!h){new g.Notice("Please enter a note name");return}try{await this.ensureFolderExists(d);let f=`${d}/${h}.md`,m=this.formatResponseContent();await this.app.vault.create(f,m),new g.Notice(`Created ${f}`),this.close()}catch(f){new g.Notice(`Failed to create: ${f instanceof Error?f.message:"Unknown error"}`)}}),s.focus(),s.select()}async browseForFolder(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Select Folder"});let t=e.createDiv({cls:"cotton-folder-list"}),s=this.getAllFolders(),n=t.createDiv({cls:"cotton-folder-option"});(0,g.setIcon)(n.createSpan(),"home"),n.createSpan({text:" / (root)"}),n.addEventListener("click",()=>this.saveToFolder(""));for(let i of s){let a=t.createDiv({cls:"cotton-folder-option"});(0,g.setIcon)(a.createSpan(),"folder"),a.createSpan({text:` ${i.path}`}),a.addEventListener("click",()=>this.saveToFolder(i.path))}e.createEl("button",{text:"Cancel",cls:"cotton-cancel-btn"}).addEventListener("click",()=>this.close())}getAllFolders(){let e=[],t=this.app.vault.getRoot(),s=n=>{for(let o of n.children)o instanceof g.TFolder&&(e.push(o),s(o))};return s(t),e.sort((n,o)=>n.path.localeCompare(o.path))}async saveToFolder(e){try{let t=e?`${e}/${this.generateFilename()}.md`:`${this.generateFilename()}.md`,s=this.formatResponseContent();await this.app.vault.create(t,s),new g.Notice(`Saved to ${t}`),this.close()}catch(t){new g.Notice(`Failed to save: ${t instanceof Error?t.message:"Unknown error"}`)}}onClose(){let{contentEl:e}=this;e.empty()}};var Ce="cotton-chat-view",it=class extends P.ItemView{plugin;messages=[];inputEl=null;messagesEl=null;isLoading=!1;constructor(e,t){super(e),this.plugin=t}getViewType(){return Ce}getDisplayText(){return"Cotton AI"}getIcon(){return"circle"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("cotton-chat-container");let t=e.createDiv({cls:"cotton-chat-header"});t.createEl("h4",{text:"Cotton AI"});let s=t.createEl("span",{text:this.getModelName(),cls:"cotton-model-badge"});t.createEl("button",{text:"Clear",cls:"cotton-clear-btn"}).addEventListener("click",()=>this.clearChat()),this.messagesEl=e.createDiv({cls:"cotton-chat-messages"});let o=e.createDiv({cls:"cotton-chat-input-container"});this.inputEl=o.createEl("textarea",{cls:"cotton-chat-input",attr:{placeholder:"Ask Claude...",rows:"3"}}),this.inputEl.addEventListener("keydown",d=>{d.key==="Enter"&&(d.metaKey||d.ctrlKey)&&(d.preventDefault(),this.sendMessage())});let i=o.createDiv({cls:"cotton-chat-buttons"});i.createEl("button",{text:"Add Context",cls:"cotton-context-btn"}).addEventListener("click",()=>this.addCurrentNoteContext()),i.createEl("button",{text:"Send",cls:"mod-cta cotton-send-btn"}).addEventListener("click",()=>this.sendMessage()),await this.loadMessages()}async onClose(){await this.saveMessages()}getModelName(){let e=this.plugin.settings.model;return e.includes("sonnet")?"Sonnet 4":e.includes("opus")?"Opus 4":e.includes("haiku")?"Haiku 3.5":"Claude"}async sendMessage(){if(!this.inputEl||this.isLoading)return;let e=this.inputEl.value.trim();if(!e)return;if(!this.plugin.claude.isConfigured()){this.addSystemMessage("API key not configured. Check settings.");return}let t={role:"user",content:e,timestamp:Date.now()};this.messages.push(t),this.renderMessage(t),this.inputEl.value="",this.isLoading=!0;let s=this.addThinkingIndicator();try{let n=this.app.workspace.getActiveFile(),o=n?await this.plugin.contextBuilder.buildContext(n):null,i=this.plugin.preferences.formatForSystemPrompt(),a=o?this.plugin.contextBuilder.formatContextForPrompt(o):"",h=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${i}

${a}

Respond concisely and helpfully. Use markdown formatting.`,d="",f=this.messagesEl?.createDiv({cls:"cotton-message cotton-message-assistant"});if(s&&s.remove(),await this.plugin.claude.sendMessage(this.messages.filter(m=>m.role!=="system"),h,m=>{d+=m,f&&(f.textContent=d)}),f&&d){f.empty();let m=f.createDiv({cls:"cotton-message-actions"}),j=m.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Copy to clipboard"}});(0,P.setIcon)(j,"copy");let z=m.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Save to note"}});(0,P.setIcon)(z,"save");let Tt=f.createDiv({cls:"cotton-message-content"});await P.MarkdownRenderer.render(this.app,d,Tt,"",this.plugin);let ct={role:"assistant",content:d,timestamp:Date.now()};this.messages.push(ct),j.addEventListener("click",()=>this.copyToClipboard(d)),z.addEventListener("click",()=>this.openSaveModal(ct))}else{let m={role:"assistant",content:d,timestamp:Date.now()};this.messages.push(m)}await this.saveToNote()}catch(n){s&&s.remove(),this.addSystemMessage(`Error: ${n instanceof Error?n.message:"Unknown error"}`)}finally{this.isLoading=!1}}renderMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:`cotton-message cotton-message-${e.role}`});if(e.role==="user")t.textContent=e.content;else{let s=t.createDiv({cls:"cotton-message-actions"}),n=s.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Copy to clipboard"}});(0,P.setIcon)(n,"copy"),n.addEventListener("click",()=>this.copyToClipboard(e.content));let o=s.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Save to note"}});(0,P.setIcon)(o,"save"),o.addEventListener("click",()=>this.openSaveModal(e));let i=t.createDiv({cls:"cotton-message-content"});P.MarkdownRenderer.render(this.app,e.content,i,"",this.plugin)}this.messagesEl.scrollTop=this.messagesEl.scrollHeight}async copyToClipboard(e){await navigator.clipboard.writeText(e),new P.Notice("Copied to clipboard")}openSaveModal(e){new ot(this.app,this.plugin,e).open()}addThinkingIndicator(){if(!this.messagesEl)return null;let e=this.messagesEl.createDiv({cls:"cotton-thinking"});return e.textContent="Thinking...",this.messagesEl.scrollTop=this.messagesEl.scrollHeight,e}addSystemMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:"cotton-message cotton-message-system"});t.textContent=e}async addCurrentNoteContext(){let e=this.app.workspace.getActiveFile();if(!e){this.addSystemMessage("No active note to add as context.");return}if(this.inputEl){let t=this.inputEl.value;this.inputEl.value=t+(t?`

`:"")+`[Context: ${e.basename}]`,this.inputEl.focus()}}clearChat(){this.messages=[],this.messagesEl&&this.messagesEl.empty()}async loadMessages(){let e=await this.plugin.loadData();e?.chatHistory&&(this.messages=e.chatHistory,this.messages.forEach(t=>this.renderMessage(t)))}async saveMessages(){let e=await this.plugin.loadData()||{};e.chatHistory=this.messages,await this.plugin.saveData(e)}async saveToNote(){if(this.messages.length===0)return;let e=this.plugin.settings.chatFolder||"Cotton/Chats",t=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),s=this.messages.find(a=>a.role==="user"),n=s?s.content.slice(0,30).replace(/[^a-zA-Z0-9 ]/g,"").trim():"chat",o=`${e}/${t}-${n}.md`,i=`# Cotton AI Chat

`;i+=`Date: ${new Date().toLocaleString()}
`,i+=`Model: ${this.getModelName()}

---

`;for(let a of this.messages)a.role==="user"?i+=`## Question

${a.content}

`:a.role==="assistant"&&(i+=`## Answer

${a.content}

---

`);try{let a=e;this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a);let h=this.app.vault.getAbstractFileByPath(o);h?await this.app.vault.modify(h,i):await this.app.vault.create(o,i)}catch(a){console.error("Failed to save chat to note:",a)}}};var Rt={apiKey:"",model:"claude-sonnet-4-20250514",personalPrefsPath:"",teamPrefsPath:"",streamResponses:!0,contextLines:100,includeBacklinks:!0,chatFolder:"Cotton/Chats"};var at=class extends os.Plugin{settings=Rt;claude;preferences;contextBuilder;async onload(){console.log("Loading Cotton AI plugin"),await this.loadSettings(),this.claude=new tt(this.settings),this.preferences=new st(this.settings),this.contextBuilder=new nt(this.app,this.settings),await this.preferences.loadPreferences(),this.addSettingTab(new Me(this.app,this)),this.registerView(Ce,e=>new it(e,this)),rs(this),this.addCommand({id:"toggle-chat-panel",name:"Toggle Chat Panel",callback:()=>this.toggleChatPanel()}),this.addRibbonIcon("circle","Cotton AI",()=>{this.toggleChatPanel()}),console.log("Cotton AI plugin loaded")}async toggleChatPanel(){let e=this.app.workspace.getLeavesOfType(Ce);if(e.length>0){let t=e[0];t.view.containerEl.isShown()?t.detach():this.app.workspace.revealLeaf(t)}else{let t=this.app.workspace.getLeftLeaf(!1);t&&(await t.setViewState({type:Ce,active:!0}),this.app.workspace.revealLeaf(t))}}onunload(){console.log("Unloading Cotton AI plugin")}async loadSettings(){this.settings=Object.assign({},Rt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.claude.updateSettings(this.settings),this.preferences.updateSettings(this.settings),this.contextBuilder.updateSettings(this.settings)}};
