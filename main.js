"use strict";var dt=Object.defineProperty;var cs=Object.getOwnPropertyDescriptor;var ls=Object.getOwnPropertyNames;var us=Object.prototype.hasOwnProperty;var ds=(r,e)=>{for(var t in e)dt(r,t,{get:e[t],enumerable:!0})},hs=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ls(e))!us.call(r,n)&&n!==t&&dt(r,n,{get:()=>e[n],enumerable:!(s=cs(e,n))||s.enumerable});return r};var ps=r=>hs(dt({},"__esModule",{value:!0}),r);var Zs={};ds(Zs,{default:()=>lt});module.exports=ps(Zs);var as=require("obsidian");var C=require("obsidian"),Ae=class extends C.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Cotton AI Settings"});let s=new C.Setting(e).setName("Claude API Key").addText(n=>n.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,await this.plugin.saveSettings()})).descEl.createDiv();s.appendText("Your Anthropic API key. "),s.createEl("a",{text:"Get your API key",href:"https://console.anthropic.com/settings/keys"}),new C.Setting(e).setName("Model").setDesc("Claude model to use for responses").addDropdown(n=>n.addOption("claude-sonnet-4-20250514","Claude Sonnet 4 (Recommended)").addOption("claude-opus-4-20250514","Claude Opus 4 (Most capable)").addOption("claude-3-5-haiku-20241022","Claude 3.5 Haiku (Fastest)").setValue(this.plugin.settings.model).onChange(async i=>{this.plugin.settings.model=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Preferences"}),new C.Setting(e).setName("Personal Preferences Path").setDesc("Path to your personal Cotton preferences (e.g., ~/.cotton/preferences)").addText(n=>n.setPlaceholder("~/.cotton/preferences").setValue(this.plugin.settings.personalPrefsPath).onChange(async i=>{this.plugin.settings.personalPrefsPath=i,await this.plugin.saveSettings()})),new C.Setting(e).setName("Team Preferences Path").setDesc("Path to team Cotton preferences (e.g., .cotton/preferences)").addText(n=>n.setPlaceholder(".cotton/preferences").setValue(this.plugin.settings.teamPrefsPath).onChange(async i=>{this.plugin.settings.teamPrefsPath=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Behavior"}),new C.Setting(e).setName("Stream Responses").setDesc("Show responses as they are generated").addToggle(n=>n.setValue(this.plugin.settings.streamResponses).onChange(async i=>{this.plugin.settings.streamResponses=i,await this.plugin.saveSettings()})),new C.Setting(e).setName("Context Lines").setDesc("Number of lines from current note to include as context").addSlider(n=>n.setLimits(0,500,10).setValue(this.plugin.settings.contextLines).setDynamicTooltip().onChange(async i=>{this.plugin.settings.contextLines=i,await this.plugin.saveSettings()})),new C.Setting(e).setName("Include Backlinks").setDesc("Include backlink information in context").addToggle(n=>n.setValue(this.plugin.settings.includeBacklinks).onChange(async i=>{this.plugin.settings.includeBacklinks=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Storage"}),new C.Setting(e).setName("Chat Folder").setDesc("Folder to save chat conversations and responses").addText(n=>n.setPlaceholder("Cotton/Chats").setValue(this.plugin.settings.chatFolder).onChange(async i=>{this.plugin.settings.chatFolder=i,await this.plugin.saveSettings()}))}};var U="0.39.0";var It=!1,H,ht,fs,ms,gs,Ft,ys,Re,pt,Dt,ft,Te,Nt;function $t(r,e={auto:!1}){if(It)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${r.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(H)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${r.kind}'\` after \`import '@anthropic-ai/sdk/shims/${H}'\``);It=e.auto,H=r.kind,ht=r.fetch,fs=r.Request,ms=r.Response,gs=r.Headers,Ft=r.FormData,ys=r.Blob,Re=r.File,pt=r.ReadableStream,Dt=r.getMultipartRequestOptions,ft=r.getDefaultAgent,Te=r.fileFromPath,Nt=r.isFsReadStream}var Be=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Lt({manuallyImported:r}={}){let e=r?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n",t,s,n,i;try{t=fetch,s=Request,n=Response,i=Headers}catch(o){throw new Error(`this environment is missing the following Web Fetch API type: ${o.message}. ${e}`)}return{kind:"web",fetch:t,Request:s,Response:n,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(o,a)=>({...a,body:new Be(o)}),getDefaultAgent:o=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:o=>!1}}H||$t(Lt(),{auto:!0});var c=class extends Error{},g=class r extends c{constructor(e,t,s,n){super(`${r.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.request_id=n?.["request-id"],this.error=t}static makeMessage(e,t,s){let n=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new N({message:s,cause:Ie(t)});let i=t;return e===400?new ae(e,i,s,n):e===401?new ce(e,i,s,n):e===403?new le(e,i,s,n):e===404?new ue(e,i,s,n):e===409?new de(e,i,s,n):e===422?new he(e,i,s,n):e===429?new pe(e,i,s,n):e>=500?new fe(e,i,s,n):new r(e,i,s,n)}},b=class extends g{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},N=class extends g{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},Y=class extends N{constructor({message:e}={}){super({message:e??"Request timed out."})}},ae=class extends g{},ce=class extends g{},le=class extends g{},ue=class extends g{},de=class extends g{},he=class extends g{},pe=class extends g{},fe=class extends g{};var Fe=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},W=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},E,B=class{constructor(){E.set(this,void 0),this.buffer=new Uint8Array,Fe(this,E,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,s=new Uint8Array(this.buffer.length+t.length);s.set(this.buffer),s.set(t,this.buffer.length),this.buffer=s;let n=[],i;for(;(i=xs(this.buffer,W(this,E,"f")))!=null;){if(i.carriage&&W(this,E,"f")==null){Fe(this,E,i.index,"f");continue}if(W(this,E,"f")!=null&&(i.index!==W(this,E,"f")+1||i.carriage)){n.push(this.decodeText(this.buffer.slice(0,W(this,E,"f")-1))),this.buffer=this.buffer.slice(W(this,E,"f")),Fe(this,E,null,"f");continue}let o=W(this,E,"f")!==null?i.preceding-1:i.preceding,a=this.decodeText(this.buffer.slice(0,o));n.push(a),this.buffer=this.buffer.slice(i.index),Fe(this,E,null,"f")}return n}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new c(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new c(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new c("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};E=new WeakMap;B.NEWLINE_CHARS=new Set([`
`,"\r"]);B.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function xs(r,e){for(let n=e??0;n<r.length;n++){if(r[n]===10)return{preceding:n,index:n+1,carriage:!1};if(r[n]===13)return{preceding:n,index:n+1,carriage:!0}}return null}function Ot(r){for(let s=0;s<r.length-1;s++){if(r[s]===10&&r[s+1]===10||r[s]===13&&r[s+1]===13)return s+2;if(r[s]===13&&r[s+1]===10&&s+3<r.length&&r[s+2]===13&&r[s+3]===10)return s+4}return-1}function me(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var M=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;async function*n(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let i=!1;try{for await(let o of _s(e,t)){if(o.event==="completion")try{yield JSON.parse(o.data)}catch(a){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),a}if(o.event==="message_start"||o.event==="message_delta"||o.event==="message_stop"||o.event==="content_block_start"||o.event==="content_block_delta"||o.event==="content_block_stop")try{yield JSON.parse(o.data)}catch(a){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),a}if(o.event!=="ping"&&o.event==="error")throw g.generate(void 0,`SSE Error: ${o.data}`,o.data,gt(e.headers))}i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new r(n,t)}static fromReadableStream(e,t){let s=!1;async function*n(){let o=new B,a=me(e);for await(let h of a)for(let d of o.decode(h))yield d;for(let h of o.flush())yield h}async function*i(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let a of n())o||a&&(yield JSON.parse(a));o=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{o||t.abort()}}return new r(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],s=this.iterator(),n=i=>({next:()=>{if(i.length===0){let o=s.next();e.push(o),t.push(o)}return i.shift()}});return[new r(()=>n(e),this.controller),new r(()=>n(t),this.controller)]}toReadableStream(){let e=this,t,s=new TextEncoder;return new pt({async start(){t=e[Symbol.asyncIterator]()},async pull(n){try{let{value:i,done:o}=await t.next();if(o)return n.close();let a=s.encode(JSON.stringify(i)+`
`);n.enqueue(a)}catch(i){n.error(i)}},async cancel(){await t.return?.()}})}};async function*_s(r,e){if(!r.body)throw e.abort(),new c("Attempted to iterate over a response with no body");let t=new mt,s=new B,n=me(r.body);for await(let i of Es(n))for(let o of s.decode(i)){let a=t.decode(o);a&&(yield a)}for(let i of s.flush()){let o=t.decode(i);o&&(yield o)}}async function*Es(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,n=new Uint8Array(e.length+s.length);n.set(e),n.set(s,e.length),e=n;let i;for(;(i=Ot(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var mt=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=vs(e,":");return n.startsWith(" ")&&(n=n.substring(1)),t==="event"?this.event=n:t==="data"&&this.data.push(n),null}};function vs(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}var Ss=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",ks=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&ge(r),ge=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function";async function qt(r,e,t){if(r=await r,ks(r))return r;if(Ss(r)){let n=await r.blob();e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file");let i=ge(n)?[await n.arrayBuffer()]:[n];return new Re(i,e,t)}let s=await Ps(r);if(e||(e=Ms(r)??"unknown_file"),!t?.type){let n=s[0]?.type;typeof n=="string"&&(t={...t,type:n})}return new Re(s,e,t)}async function Ps(r){let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(ge(r))e.push(await r.arrayBuffer());else if(As(r))for await(let t of r)e.push(t);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${r?.constructor?.name}; props: ${Cs(r)}`);return e}function Cs(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function Ms(r){return yt(r.name)||yt(r.filename)||yt(r.path)?.split(/[\\/]/).pop()}var yt=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},As=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",wt=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody";var Ts=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},Bs=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},De;async function Vt(r){let{response:e}=r;if(r.options.stream)return Z("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):M.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let i=await e.json();return Z("response",e.status,e.url,e.headers,i),Kt(i,e)}let n=await e.text();return Z("response",e.status,e.url,e.headers,n),n}function Kt(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var $e=class r extends Promise{constructor(e,t=Vt){super(s=>{s(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new r(this.responsePromise,async t=>Kt(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Le=class{constructor({baseURL:e,maxRetries:t=2,timeout:s=6e5,httpAgent:n,fetch:i}){this.baseURL=e,this.maxRetries=bt("maxRetries",t),this.timeout=bt("timeout",s),this.httpAgent=n,this.fetch=i??ht}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Ns(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${js()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(async n=>{let i=n&&ge(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:i}}))}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){e={...e};let{method:s,path:n,query:i,headers:o={}}=e,a=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:wt(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,h=this.calculateContentLength(a),d=this.buildURL(n,i);"timeout"in e&&bt("timeout",e.timeout),e.timeout=e.timeout??this.timeout;let f=e.httpAgent??this.httpAgent??ft(d),w=e.timeout+1e3;typeof f?.options?.timeout=="number"&&w>(f.options.timeout??0)&&(f.options.timeout=w),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);let j=this.buildHeaders({options:e,headers:o,contentLength:h,retryCount:t});return{req:{method:s,...a&&{body:a},headers:j,...f&&{agent:f},signal:e.signal??null},url:d,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:s,retryCount:n}){let i={};s&&(i["content-length"]=s);let o=this.defaultHeaders(e);return Wt(i,o),Wt(i,t),wt(e.body)&&H!=="node"&&delete i["content-type"],Ne(o,"x-stainless-retry-count")===void 0&&Ne(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(n)),Ne(o,"x-stainless-timeout")===void 0&&Ne(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(i,t),i}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new c("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,s,n){return g.generate(e,t,s,n)}request(e,t=null){return new $e(this.makeRequest(e,t))}async makeRequest(e,t){let s=await e,n=s.maxRetries??this.maxRetries;t==null&&(t=n),await this.prepareOptions(s);let{req:i,url:o,timeout:a}=this.buildRequest(s,{retryCount:n-t});if(await this.prepareRequest(i,{url:o,options:s}),Z("request",o,s,i.headers),s.signal?.aborted)throw new b;let h=new AbortController,d=await this.fetchWithTimeout(o,i,a,h).catch(Ie);if(d instanceof Error){if(s.signal?.aborted)throw new b;if(t)return this.retryRequest(s,t);throw d.name==="AbortError"?new Y:new N({cause:d})}let f=gt(d.headers);if(!d.ok){if(t&&this.shouldRetry(d)){let Q=`retrying, ${t} attempts remaining`;return Z(`response (error; ${Q})`,d.status,o,f),this.retryRequest(s,t,f)}let w=await d.text().catch(Q=>Ie(Q).message),j=$s(w),z=j?void 0:w;throw Z(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,d.status,o,f,z),this.makeStatusError(d.status,j,z,f)}return{response:d,options:s,controller:h}}requestAPIList(e,t){let s=this.makeRequest(t,null);return new xt(this,s,e)}buildURL(e,t){let s=Os(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return ye(n)||(t={...n,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s<"u").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new c(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,s,n){let{signal:i,...o}=t||{};i&&i.addEventListener("abort",()=>n.abort());let a=setTimeout(()=>n.abort(),s),h={signal:n.signal,...o};h.method&&(h.method=h.method.toUpperCase());let d=60*1e3,f=setTimeout(()=>{if(h&&h?.agent?.sockets)for(let w of Object.values(h?.agent?.sockets).flat())w?.setKeepAlive&&w.setKeepAlive(!0,d)},d);return this.fetch.call(void 0,e,h).finally(()=>{clearTimeout(a),clearTimeout(f)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s){let n,i=s?.["retry-after-ms"];if(i){let a=parseFloat(i);Number.isNaN(a)||(n=a)}let o=s?.["retry-after"];if(o&&!n){let a=parseFloat(o);Number.isNaN(a)?n=Date.parse(o)-Date.now():n=a*1e3}if(!(n&&0<=n&&n<60*1e3)){let a=e.maxRetries??this.maxRetries;n=this.calculateDefaultRetryTimeoutMillis(t,a)}return await qs(n),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,o=Math.min(.5*Math.pow(2,i),8),a=1-Math.random()*.25;return o*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${U}`}},Oe=class{constructor(e,t,s,n){De.set(this,void 0),Ts(this,De,e,"f"),this.options=n,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new c("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let s=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[n,i]of s)e.url.searchParams.set(n,i);t.query=void 0,t.path=e.url.toString()}return await Bs(this,De,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(De=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},xt=class extends $e{constructor(e,t,s){super(t,async n=>new s(e,n.response,await Vt(n),n.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},gt=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){let s=t.toString();return e[s.toLowerCase()]||e[s]}}),Is={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},v=r=>typeof r=="object"&&r!==null&&!ye(r)&&Object.keys(r).every(e=>Xt(Is,e)),Fs=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":Ut(Deno.build.os),"X-Stainless-Arch":jt(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":Ut(process.platform),"X-Stainless-Arch":jt(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let r=Ds();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Ds(){if(typeof navigator>"u"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let s=t.exec(navigator.userAgent);if(s){let n=s[1]||0,i=s[2]||0,o=s[3]||0;return{browser:e,version:`${n}.${i}.${o}`}}}return null}var jt=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",Ut=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),Ht,Ns=()=>Ht??(Ht=Fs()),$s=r=>{try{return JSON.parse(r)}catch{return}},Ls=/^[a-z][a-z0-9+.-]*:/i,Os=r=>Ls.test(r),qs=r=>new Promise(e=>setTimeout(e,r)),bt=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new c(`${r} must be an integer`);if(e<0)throw new c(`${r} must be a positive integer`);return e},Ie=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(String(r))};var qe=r=>{if(typeof process<"u")return process.env?.[r]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(r)?.trim()};function ye(r){if(!r)return!0;for(let e in r)return!1;return!0}function Xt(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function Wt(r,e){for(let t in e){if(!Xt(e,t))continue;let s=t.toLowerCase();if(!s)continue;let n=e[t];n===null?delete r[s]:n!==void 0&&(r[s]=n)}}function Z(r,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`Anthropic:DEBUG:${r}`,...e)}var js=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),Jt=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Us=r=>typeof r?.get=="function";var Ne=(r,e)=>{let t=e.toLowerCase();if(Us(r)){let s=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(n,i,o)=>i+o.toUpperCase());for(let n of[e,t,e.toUpperCase(),s]){let i=r.get(n);if(i)return i}}for(let[s,n]of Object.entries(r))if(s.toLowerCase()===t)return Array.isArray(n)?(n.length<=1||console.warn(`Received ${n.length} entries for the ${e} header, using the first entry.`),n[0]):n};var A=class extends Oe{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){if(this.options.query?.before_id){let t=this.first_id;return t?{params:{before_id:t}}:null}let e=this.last_id;return e?{params:{after_id:e}}:null}};var y=class{constructor(e){this._client=e}};var V=class extends y{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return v(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",ee,{query:e,...t})}},ee=class extends A{};V.BetaModelInfosPage=ee;var te=class r{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new B;for await(let t of this.iterator)for(let s of e.decode(t))yield JSON.parse(s);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new c("Attempted to iterate over a response with no body");return new r(me(e.body),t)}};var K=class extends y{create(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/batches?beta=true",{body:n,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}retrieve(e,t={},s){if(v(t))return this.retrieve(e,{},t);let{betas:n}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}list(e={},t){if(v(e))return this.list({},e);let{betas:s,...n}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",se,{query:n,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}delete(e,t={},s){if(v(t))return this.delete(e,{},t);let{betas:n}=t;return this._client.delete(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}cancel(e,t={},s){if(v(t))return this.cancel(e,{},t);let{betas:n}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}async results(e,t={},s){if(v(t))return this.results(e,{},t);let n=await this.retrieve(e);if(!n.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);let{betas:i}=t;return this._client.get(n.results_url,{...s,headers:{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...s?.headers},__binaryResponse:!0})._thenUnwrap((o,a)=>te.fromResponse(a.response,a.controller))}},se=class extends A{};K.BetaMessageBatchesPage=se;var Ks=r=>{let e=0,t=[];for(;e<r.length;){let s=r[e];if(s==="\\"){e++;continue}if(s==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(s==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(s==="["){t.push({type:"paren",value:"["}),e++;continue}if(s==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(s===":"){t.push({type:"separator",value:":"}),e++;continue}if(s===","){t.push({type:"delimiter",value:","}),e++;continue}if(s==='"'){let a="",h=!1;for(s=r[++e];s!=='"';){if(e===r.length){h=!0;break}if(s==="\\"){if(e++,e===r.length){h=!0;break}a+=s+r[e],s=r[++e]}else a+=s,s=r[++e]}s=r[++e],h||t.push({type:"string",value:a});continue}if(s&&/\s/.test(s)){e++;continue}let i=/[0-9]/;if(s&&i.test(s)||s==="-"||s==="."){let a="";for(s==="-"&&(a+=s,s=r[++e]);s&&i.test(s)||s===".";)a+=s,s=r[++e];t.push({type:"number",value:a});continue}let o=/[a-z]/i;if(s&&o.test(s)){let a="";for(;s&&o.test(s)&&e!==r.length;)a+=s,s=r[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},ne=r=>{if(r.length===0)return r;let e=r[r.length-1];switch(e.type){case"separator":return r=r.slice(0,r.length-1),ne(r);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return r=r.slice(0,r.length-1),ne(r);case"string":let s=r[r.length-2];if(s?.type==="delimiter")return r=r.slice(0,r.length-1),ne(r);if(s?.type==="brace"&&s.value==="{")return r=r.slice(0,r.length-1),ne(r);break;case"delimiter":return r=r.slice(0,r.length-1),ne(r);break}return r},Xs=r=>{let e=[];return r.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?r.push({type:"brace",value:"}"}):t==="]"&&r.push({type:"paren",value:"]"})}),r},Js=r=>{let e="";return r.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},je=r=>JSON.parse(Js(Xs(ne(Ks(r)))));var x=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},l=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},S,$,we,Ue,be,xe,He,_e,I,Ee,We,Ve,re,Ke,Xe,_t,Gt,Et,vt,St,kt,zt,Qt="__json_buf",Je=class r{constructor(){S.add(this),this.messages=[],this.receivedMessages=[],$.set(this,void 0),this.controller=new AbortController,we.set(this,void 0),Ue.set(this,()=>{}),be.set(this,()=>{}),xe.set(this,void 0),He.set(this,()=>{}),_e.set(this,()=>{}),I.set(this,{}),Ee.set(this,!1),We.set(this,!1),Ve.set(this,!1),re.set(this,!1),Ke.set(this,void 0),Xe.set(this,void 0),Et.set(this,e=>{if(x(this,We,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new b),e instanceof b)return x(this,Ve,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),x(this,we,new Promise((e,t)=>{x(this,Ue,e,"f"),x(this,be,t,"f")}),"f"),x(this,xe,new Promise((e,t)=>{x(this,He,e,"f"),x(this,_e,t,"f")}),"f"),l(this,we,"f").catch(()=>{}),l(this,xe,"f").catch(()=>{})}get response(){return l(this,Ke,"f")}get request_id(){return l(this,Xe,"f")}async withResponse(){let e=await l(this,we,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let i of t.messages)n._addMessageParam(i);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,Et,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),l(this,S,"m",vt).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(i);for await(let a of o)l(this,S,"m",St).call(this,a);if(o.controller.signal?.aborted)throw new b;l(this,S,"m",kt).call(this)}_connected(e){this.ended||(x(this,Ke,e,"f"),x(this,Xe,e?.headers.get("request-id"),"f"),l(this,Ue,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,Ee,"f")}get errored(){return l(this,We,"f")}get aborted(){return l(this,Ve,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,I,"f")[e]||(l(this,I,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=l(this,I,"f")[e];if(!s)return this;let n=s.findIndex(i=>i.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(l(this,I,"f")[e]||(l(this,I,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{x(this,re,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){x(this,re,!0,"f"),await l(this,xe,"f")}get currentMessage(){return l(this,$,"f")}async finalMessage(){return await this.done(),l(this,S,"m",_t).call(this)}async finalText(){return await this.done(),l(this,S,"m",Gt).call(this)}_emit(e,...t){if(l(this,Ee,"f"))return;e==="end"&&(x(this,Ee,!0,"f"),l(this,He,"f").call(this));let s=l(this,I,"f")[e];if(s&&(l(this,I,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!l(this,re,"f")&&!s?.length&&Promise.reject(n),l(this,be,"f").call(this,n),l(this,_e,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!l(this,re,"f")&&!s?.length&&Promise.reject(n),l(this,be,"f").call(this,n),l(this,_e,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,S,"m",_t).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,S,"m",vt).call(this),this._connected(null);let n=M.fromReadableStream(e,this.controller);for await(let i of n)l(this,S,"m",St).call(this,i);if(n.controller.signal?.aborted)throw new b;l(this,S,"m",kt).call(this)}[($=new WeakMap,we=new WeakMap,Ue=new WeakMap,be=new WeakMap,xe=new WeakMap,He=new WeakMap,_e=new WeakMap,I=new WeakMap,Ee=new WeakMap,We=new WeakMap,Ve=new WeakMap,re=new WeakMap,Ke=new WeakMap,Xe=new WeakMap,Et=new WeakMap,S=new WeakSet,_t=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Gt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},vt=function(){this.ended||x(this,$,void 0,"f")},St=function(t){if(this.ended)return;let s=l(this,S,"m",zt).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let n=s.content.at(-1);switch(t.delta.type){case"text_delta":{n.type==="text"&&this._emit("text",t.delta.text,n.text||"");break}case"citations_delta":{n.type==="text"&&this._emit("citation",t.delta.citation,n.citations??[]);break}case"input_json_delta":{n.type==="tool_use"&&n.input&&this._emit("inputJson",t.delta.partial_json,n.input);break}case"thinking_delta":{n.type==="thinking"&&this._emit("thinking",t.delta.thinking,n.thinking);break}case"signature_delta":{n.type==="thinking"&&this._emit("signature",n.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{x(this,$,s,"f");break}case"content_block_start":case"message_delta":break}},kt=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=l(this,$,"f");if(!t)throw new c("request ended without sending any chunks");return x(this,$,void 0,"f"),t},zt=function(t){let s=l(this,$,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let n=s.content.at(t.index);switch(t.delta.type){case"text_delta":{n?.type==="text"&&(n.text+=t.delta.text);break}case"citations_delta":{n?.type==="text"&&(n.citations??(n.citations=[]),n.citations.push(t.delta.citation));break}case"input_json_delta":{if(n?.type==="tool_use"){let i=n[Qt]||"";i+=t.delta.partial_json,Object.defineProperty(n,Qt,{value:i,enumerable:!1,writable:!0}),i&&(n.input=je(i))}break}case"thinking_delta":{n?.type==="thinking"&&(n.thinking+=t.delta.thinking);break}case"signature_delta":{n?.type==="thinking"&&(n.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let i=t.shift();i?i.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new M(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Yt={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"},L=class extends y{constructor(){super(...arguments),this.batches=new K(this._client)}create(e,t){let{betas:s,...n}=e;return n.model in Yt&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${Yt[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:n,timeout:this._client._options.timeout??(n.stream?6e5:this._client._calculateNonstreamingTimeout(n.max_tokens)),...t,headers:{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0,...t?.headers},stream:e.stream??!1})}stream(e,t){return Je.createMessage(this,e,t)}countTokens(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:n,...t,headers:{"anthropic-beta":[...s??[],"token-counting-2024-11-01"].toString(),...t?.headers}})}};L.Batches=K;L.BetaMessageBatchesPage=se;var R=class extends y{constructor(){super(...arguments),this.models=new V(this._client),this.messages=new L(this._client)}};R.Models=V;R.BetaModelInfosPage=ee;R.Messages=L;var X=class extends y{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}};var J=class extends y{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return v(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",ie,{query:e,...t})}delete(e,t){return this._client.delete(`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let s=await this.retrieve(e);if(!s.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})._thenUnwrap((n,i)=>te.fromResponse(i.response,i.controller))}},ie=class extends A{};J.MessageBatchesPage=ie;var _=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},u=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},k,O,ve,Ge,Se,ke,ze,Pe,F,Ce,Qe,Ye,oe,Ze,et,Pt,Zt,Ct,Mt,At,Rt,es,ts="__json_buf",tt=class r{constructor(){k.add(this),this.messages=[],this.receivedMessages=[],O.set(this,void 0),this.controller=new AbortController,ve.set(this,void 0),Ge.set(this,()=>{}),Se.set(this,()=>{}),ke.set(this,void 0),ze.set(this,()=>{}),Pe.set(this,()=>{}),F.set(this,{}),Ce.set(this,!1),Qe.set(this,!1),Ye.set(this,!1),oe.set(this,!1),Ze.set(this,void 0),et.set(this,void 0),Ct.set(this,e=>{if(_(this,Qe,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new b),e instanceof b)return _(this,Ye,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),_(this,ve,new Promise((e,t)=>{_(this,Ge,e,"f"),_(this,Se,t,"f")}),"f"),_(this,ke,new Promise((e,t)=>{_(this,ze,e,"f"),_(this,Pe,t,"f")}),"f"),u(this,ve,"f").catch(()=>{}),u(this,ke,"f").catch(()=>{})}get response(){return u(this,Ze,"f")}get request_id(){return u(this,et,"f")}async withResponse(){let e=await u(this,ve,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let i of t.messages)n._addMessageParam(i);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},u(this,Ct,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),u(this,k,"m",Mt).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(i);for await(let a of o)u(this,k,"m",At).call(this,a);if(o.controller.signal?.aborted)throw new b;u(this,k,"m",Rt).call(this)}_connected(e){this.ended||(_(this,Ze,e,"f"),_(this,et,e?.headers.get("request-id"),"f"),u(this,Ge,"f").call(this,e),this._emit("connect"))}get ended(){return u(this,Ce,"f")}get errored(){return u(this,Qe,"f")}get aborted(){return u(this,Ye,"f")}abort(){this.controller.abort()}on(e,t){return(u(this,F,"f")[e]||(u(this,F,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=u(this,F,"f")[e];if(!s)return this;let n=s.findIndex(i=>i.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(u(this,F,"f")[e]||(u(this,F,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{_(this,oe,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){_(this,oe,!0,"f"),await u(this,ke,"f")}get currentMessage(){return u(this,O,"f")}async finalMessage(){return await this.done(),u(this,k,"m",Pt).call(this)}async finalText(){return await this.done(),u(this,k,"m",Zt).call(this)}_emit(e,...t){if(u(this,Ce,"f"))return;e==="end"&&(_(this,Ce,!0,"f"),u(this,ze,"f").call(this));let s=u(this,F,"f")[e];if(s&&(u(this,F,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!u(this,oe,"f")&&!s?.length&&Promise.reject(n),u(this,Se,"f").call(this,n),u(this,Pe,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!u(this,oe,"f")&&!s?.length&&Promise.reject(n),u(this,Se,"f").call(this,n),u(this,Pe,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",u(this,k,"m",Pt).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),u(this,k,"m",Mt).call(this),this._connected(null);let n=M.fromReadableStream(e,this.controller);for await(let i of n)u(this,k,"m",At).call(this,i);if(n.controller.signal?.aborted)throw new b;u(this,k,"m",Rt).call(this)}[(O=new WeakMap,ve=new WeakMap,Ge=new WeakMap,Se=new WeakMap,ke=new WeakMap,ze=new WeakMap,Pe=new WeakMap,F=new WeakMap,Ce=new WeakMap,Qe=new WeakMap,Ye=new WeakMap,oe=new WeakMap,Ze=new WeakMap,et=new WeakMap,Ct=new WeakMap,k=new WeakSet,Pt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Zt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},Mt=function(){this.ended||_(this,O,void 0,"f")},At=function(t){if(this.ended)return;let s=u(this,k,"m",es).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let n=s.content.at(-1);switch(t.delta.type){case"text_delta":{n.type==="text"&&this._emit("text",t.delta.text,n.text||"");break}case"citations_delta":{n.type==="text"&&this._emit("citation",t.delta.citation,n.citations??[]);break}case"input_json_delta":{n.type==="tool_use"&&n.input&&this._emit("inputJson",t.delta.partial_json,n.input);break}case"thinking_delta":{n.type==="thinking"&&this._emit("thinking",t.delta.thinking,n.thinking);break}case"signature_delta":{n.type==="thinking"&&this._emit("signature",n.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{_(this,O,s,"f");break}case"content_block_start":case"message_delta":break}},Rt=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=u(this,O,"f");if(!t)throw new c("request ended without sending any chunks");return _(this,O,void 0,"f"),t},es=function(t){let s=u(this,O,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let n=s.content.at(t.index);switch(t.delta.type){case"text_delta":{n?.type==="text"&&(n.text+=t.delta.text);break}case"citations_delta":{n?.type==="text"&&(n.citations??(n.citations=[]),n.citations.push(t.delta.citation));break}case"input_json_delta":{if(n?.type==="tool_use"){let i=n[ts]||"";i+=t.delta.partial_json,Object.defineProperty(n,ts,{value:i,enumerable:!1,writable:!0}),i&&(n.input=je(i))}break}case"thinking_delta":{n?.type==="thinking"&&(n.thinking+=t.delta.thinking);break}case"signature_delta":{n?.type==="thinking"&&(n.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let i=t.shift();i?i.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let i of t)i.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new M(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var D=class extends y{constructor(){super(...arguments),this.batches=new J(this._client)}create(e,t){return e.model in ss&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${ss[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??(e.stream?6e5:this._client._calculateNonstreamingTimeout(e.max_tokens)),...t,stream:e.stream??!1})}stream(e,t){return tt.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},ss={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};D.Batches=J;D.MessageBatchesPage=ie;var q=class extends y{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return v(e)?this.list({},e):this._client.getAPIList("/v1/models",G,{query:e,...t})}},G=class extends A{};q.ModelInfosPage=G;var ns,p=class extends Le{constructor({baseURL:e=qe("ANTHROPIC_BASE_URL"),apiKey:t=qe("ANTHROPIC_API_KEY")??null,authToken:s=qe("ANTHROPIC_AUTH_TOKEN")??null,...n}={}){let i={apiKey:t,authToken:s,...n,baseURL:e||"https://api.anthropic.com"};if(!i.dangerouslyAllowBrowser&&Jt())throw new c(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new X(this),this.messages=new D(this),this.models=new q(this),this.beta=new R(this),this._options=i,this.apiKey=t,this.authToken=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){let t=this.apiKeyAuth(e),s=this.bearerAuth(e);return t!=null&&!ye(t)?t:s!=null&&!ye(s)?s:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}};ns=p;p.Anthropic=ns;p.HUMAN_PROMPT=`

Human:`;p.AI_PROMPT=`

Assistant:`;p.DEFAULT_TIMEOUT=6e5;p.AnthropicError=c;p.APIError=g;p.APIConnectionError=N;p.APIConnectionTimeoutError=Y;p.APIUserAbortError=b;p.NotFoundError=ue;p.ConflictError=de;p.RateLimitError=pe;p.BadRequestError=ae;p.AuthenticationError=ce;p.InternalServerError=fe;p.PermissionDeniedError=le;p.UnprocessableEntityError=he;p.toFile=qt;p.fileFromPath=Te;p.Completions=X;p.Messages=D;p.Models=q;p.ModelInfosPage=G;p.Beta=R;var{HUMAN_PROMPT:Fr,AI_PROMPT:Dr}=p,rs=p;var st=class{client=null;settings;constructor(e){this.settings=e,this.initClient()}initClient(){this.settings.apiKey&&(this.client=new rs({apiKey:this.settings.apiKey,dangerouslyAllowBrowser:!0}))}updateSettings(e){this.settings=e,this.initClient()}isConfigured(){return!!this.client&&!!this.settings.apiKey}async sendMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let n=e.map(a=>({role:a.role,content:a.content}));if(this.settings.streamResponses&&s)return this.streamMessage(n,t,s);let o=(await this.client.messages.create({model:this.settings.model,max_tokens:4096,system:t,messages:n})).content.find(a=>a.type==="text");return o?.type==="text"?o.text:""}async streamMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let n="",i=this.client.messages.stream({model:this.settings.model,max_tokens:4096,system:t,messages:e});for await(let o of i)if(o.type==="content_block_delta"&&o.delta.type==="text_delta"){let a=o.delta.text;n+=a,s(a)}return n}};var nt=class{settings;preferences=[];constructor(e){this.settings=e}updateSettings(e){this.settings=e}async loadPreferences(){return this.preferences=[{id:"cotton-react",name:"Cotton React Conventions",priority:100,tags:["react","typescript"],content:`## React Conventions

- Use named exports, not default exports
- Use function declarations with forwardRef
- Add displayName for debugging
- Use semantic tokens, never primitives

## Example

\`\`\`tsx
export const CottonButton = forwardRef<HTMLButtonElement, Props>(
  function CottonButton(props, ref) {
    return <button ref={ref} {...props} />;
  }
);
CottonButton.displayName = 'CottonButton';
\`\`\``},{id:"cotton-tokens",name:"Cotton Design Tokens",priority:100,tags:["css","tokens"],content:"## Design Tokens\n\nAlways use semantic tokens:\n- `--cotton-color-text-primary` (not `--cotton-color-gray-900`)\n- `--cotton-color-action-primary` (not `--cotton-color-blue-500`)\n- `--cotton-spacing-4` (not `16px`)\n\n## BEM Naming\n\n```css\n.cotton-btn { }           /* Block */\n.cotton-btn--primary { }  /* Modifier */\n.cotton-btn__icon { }     /* Element */\n```"}],this.preferences}formatForSystemPrompt(){return this.preferences.length===0?"":`## Cotton AI Preferences

The following coding standards and conventions should be followed:

${this.preferences.sort((t,s)=>s.priority-t.priority).map(t=>`### ${t.name}

${t.content}`).join(`

---

`)}`}};var rt=class{app;settings;constructor(e,t){this.app=e,this.settings=t}updateSettings(e){this.settings=e}async buildContext(e,t){if(!e)return null;let s=await this.app.vault.read(e),n=this.app.metadataCache.getFileCache(e)?.frontmatter,i={path:e.path,name:e.basename,content:this.truncateContent(s),frontmatter:n,selection:t};return this.settings.includeBacklinks&&(i.backlinks=this.getBacklinks(e)),i}truncateContent(e){let t=e.split(`
`);return t.length<=this.settings.contextLines?e:t.slice(0,this.settings.contextLines).join(`
`)+`

[...truncated]`}getBacklinks(e){let t=[],s=this.app.metadataCache.resolvedLinks;for(let[n,i]of Object.entries(s))i[e.path]&&t.push(n);return t.slice(0,10)}formatContextForPrompt(e){let t=`## Current Note: ${e.name}

`;return e.frontmatter&&(t+=`### Frontmatter
\`\`\`yaml
${JSON.stringify(e.frontmatter,null,2)}
\`\`\`

`),e.selection&&(t+=`### Selected Text
\`\`\`
${e.selection}
\`\`\`

`),t+=`### Content
\`\`\`markdown
${e.content}
\`\`\`
`,e.backlinks&&e.backlinks.length>0&&(t+=`
### Backlinks
${e.backlinks.map(s=>`- [[${s}]]`).join(`
`)}
`),t}};var T=require("obsidian"),it=class extends T.Modal{plugin;editor;context;inputEl=null;responseEl=null;constructor(e,t,s,n){super(e),this.plugin=t,this.editor=s,this.context=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-ask-claude-modal"),e.createEl("h2",{text:"Ask Claude"}),this.context&&e.createEl("p",{text:`Context: ${this.context.name}`,cls:"cotton-context-label"});let t=e.createDiv({cls:"cotton-input-container"});if(this.inputEl=new T.TextAreaComponent(t),this.inputEl.inputEl.addClass("cotton-input"),this.inputEl.setPlaceholder("Ask a question about this note..."),this.inputEl.inputEl.rows=3,this.context?.selection){let o=e.createDiv({cls:"cotton-selection-preview"});o.createEl("strong",{text:"Selected: "}),o.createEl("code",{text:this.context.selection.length>100?this.context.selection.slice(0,100)+"...":this.context.selection})}let s=e.createDiv({cls:"cotton-button-container"});s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),s.createEl("button",{text:"Ask",cls:"mod-cta"}).addEventListener("click",()=>this.handleAsk()),this.responseEl=e.createDiv({cls:"cotton-response"}),this.responseEl.style.display="none",this.inputEl.inputEl.focus(),this.inputEl.inputEl.addEventListener("keydown",o=>{o.key==="Enter"&&(o.metaKey||o.ctrlKey)&&this.handleAsk()})}async handleAsk(){let e=this.inputEl?.getValue();if(!e?.trim()){new T.Notice("Please enter a question");return}if(!this.plugin.claude.isConfigured()){new T.Notice("Claude API key not configured. Check settings.");return}this.responseEl&&(this.responseEl.style.display="block",this.responseEl.empty(),this.responseEl.createEl("p",{text:"Thinking...",cls:"cotton-thinking"}));try{let t=this.plugin.preferences.formatForSystemPrompt(),s=this.context?this.plugin.contextBuilder.formatContextForPrompt(this.context):"",n=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${t}

${s}

Respond concisely and helpfully. Use markdown formatting.`,i=[{role:"user",content:e,timestamp:Date.now()}],o="";if(this.responseEl&&this.responseEl.empty(),o=await this.plugin.claude.sendMessage(i,n,a=>{this.responseEl&&(this.responseEl.textContent=(this.responseEl.textContent||"")+a)}),this.responseEl&&o){this.responseEl.empty();let a=this.responseEl.createDiv({cls:"cotton-response-content"});a.innerHTML=o}}catch(t){new T.Notice(`Error: ${t instanceof Error?t.message:"Unknown error"}`),this.responseEl&&(this.responseEl.empty(),this.responseEl.createEl("p",{text:`Error: ${t instanceof Error?t.message:"Unknown error"}`,cls:"cotton-error"}))}}onClose(){let{contentEl:e}=this;e.empty()}};function is(r){r.addCommand({id:"ask-claude",name:"Ask Claude",editorCallback:async(e,t)=>{let s=e.getSelection(),n=t.file,i=n?await r.contextBuilder.buildContext(n,s||void 0):null;new it(r.app,r,e,i).open()}}),r.addCommand({id:"ask-claude-general",name:"Ask Claude (General)",callback:async()=>{let t=r.app.workspace.getActiveViewOfType(T.MarkdownView)?.file||null,s=t?await r.contextBuilder.buildContext(t):null;new it(r.app,r,null,s).open()}})}var P=require("obsidian");var m=require("obsidian"),ot=class extends m.Modal{plugin;message;constructor(e,t,s){super(e),this.plugin=t,this.message=s}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Save Response"});let t=e.createDiv({cls:"cotton-save-options"}),s=[{id:"quick-save",label:"Quick Save",description:`Save to ${this.plugin.settings.chatFolder}/Responses`,icon:"zap",action:()=>this.quickSave()},{id:"current-note",label:"Append to Current Note",description:"Add response to the active note",icon:"file-plus",action:()=>this.appendToCurrentNote()},{id:"new-note",label:"Create New Note",description:"Save as a new note with custom name",icon:"file-text",action:()=>this.createNewNote()},{id:"browse",label:"Browse...",description:"Choose a specific folder",icon:"folder",action:()=>this.browseForFolder()}];for(let n of s){let i=t.createDiv({cls:"cotton-save-option"});i.addEventListener("click",async()=>{await n.action()});let o=i.createDiv({cls:"cotton-save-option-icon"});(0,m.setIcon)(o,n.icon);let a=i.createDiv({cls:"cotton-save-option-text"});a.createDiv({cls:"cotton-save-option-label",text:n.label}),a.createDiv({cls:"cotton-save-option-desc",text:n.description})}}formatResponseContent(){let e=new Date,t=e.toISOString(),s=e.toLocaleString();return`---
source: cotton-ai
saved: ${t}
model: ${this.getModelName()}
---

${this.message.content}

---
*Saved from Cotton AI on ${s}*
`}getModelName(){let e=this.plugin.settings.model;return e.includes("sonnet")?"Sonnet 4":e.includes("opus")?"Opus 4":e.includes("haiku")?"Haiku 3.5":"Claude"}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}generateFilename(){let e=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),t=this.message.content.slice(0,30).replace(/[^a-zA-Z0-9 ]/g,"").trim().replace(/\s+/g,"-")||"response";return`${e}-${t}`}async quickSave(){try{let e=this.plugin.settings.chatFolder||"Cotton/Chats",t=`${e}/Responses`;await this.ensureFolderExists(e),await this.ensureFolderExists(t);let s=`${t}/${this.generateFilename()}.md`,n=this.formatResponseContent();await this.app.vault.create(s,n),new m.Notice(`Saved to ${s}`),this.close()}catch(e){new m.Notice(`Failed to save: ${e instanceof Error?e.message:"Unknown error"}`)}}async appendToCurrentNote(){try{let e=this.app.workspace.getActiveFile();if(!e){new m.Notice("No active note to append to");return}let t=await this.app.vault.read(e),s=`

---

## AI Response

${this.message.content}

*Added from Cotton AI on ${new Date().toLocaleString()}*
`;await this.app.vault.modify(e,t+s),new m.Notice(`Appended to ${e.basename}`),this.close()}catch(e){new m.Notice(`Failed to append: ${e instanceof Error?e.message:"Unknown error"}`)}}async createNewNote(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Create New Note"});let t=e.createDiv({cls:"cotton-save-input-container"});t.createEl("label",{text:"Note name:",cls:"cotton-save-label"});let s=t.createEl("input",{type:"text",cls:"cotton-save-input",value:this.generateFilename()});t.createEl("label",{text:"Folder:",cls:"cotton-save-label"});let n=t.createEl("input",{type:"text",cls:"cotton-save-input",value:this.plugin.settings.chatFolder||"Cotton/Chats"}),i=e.createDiv({cls:"cotton-save-buttons"});i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),i.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",async()=>{let h=s.value.trim(),d=n.value.trim();if(!h){new m.Notice("Please enter a note name");return}try{await this.ensureFolderExists(d);let f=`${d}/${h}.md`,w=this.formatResponseContent();await this.app.vault.create(f,w),new m.Notice(`Created ${f}`),this.close()}catch(f){new m.Notice(`Failed to create: ${f instanceof Error?f.message:"Unknown error"}`)}}),s.focus(),s.select()}async browseForFolder(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Select Folder"});let t=e.createDiv({cls:"cotton-folder-list"}),s=this.getAllFolders(),n=t.createDiv({cls:"cotton-folder-option"});(0,m.setIcon)(n.createSpan(),"home"),n.createSpan({text:" / (root)"}),n.addEventListener("click",()=>this.saveToFolder(""));for(let o of s){let a=t.createDiv({cls:"cotton-folder-option"});(0,m.setIcon)(a.createSpan(),"folder"),a.createSpan({text:` ${o.path}`}),a.addEventListener("click",()=>this.saveToFolder(o.path))}e.createEl("button",{text:"Cancel",cls:"cotton-cancel-btn"}).addEventListener("click",()=>this.close())}getAllFolders(){let e=[],t=this.app.vault.getRoot(),s=n=>{for(let i of n.children)i instanceof m.TFolder&&(e.push(i),s(i))};return s(t),e.sort((n,i)=>n.path.localeCompare(i.path))}async saveToFolder(e){try{let t=e?`${e}/${this.generateFilename()}.md`:`${this.generateFilename()}.md`,s=this.formatResponseContent();await this.app.vault.create(t,s),new m.Notice(`Saved to ${t}`),this.close()}catch(t){new m.Notice(`Failed to save: ${t instanceof Error?t.message:"Unknown error"}`)}}onClose(){let{contentEl:e}=this;e.empty()}};var os=require("obsidian"),Ys={understanding:"Understanding your question",context:"Reviewing context",thinking:"Thinking",generating:"Generating response",complete:"Complete"},at=class{containerEl;stageEl=null;iconEl=null;currentStage="understanding";animationInterval=null;constructor(e){this.containerEl=e.createDiv({cls:"cotton-thinking-container"}),this.render(),this.startAnimation()}render(){this.containerEl.empty();let e=this.containerEl.createDiv({cls:"cotton-thinking-indicator"});this.iconEl=e.createDiv({cls:"cotton-thinking-icon"}),(0,os.setIcon)(this.iconEl,"loader-2"),this.stageEl=e.createDiv({cls:"cotton-thinking-label"}),this.updateLabel()}updateLabel(){this.stageEl&&(this.stageEl.textContent=Ys[this.currentStage])}startAnimation(){let e=["understanding","context","thinking","generating"],t=0;this.animationInterval=window.setInterval(()=>{t=(t+1)%e.length,this.currentStage=e[t],this.updateLabel()},2e3)}setStage(e){this.currentStage=e,this.updateLabel(),e==="complete"&&(this.stopAnimation(),this.containerEl.addClass("cotton-thinking-complete"))}stopAnimation(){this.animationInterval!==null&&(window.clearInterval(this.animationInterval),this.animationInterval=null)}remove(){this.stopAnimation(),this.containerEl.remove()}getElement(){return this.containerEl}};var Me="cotton-chat-view",ct=class extends P.ItemView{plugin;messages=[];inputEl=null;messagesEl=null;isLoading=!1;constructor(e,t){super(e),this.plugin=t}getViewType(){return Me}getDisplayText(){return"Cotton AI"}getIcon(){return"circle"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("cotton-chat-container");let t=e.createDiv({cls:"cotton-chat-header"});t.createEl("h4",{text:"Cotton AI"});let s=t.createEl("span",{text:this.getModelName(),cls:"cotton-model-badge"});t.createEl("button",{text:"Clear",cls:"cotton-clear-btn"}).addEventListener("click",()=>this.clearChat()),this.messagesEl=e.createDiv({cls:"cotton-chat-messages"});let i=e.createDiv({cls:"cotton-chat-input-container"});this.inputEl=i.createEl("textarea",{cls:"cotton-chat-input",attr:{placeholder:"Ask Claude...",rows:"3"}}),this.inputEl.addEventListener("keydown",d=>{d.key==="Enter"&&(d.metaKey||d.ctrlKey)&&(d.preventDefault(),this.sendMessage())});let o=i.createDiv({cls:"cotton-chat-buttons"});o.createEl("button",{text:"Add Context",cls:"cotton-context-btn"}).addEventListener("click",()=>this.addCurrentNoteContext()),o.createEl("button",{text:"Send",cls:"mod-cta cotton-send-btn"}).addEventListener("click",()=>this.sendMessage()),await this.loadMessages()}async onClose(){await this.saveMessages()}getModelName(){let e=this.plugin.settings.model;return e.includes("sonnet")?"Sonnet 4":e.includes("opus")?"Opus 4":e.includes("haiku")?"Haiku 3.5":"Claude"}async sendMessage(){if(!this.inputEl||this.isLoading||!this.messagesEl)return;let e=this.inputEl.value.trim();if(!e)return;if(!this.plugin.claude.isConfigured()){this.addSystemMessage("API key not configured. Check settings.");return}let t={role:"user",content:e,timestamp:Date.now()};this.messages.push(t),this.renderMessage(t),this.inputEl.value="",this.isLoading=!0;let s=new at(this.messagesEl);this.messagesEl.scrollTop=this.messagesEl.scrollHeight;try{s.setStage("understanding");let n=this.app.workspace.getActiveFile(),i=n?await this.plugin.contextBuilder.buildContext(n):null;i&&s.setStage("context");let o=this.plugin.preferences.formatForSystemPrompt(),a=i?this.plugin.contextBuilder.formatContextForPrompt(i):"",h=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${o}

${a}

Respond concisely and helpfully. Use markdown formatting.`;s.setStage("thinking");let d="",f=!1;if(await this.plugin.claude.sendMessage(this.messages.filter(w=>w.role!=="system"),h,w=>{d+=w,!f&&d.length>0&&(f=!0,s.setStage("generating"))}),s.setStage("complete"),s.remove(),d){let w=this.messagesEl.createDiv({cls:"cotton-message cotton-message-assistant cotton-message-appear"}),j=w.createDiv({cls:"cotton-message-actions"}),z=j.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Copy to clipboard"}});(0,P.setIcon)(z,"copy");let ut=j.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Save to note"}});(0,P.setIcon)(ut,"save");let Bt=w.createDiv({cls:"cotton-message-content"});await P.MarkdownRenderer.render(this.app,d,Bt,"",this.plugin);let Q={role:"assistant",content:d,timestamp:Date.now()};this.messages.push(Q),z.addEventListener("click",()=>this.copyToClipboard(d)),ut.addEventListener("click",()=>this.openSaveModal(Q)),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}await this.saveToNote()}catch(n){s.remove(),this.addSystemMessage(`Error: ${n instanceof Error?n.message:"Unknown error"}`)}finally{this.isLoading=!1}}renderMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:`cotton-message cotton-message-${e.role}`});if(e.role==="user")t.textContent=e.content;else{let s=t.createDiv({cls:"cotton-message-actions"}),n=s.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Copy to clipboard"}});(0,P.setIcon)(n,"copy"),n.addEventListener("click",()=>this.copyToClipboard(e.content));let i=s.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Save to note"}});(0,P.setIcon)(i,"save"),i.addEventListener("click",()=>this.openSaveModal(e));let o=t.createDiv({cls:"cotton-message-content"});P.MarkdownRenderer.render(this.app,e.content,o,"",this.plugin)}this.messagesEl.scrollTop=this.messagesEl.scrollHeight}async copyToClipboard(e){await navigator.clipboard.writeText(e),new P.Notice("Copied to clipboard")}openSaveModal(e){new ot(this.app,this.plugin,e).open()}addSystemMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:"cotton-message cotton-message-system"});t.textContent=e}async addCurrentNoteContext(){let e=this.app.workspace.getActiveFile();if(!e){this.addSystemMessage("No active note to add as context.");return}if(this.inputEl){let t=this.inputEl.value;this.inputEl.value=t+(t?`

`:"")+`[Context: ${e.basename}]`,this.inputEl.focus()}}clearChat(){this.messages=[],this.messagesEl&&this.messagesEl.empty()}async loadMessages(){let e=await this.plugin.loadData();e?.chatHistory&&(this.messages=e.chatHistory,this.messages.forEach(t=>this.renderMessage(t)))}async saveMessages(){let e=await this.plugin.loadData()||{};e.chatHistory=this.messages,await this.plugin.saveData(e)}async saveToNote(){if(this.messages.length===0)return;let e=this.plugin.settings.chatFolder||"Cotton/Chats",t=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),s=this.messages.find(a=>a.role==="user"),n=s?s.content.slice(0,30).replace(/[^a-zA-Z0-9 ]/g,"").trim():"chat",i=`${e}/${t}-${n}.md`,o=`# Cotton AI Chat

`;o+=`Date: ${new Date().toLocaleString()}
`,o+=`Model: ${this.getModelName()}

---

`;for(let a of this.messages)a.role==="user"?o+=`## Question

${a.content}

`:a.role==="assistant"&&(o+=`## Answer

${a.content}

---

`);try{let a=e;this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a);let h=this.app.vault.getAbstractFileByPath(i);h?await this.app.vault.modify(h,o):await this.app.vault.create(i,o)}catch(a){console.error("Failed to save chat to note:",a)}}};var Tt={apiKey:"",model:"claude-sonnet-4-20250514",personalPrefsPath:"",teamPrefsPath:"",streamResponses:!0,contextLines:100,includeBacklinks:!0,chatFolder:"Cotton/Chats"};var lt=class extends as.Plugin{settings=Tt;claude;preferences;contextBuilder;async onload(){console.log("Loading Cotton AI plugin"),await this.loadSettings(),this.claude=new st(this.settings),this.preferences=new nt(this.settings),this.contextBuilder=new rt(this.app,this.settings),await this.preferences.loadPreferences(),this.addSettingTab(new Ae(this.app,this)),this.registerView(Me,e=>new ct(e,this)),is(this),this.addCommand({id:"toggle-chat-panel",name:"Toggle Chat Panel",callback:()=>this.toggleChatPanel()}),this.addRibbonIcon("circle","Cotton AI",()=>{this.toggleChatPanel()}),console.log("Cotton AI plugin loaded")}async toggleChatPanel(){let e=this.app.workspace.getLeavesOfType(Me);if(e.length>0){let t=e[0];t.view.containerEl.isShown()?t.detach():this.app.workspace.revealLeaf(t)}else{let t=this.app.workspace.getLeftLeaf(!1);t&&(await t.setViewState({type:Me,active:!0}),this.app.workspace.revealLeaf(t))}}onunload(){console.log("Unloading Cotton AI plugin")}async loadSettings(){this.settings=Object.assign({},Tt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.claude.updateSettings(this.settings),this.preferences.updateSettings(this.settings),this.contextBuilder.updateSettings(this.settings)}};
