"use strict";var at=Object.defineProperty;var ss=Object.getOwnPropertyDescriptor;var rs=Object.getOwnPropertyNames;var ns=Object.prototype.hasOwnProperty;var is=(n,e)=>{for(var t in e)at(n,t,{get:e[t],enumerable:!0})},os=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of rs(e))!ns.call(n,r)&&r!==t&&at(n,r,{get:()=>e[r],enumerable:!(s=ss(e,r))||s.enumerable});return n};var as=n=>os(at({},"__esModule",{value:!0}),n);var Ks={};is(Ks,{default:()=>nt});module.exports=as(Ks);var ts=require("obsidian");var P=require("obsidian"),Me=class extends P.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Cotton AI Settings"});let s=new P.Setting(e).setName("Claude API Key").addText(r=>r.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,await this.plugin.saveSettings()})).descEl.createDiv();s.appendText("Your Anthropic API key. "),s.createEl("a",{text:"Get your API key",href:"https://console.anthropic.com/settings/keys"}),new P.Setting(e).setName("Model").setDesc("Claude model to use for responses").addDropdown(r=>r.addOption("claude-sonnet-4-20250514","Claude Sonnet 4 (Recommended)").addOption("claude-opus-4-20250514","Claude Opus 4 (Most capable)").addOption("claude-3-5-haiku-20241022","Claude 3.5 Haiku (Fastest)").setValue(this.plugin.settings.model).onChange(async i=>{this.plugin.settings.model=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Preferences"}),new P.Setting(e).setName("Personal Preferences Path").setDesc("Path to your personal Cotton preferences (e.g., ~/.cotton/preferences)").addText(r=>r.setPlaceholder("~/.cotton/preferences").setValue(this.plugin.settings.personalPrefsPath).onChange(async i=>{this.plugin.settings.personalPrefsPath=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Team Preferences Path").setDesc("Path to team Cotton preferences (e.g., .cotton/preferences)").addText(r=>r.setPlaceholder(".cotton/preferences").setValue(this.plugin.settings.teamPrefsPath).onChange(async i=>{this.plugin.settings.teamPrefsPath=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Behavior"}),new P.Setting(e).setName("Stream Responses").setDesc("Show responses as they are generated").addToggle(r=>r.setValue(this.plugin.settings.streamResponses).onChange(async i=>{this.plugin.settings.streamResponses=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Context Lines").setDesc("Number of lines from current note to include as context").addSlider(r=>r.setLimits(0,500,10).setValue(this.plugin.settings.contextLines).setDynamicTooltip().onChange(async i=>{this.plugin.settings.contextLines=i,await this.plugin.saveSettings()})),new P.Setting(e).setName("Include Backlinks").setDesc("Include backlink information in context").addToggle(r=>r.setValue(this.plugin.settings.includeBacklinks).onChange(async i=>{this.plugin.settings.includeBacklinks=i,await this.plugin.saveSettings()}))}};var q="0.39.0";var At=!1,j,ct,cs,ls,us,vt,hs,Ce,lt,Rt,ut,Ae,Tt;function Bt(n,e={auto:!1}){if(At)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${n.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(j)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${n.kind}'\` after \`import '@anthropic-ai/sdk/shims/${j}'\``);At=e.auto,j=n.kind,ct=n.fetch,cs=n.Request,ls=n.Response,us=n.Headers,vt=n.FormData,hs=n.Blob,Ce=n.File,lt=n.ReadableStream,Rt=n.getMultipartRequestOptions,ut=n.getDefaultAgent,Ae=n.fileFromPath,Tt=n.isFsReadStream}var ve=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function It({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n",t,s,r,i;try{t=fetch,s=Request,r=Response,i=Headers}catch(o){throw new Error(`this environment is missing the following Web Fetch API type: ${o.message}. ${e}`)}return{kind:"web",fetch:t,Request:s,Response:r,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(o,a)=>({...a,body:new ve(o)}),getDefaultAgent:o=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:o=>!1}}j||Bt(It(),{auto:!0});var c=class extends Error{},m=class n extends c{constructor(e,t,s,r){super(`${n.makeMessage(e,t,s)}`),this.status=e,this.headers=r,this.request_id=r?.["request-id"],this.error=t}static makeMessage(e,t,s){let r=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,s,r){if(!e||!r)return new N({message:s,cause:Re(t)});let i=t;return e===400?new re(e,i,s,r):e===401?new ne(e,i,s,r):e===403?new ie(e,i,s,r):e===404?new oe(e,i,s,r):e===409?new ae(e,i,s,r):e===422?new ce(e,i,s,r):e===429?new le(e,i,s,r):e>=500?new ue(e,i,s,r):new n(e,i,s,r)}},y=class extends m{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},N=class extends m{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},J=class extends N{constructor({message:e}={}){super({message:e??"Request timed out."})}},re=class extends m{},ne=class extends m{},ie=class extends m{},oe=class extends m{},ae=class extends m{},ce=class extends m{},le=class extends m{},ue=class extends m{};var Te=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},U=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},_,R=class{constructor(){_.set(this,void 0),this.buffer=new Uint8Array,Te(this,_,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,s=new Uint8Array(this.buffer.length+t.length);s.set(this.buffer),s.set(t,this.buffer.length),this.buffer=s;let r=[],i;for(;(i=ps(this.buffer,U(this,_,"f")))!=null;){if(i.carriage&&U(this,_,"f")==null){Te(this,_,i.index,"f");continue}if(U(this,_,"f")!=null&&(i.index!==U(this,_,"f")+1||i.carriage)){r.push(this.decodeText(this.buffer.slice(0,U(this,_,"f")-1))),this.buffer=this.buffer.slice(U(this,_,"f")),Te(this,_,null,"f");continue}let o=U(this,_,"f")!==null?i.preceding-1:i.preceding,a=this.decodeText(this.buffer.slice(0,o));r.push(a),this.buffer=this.buffer.slice(i.index),Te(this,_,null,"f")}return r}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new c(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new c(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new c("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};_=new WeakMap;R.NEWLINE_CHARS=new Set([`
`,"\r"]);R.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function ps(n,e){for(let r=e??0;r<n.length;r++){if(n[r]===10)return{preceding:r,index:r+1,carriage:!1};if(n[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function Ft(n){for(let s=0;s<n.length-1;s++){if(n[s]===10&&n[s+1]===10||n[s]===13&&n[s+1]===13)return s+2;if(n[s]===13&&n[s+1]===10&&s+3<n.length&&n[s+2]===13&&n[s+3]===10)return s+4}return-1}function he(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var M=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;async function*r(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let i=!1;try{for await(let o of ms(e,t)){if(o.event==="completion")try{yield JSON.parse(o.data)}catch(a){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),a}if(o.event==="message_start"||o.event==="message_delta"||o.event==="message_stop"||o.event==="content_block_start"||o.event==="content_block_delta"||o.event==="content_block_stop")try{yield JSON.parse(o.data)}catch(a){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),a}if(o.event!=="ping"&&o.event==="error")throw m.generate(void 0,`SSE Error: ${o.data}`,o.data,dt(e.headers))}i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(r,t)}static fromReadableStream(e,t){let s=!1;async function*r(){let o=new R,a=he(e);for await(let f of a)for(let h of o.decode(f))yield h;for(let f of o.flush())yield f}async function*i(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let a of r())o||a&&(yield JSON.parse(a));o=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{o||t.abort()}}return new n(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],s=this.iterator(),r=i=>({next:()=>{if(i.length===0){let o=s.next();e.push(o),t.push(o)}return i.shift()}});return[new n(()=>r(e),this.controller),new n(()=>r(t),this.controller)]}toReadableStream(){let e=this,t,s=new TextEncoder;return new lt({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{let{value:i,done:o}=await t.next();if(o)return r.close();let a=s.encode(JSON.stringify(i)+`
`);r.enqueue(a)}catch(i){r.error(i)}},async cancel(){await t.return?.()}})}};async function*ms(n,e){if(!n.body)throw e.abort(),new c("Attempted to iterate over a response with no body");let t=new ht,s=new R,r=he(n.body);for await(let i of gs(r))for(let o of s.decode(i)){let a=t.decode(o);a&&(yield a)}for(let i of s.flush()){let o=t.decode(i);o&&(yield o)}}async function*gs(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,r=new Uint8Array(e.length+s.length);r.set(e),r.set(s,e.length),e=r;let i;for(;(i=Ft(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var ht=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,r]=ys(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}};function ys(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}var ws=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",bs=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&de(n),de=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function";async function Nt(n,e,t){if(n=await n,bs(n))return n;if(ws(n)){let r=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");let i=de(r)?[await r.arrayBuffer()]:[r];return new Ce(i,e,t)}let s=await _s(n);if(e||(e=Es(n)??"unknown_file"),!t?.type){let r=s[0]?.type;typeof r=="string"&&(t={...t,type:r})}return new Ce(s,e,t)}async function _s(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(de(n))e.push(await n.arrayBuffer());else if(Ss(n))for await(let t of n)e.push(t);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${n?.constructor?.name}; props: ${xs(n)}`);return e}function xs(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function Es(n){return ft(n.name)||ft(n.filename)||ft(n.path)?.split(/[\\/]/).pop()}var ft=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},Ss=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",pt=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var Ps=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},Ms=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},Be;async function qt(n){let{response:e}=n;if(n.options.stream)return G("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):M.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let i=await e.json();return G("response",e.status,e.url,e.headers,i),jt(i,e)}let r=await e.text();return G("response",e.status,e.url,e.headers,r),r}function jt(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var Fe=class n extends Promise{constructor(e,t=qt){super(s=>{s(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>jt(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Ne=class{constructor({baseURL:e,maxRetries:t=2,timeout:s=6e5,httpAgent:r,fetch:i}){this.baseURL=e,this.maxRetries=mt("maxRetries",t),this.timeout=mt("timeout",s),this.httpAgent=r,this.fetch=i??ct}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Rs(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ns()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(async r=>{let i=r&&de(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:i}}))}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){e={...e};let{method:s,path:r,query:i,headers:o={}}=e,a=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:pt(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,f=this.calculateContentLength(a),h=this.buildURL(r,i);"timeout"in e&&mt("timeout",e.timeout),e.timeout=e.timeout??this.timeout;let p=e.httpAgent??this.httpAgent??ut(h),k=e.timeout+1e3;typeof p?.options?.timeout=="number"&&k>(p.options.timeout??0)&&(p.options.timeout=k),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);let F=this.buildHeaders({options:e,headers:o,contentLength:f,retryCount:t});return{req:{method:s,...a&&{body:a},headers:F,...p&&{agent:p},signal:e.signal??null},url:h,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:s,retryCount:r}){let i={};s&&(i["content-length"]=s);let o=this.defaultHeaders(e);return $t(i,o),$t(i,t),pt(e.body)&&j!=="node"&&delete i["content-type"],Ie(o,"x-stainless-retry-count")===void 0&&Ie(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(r)),Ie(o,"x-stainless-timeout")===void 0&&Ie(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(i,t),i}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new c("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,s,r){return m.generate(e,t,s,r)}request(e,t=null){return new Fe(this.makeRequest(e,t))}async makeRequest(e,t){let s=await e,r=s.maxRetries??this.maxRetries;t==null&&(t=r),await this.prepareOptions(s);let{req:i,url:o,timeout:a}=this.buildRequest(s,{retryCount:r-t});if(await this.prepareRequest(i,{url:o,options:s}),G("request",o,s,i.headers),s.signal?.aborted)throw new y;let f=new AbortController,h=await this.fetchWithTimeout(o,i,a,f).catch(Re);if(h instanceof Error){if(s.signal?.aborted)throw new y;if(t)return this.retryRequest(s,t);throw h.name==="AbortError"?new J:new N({cause:h})}let p=dt(h.headers);if(!h.ok){if(t&&this.shouldRetry(h)){let ot=`retrying, ${t} attempts remaining`;return G(`response (error; ${ot})`,h.status,o,p),this.retryRequest(s,t,p)}let k=await h.text().catch(ot=>Re(ot).message),F=Ts(k),it=F?void 0:k;throw G(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,h.status,o,p,it),this.makeStatusError(h.status,F,it,p)}return{response:h,options:s,controller:f}}requestAPIList(e,t){let s=this.makeRequest(t,null);return new gt(this,s,e)}buildURL(e,t){let s=Is(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return fe(r)||(t={...r,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s<"u").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new c(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,s,r){let{signal:i,...o}=t||{};i&&i.addEventListener("abort",()=>r.abort());let a=setTimeout(()=>r.abort(),s),f={signal:r.signal,...o};f.method&&(f.method=f.method.toUpperCase());let h=60*1e3,p=setTimeout(()=>{if(f&&f?.agent?.sockets)for(let k of Object.values(f?.agent?.sockets).flat())k?.setKeepAlive&&k.setKeepAlive(!0,h)},h);return this.fetch.call(void 0,e,f).finally(()=>{clearTimeout(a),clearTimeout(p)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s){let r,i=s?.["retry-after-ms"];if(i){let a=parseFloat(i);Number.isNaN(a)||(r=a)}let o=s?.["retry-after"];if(o&&!r){let a=parseFloat(o);Number.isNaN(a)?r=Date.parse(o)-Date.now():r=a*1e3}if(!(r&&0<=r&&r<60*1e3)){let a=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,a)}return await Fs(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,o=Math.min(.5*Math.pow(2,i),8),a=1-Math.random()*.25;return o*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${q}`}},Oe=class{constructor(e,t,s,r){Be.set(this,void 0),Ps(this,Be,e,"f"),this.options=r,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new c("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let s=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[r,i]of s)e.url.searchParams.set(r,i);t.query=void 0,t.path=e.url.toString()}return await Ms(this,Be,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Be=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},gt=class extends Fe{constructor(e,t,s){super(t,async r=>new s(e,r.response,await qt(r),r.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},dt=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let s=t.toString();return e[s.toLowerCase()]||e[s]}}),Cs={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},x=n=>typeof n=="object"&&n!==null&&!fe(n)&&Object.keys(n).every(e=>Ut(Cs,e)),As=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":q,"X-Stainless-OS":Dt(Deno.build.os),"X-Stainless-Arch":Ot(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":q,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":q,"X-Stainless-OS":Dt(process.platform),"X-Stainless-Arch":Ot(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=vs();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":q,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":q,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function vs(){if(typeof navigator>"u"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let s=t.exec(navigator.userAgent);if(s){let r=s[1]||0,i=s[2]||0,o=s[3]||0;return{browser:e,version:`${r}.${i}.${o}`}}}return null}var Ot=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Dt=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Lt,Rs=()=>Lt??(Lt=As()),Ts=n=>{try{return JSON.parse(n)}catch{return}},Bs=/^[a-z][a-z0-9+.-]*:/i,Is=n=>Bs.test(n),Fs=n=>new Promise(e=>setTimeout(e,n)),mt=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new c(`${n} must be an integer`);if(e<0)throw new c(`${n} must be a positive integer`);return e},Re=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(String(n))};var De=n=>{if(typeof process<"u")return process.env?.[n]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(n)?.trim()};function fe(n){if(!n)return!0;for(let e in n)return!1;return!0}function Ut(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function $t(n,e){for(let t in e){if(!Ut(e,t))continue;let s=t.toLowerCase();if(!s)continue;let r=e[t];r===null?delete n[s]:r!==void 0&&(n[s]=r)}}function G(n,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`Anthropic:DEBUG:${n}`,...e)}var Ns=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Ht=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Os=n=>typeof n?.get=="function";var Ie=(n,e)=>{let t=e.toLowerCase();if(Os(n)){let s=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(r,i,o)=>i+o.toUpperCase());for(let r of[e,t,e.toUpperCase(),s]){let i=n.get(r);if(i)return i}}for(let[s,r]of Object.entries(n))if(s.toLowerCase()===t)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${e} header, using the first entry.`),r[0]):r};var C=class extends Oe{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){if(this.options.query?.before_id){let t=this.first_id;return t?{params:{before_id:t}}:null}let e=this.last_id;return e?{params:{after_id:e}}:null}};var g=class{constructor(e){this._client=e}};var H=class extends g{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return x(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",z,{query:e,...t})}},z=class extends C{};H.BetaModelInfosPage=z;var Q=class n{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new R;for await(let t of this.iterator)for(let s of e.decode(t))yield JSON.parse(s);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new c("Attempted to iterate over a response with no body");return new n(he(e.body),t)}};var W=class extends g{create(e,t){let{betas:s,...r}=e;return this._client.post("/v1/messages/batches?beta=true",{body:r,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}retrieve(e,t={},s){if(x(t))return this.retrieve(e,{},t);let{betas:r}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}list(e={},t){if(x(e))return this.list({},e);let{betas:s,...r}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",Y,{query:r,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}delete(e,t={},s){if(x(t))return this.delete(e,{},t);let{betas:r}=t;return this._client.delete(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}cancel(e,t={},s){if(x(t))return this.cancel(e,{},t);let{betas:r}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...s,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}async results(e,t={},s){if(x(t))return this.results(e,{},t);let r=await this.retrieve(e);if(!r.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);let{betas:i}=t;return this._client.get(r.results_url,{...s,headers:{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...s?.headers},__binaryResponse:!0})._thenUnwrap((o,a)=>Q.fromResponse(a.response,a.controller))}},Y=class extends C{};W.BetaMessageBatchesPage=Y;var qs=n=>{let e=0,t=[];for(;e<n.length;){let s=n[e];if(s==="\\"){e++;continue}if(s==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(s==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(s==="["){t.push({type:"paren",value:"["}),e++;continue}if(s==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(s===":"){t.push({type:"separator",value:":"}),e++;continue}if(s===","){t.push({type:"delimiter",value:","}),e++;continue}if(s==='"'){let a="",f=!1;for(s=n[++e];s!=='"';){if(e===n.length){f=!0;break}if(s==="\\"){if(e++,e===n.length){f=!0;break}a+=s+n[e],s=n[++e]}else a+=s,s=n[++e]}s=n[++e],f||t.push({type:"string",value:a});continue}if(s&&/\s/.test(s)){e++;continue}let i=/[0-9]/;if(s&&i.test(s)||s==="-"||s==="."){let a="";for(s==="-"&&(a+=s,s=n[++e]);s&&i.test(s)||s===".";)a+=s,s=n[++e];t.push({type:"number",value:a});continue}let o=/[a-z]/i;if(s&&o.test(s)){let a="";for(;s&&o.test(s)&&e!==n.length;)a+=s,s=n[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},Z=n=>{if(n.length===0)return n;let e=n[n.length-1];switch(e.type){case"separator":return n=n.slice(0,n.length-1),Z(n);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return n=n.slice(0,n.length-1),Z(n);case"string":let s=n[n.length-2];if(s?.type==="delimiter")return n=n.slice(0,n.length-1),Z(n);if(s?.type==="brace"&&s.value==="{")return n=n.slice(0,n.length-1),Z(n);break;case"delimiter":return n=n.slice(0,n.length-1),Z(n);break}return n},js=n=>{let e=[];return n.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?n.push({type:"brace",value:"}"}):t==="]"&&n.push({type:"paren",value:"]"})}),n},Us=n=>{let e="";return n.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Le=n=>JSON.parse(Us(js(Z(qs(n)))));var w=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},l=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},E,O,pe,$e,me,ge,qe,ye,T,we,je,Ue,ee,He,We,yt,Wt,wt,bt,_t,xt,Vt,Kt="__json_buf",Ve=class n{constructor(){E.add(this),this.messages=[],this.receivedMessages=[],O.set(this,void 0),this.controller=new AbortController,pe.set(this,void 0),$e.set(this,()=>{}),me.set(this,()=>{}),ge.set(this,void 0),qe.set(this,()=>{}),ye.set(this,()=>{}),T.set(this,{}),we.set(this,!1),je.set(this,!1),Ue.set(this,!1),ee.set(this,!1),He.set(this,void 0),We.set(this,void 0),wt.set(this,e=>{if(w(this,je,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new y),e instanceof y)return w(this,Ue,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),w(this,pe,new Promise((e,t)=>{w(this,$e,e,"f"),w(this,me,t,"f")}),"f"),w(this,ge,new Promise((e,t)=>{w(this,qe,e,"f"),w(this,ye,t,"f")}),"f"),l(this,pe,"f").catch(()=>{}),l(this,ge,"f").catch(()=>{})}get response(){return l(this,He,"f")}get request_id(){return l(this,We,"f")}async withResponse(){let e=await l(this,pe,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let r=new n;for(let i of t.messages)r._addMessageParam(i);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,wt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),l(this,E,"m",bt).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(i);for await(let a of o)l(this,E,"m",_t).call(this,a);if(o.controller.signal?.aborted)throw new y;l(this,E,"m",xt).call(this)}_connected(e){this.ended||(w(this,He,e,"f"),w(this,We,e?.headers.get("request-id"),"f"),l(this,$e,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,we,"f")}get errored(){return l(this,je,"f")}get aborted(){return l(this,Ue,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,T,"f")[e]||(l(this,T,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=l(this,T,"f")[e];if(!s)return this;let r=s.findIndex(i=>i.listener===t);return r>=0&&s.splice(r,1),this}once(e,t){return(l(this,T,"f")[e]||(l(this,T,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{w(this,ee,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){w(this,ee,!0,"f"),await l(this,ge,"f")}get currentMessage(){return l(this,O,"f")}async finalMessage(){return await this.done(),l(this,E,"m",yt).call(this)}async finalText(){return await this.done(),l(this,E,"m",Wt).call(this)}_emit(e,...t){if(l(this,we,"f"))return;e==="end"&&(w(this,we,!0,"f"),l(this,qe,"f").call(this));let s=l(this,T,"f")[e];if(s&&(l(this,T,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!l(this,ee,"f")&&!s?.length&&Promise.reject(r),l(this,me,"f").call(this,r),l(this,ye,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!l(this,ee,"f")&&!s?.length&&Promise.reject(r),l(this,me,"f").call(this,r),l(this,ye,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,E,"m",yt).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,E,"m",bt).call(this),this._connected(null);let r=M.fromReadableStream(e,this.controller);for await(let i of r)l(this,E,"m",_t).call(this,i);if(r.controller.signal?.aborted)throw new y;l(this,E,"m",xt).call(this)}[(O=new WeakMap,pe=new WeakMap,$e=new WeakMap,me=new WeakMap,ge=new WeakMap,qe=new WeakMap,ye=new WeakMap,T=new WeakMap,we=new WeakMap,je=new WeakMap,Ue=new WeakMap,ee=new WeakMap,He=new WeakMap,We=new WeakMap,wt=new WeakMap,E=new WeakSet,yt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Wt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},bt=function(){this.ended||w(this,O,void 0,"f")},_t=function(t){if(this.ended)return;let s=l(this,E,"m",Vt).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let r=s.content.at(-1);switch(t.delta.type){case"text_delta":{r.type==="text"&&this._emit("text",t.delta.text,r.text||"");break}case"citations_delta":{r.type==="text"&&this._emit("citation",t.delta.citation,r.citations??[]);break}case"input_json_delta":{r.type==="tool_use"&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"thinking_delta":{r.type==="thinking"&&this._emit("thinking",t.delta.thinking,r.thinking);break}case"signature_delta":{r.type==="thinking"&&this._emit("signature",r.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{w(this,O,s,"f");break}case"content_block_start":case"message_delta":break}},xt=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=l(this,O,"f");if(!t)throw new c("request ended without sending any chunks");return w(this,O,void 0,"f"),t},Vt=function(t){let s=l(this,O,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let r=s.content.at(t.index);switch(t.delta.type){case"text_delta":{r?.type==="text"&&(r.text+=t.delta.text);break}case"citations_delta":{r?.type==="text"&&(r.citations??(r.citations=[]),r.citations.push(t.delta.citation));break}case"input_json_delta":{if(r?.type==="tool_use"){let i=r[Kt]||"";i+=t.delta.partial_json,Object.defineProperty(r,Kt,{value:i,enumerable:!1,writable:!0}),i&&(r.input=Le(i))}break}case"thinking_delta":{r?.type==="thinking"&&(r.thinking+=t.delta.thinking);break}case"signature_delta":{r?.type==="thinking"&&(r.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new M(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Xt={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"},D=class extends g{constructor(){super(...arguments),this.batches=new W(this._client)}create(e,t){let{betas:s,...r}=e;return r.model in Xt&&console.warn(`The model '${r.model}' is deprecated and will reach end-of-life on ${Xt[r.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:r,timeout:this._client._options.timeout??(r.stream?6e5:this._client._calculateNonstreamingTimeout(r.max_tokens)),...t,headers:{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0,...t?.headers},stream:e.stream??!1})}stream(e,t){return Ve.createMessage(this,e,t)}countTokens(e,t){let{betas:s,...r}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:r,...t,headers:{"anthropic-beta":[...s??[],"token-counting-2024-11-01"].toString(),...t?.headers}})}};D.Batches=W;D.BetaMessageBatchesPage=Y;var A=class extends g{constructor(){super(...arguments),this.models=new H(this._client),this.messages=new D(this._client)}};A.Models=H;A.BetaModelInfosPage=z;A.Messages=D;var V=class extends g{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}};var K=class extends g{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return x(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",te,{query:e,...t})}delete(e,t){return this._client.delete(`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let s=await this.retrieve(e);if(!s.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})._thenUnwrap((r,i)=>Q.fromResponse(i.response,i.controller))}},te=class extends C{};K.MessageBatchesPage=te;var b=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},u=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},S,L,be,Ke,_e,xe,Xe,Ee,B,Se,Je,Ge,se,ze,Qe,Et,Jt,St,kt,Pt,Mt,Gt,zt="__json_buf",Ye=class n{constructor(){S.add(this),this.messages=[],this.receivedMessages=[],L.set(this,void 0),this.controller=new AbortController,be.set(this,void 0),Ke.set(this,()=>{}),_e.set(this,()=>{}),xe.set(this,void 0),Xe.set(this,()=>{}),Ee.set(this,()=>{}),B.set(this,{}),Se.set(this,!1),Je.set(this,!1),Ge.set(this,!1),se.set(this,!1),ze.set(this,void 0),Qe.set(this,void 0),St.set(this,e=>{if(b(this,Je,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new y),e instanceof y)return b(this,Ge,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),b(this,be,new Promise((e,t)=>{b(this,Ke,e,"f"),b(this,_e,t,"f")}),"f"),b(this,xe,new Promise((e,t)=>{b(this,Xe,e,"f"),b(this,Ee,t,"f")}),"f"),u(this,be,"f").catch(()=>{}),u(this,xe,"f").catch(()=>{})}get response(){return u(this,ze,"f")}get request_id(){return u(this,Qe,"f")}async withResponse(){let e=await u(this,be,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let r=new n;for(let i of t.messages)r._addMessageParam(i);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},u(this,St,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),u(this,S,"m",kt).call(this);let{response:i,data:o}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(i);for await(let a of o)u(this,S,"m",Pt).call(this,a);if(o.controller.signal?.aborted)throw new y;u(this,S,"m",Mt).call(this)}_connected(e){this.ended||(b(this,ze,e,"f"),b(this,Qe,e?.headers.get("request-id"),"f"),u(this,Ke,"f").call(this,e),this._emit("connect"))}get ended(){return u(this,Se,"f")}get errored(){return u(this,Je,"f")}get aborted(){return u(this,Ge,"f")}abort(){this.controller.abort()}on(e,t){return(u(this,B,"f")[e]||(u(this,B,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=u(this,B,"f")[e];if(!s)return this;let r=s.findIndex(i=>i.listener===t);return r>=0&&s.splice(r,1),this}once(e,t){return(u(this,B,"f")[e]||(u(this,B,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{b(this,se,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){b(this,se,!0,"f"),await u(this,xe,"f")}get currentMessage(){return u(this,L,"f")}async finalMessage(){return await this.done(),u(this,S,"m",Et).call(this)}async finalText(){return await this.done(),u(this,S,"m",Jt).call(this)}_emit(e,...t){if(u(this,Se,"f"))return;e==="end"&&(b(this,Se,!0,"f"),u(this,Xe,"f").call(this));let s=u(this,B,"f")[e];if(s&&(u(this,B,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!u(this,se,"f")&&!s?.length&&Promise.reject(r),u(this,_e,"f").call(this,r),u(this,Ee,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!u(this,se,"f")&&!s?.length&&Promise.reject(r),u(this,_e,"f").call(this,r),u(this,Ee,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",u(this,S,"m",Et).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),u(this,S,"m",kt).call(this),this._connected(null);let r=M.fromReadableStream(e,this.controller);for await(let i of r)u(this,S,"m",Pt).call(this,i);if(r.controller.signal?.aborted)throw new y;u(this,S,"m",Mt).call(this)}[(L=new WeakMap,be=new WeakMap,Ke=new WeakMap,_e=new WeakMap,xe=new WeakMap,Xe=new WeakMap,Ee=new WeakMap,B=new WeakMap,Se=new WeakMap,Je=new WeakMap,Ge=new WeakMap,se=new WeakMap,ze=new WeakMap,Qe=new WeakMap,St=new WeakMap,S=new WeakSet,Et=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Jt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},kt=function(){this.ended||b(this,L,void 0,"f")},Pt=function(t){if(this.ended)return;let s=u(this,S,"m",Gt).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let r=s.content.at(-1);switch(t.delta.type){case"text_delta":{r.type==="text"&&this._emit("text",t.delta.text,r.text||"");break}case"citations_delta":{r.type==="text"&&this._emit("citation",t.delta.citation,r.citations??[]);break}case"input_json_delta":{r.type==="tool_use"&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"thinking_delta":{r.type==="thinking"&&this._emit("thinking",t.delta.thinking,r.thinking);break}case"signature_delta":{r.type==="thinking"&&this._emit("signature",r.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{b(this,L,s,"f");break}case"content_block_start":case"message_delta":break}},Mt=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=u(this,L,"f");if(!t)throw new c("request ended without sending any chunks");return b(this,L,void 0,"f"),t},Gt=function(t){let s=u(this,L,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let r=s.content.at(t.index);switch(t.delta.type){case"text_delta":{r?.type==="text"&&(r.text+=t.delta.text);break}case"citations_delta":{r?.type==="text"&&(r.citations??(r.citations=[]),r.citations.push(t.delta.citation));break}case"input_json_delta":{if(r?.type==="tool_use"){let i=r[zt]||"";i+=t.delta.partial_json,Object.defineProperty(r,zt,{value:i,enumerable:!1,writable:!0}),i&&(r.input=Le(i))}break}case"thinking_delta":{r?.type==="thinking"&&(r.thinking+=t.delta.thinking);break}case"signature_delta":{r?.type==="thinking"&&(r.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new M(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var I=class extends g{constructor(){super(...arguments),this.batches=new K(this._client)}create(e,t){return e.model in Qt&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Qt[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??(e.stream?6e5:this._client._calculateNonstreamingTimeout(e.max_tokens)),...t,stream:e.stream??!1})}stream(e,t){return Ye.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},Qt={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};I.Batches=K;I.MessageBatchesPage=te;var $=class extends g{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return x(e)?this.list({},e):this._client.getAPIList("/v1/models",X,{query:e,...t})}},X=class extends C{};$.ModelInfosPage=X;var Yt,d=class extends Ne{constructor({baseURL:e=De("ANTHROPIC_BASE_URL"),apiKey:t=De("ANTHROPIC_API_KEY")??null,authToken:s=De("ANTHROPIC_AUTH_TOKEN")??null,...r}={}){let i={apiKey:t,authToken:s,...r,baseURL:e||"https://api.anthropic.com"};if(!i.dangerouslyAllowBrowser&&Ht())throw new c(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new V(this),this.messages=new I(this),this.models=new $(this),this.beta=new A(this),this._options=i,this.apiKey=t,this.authToken=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){let t=this.apiKeyAuth(e),s=this.bearerAuth(e);return t!=null&&!fe(t)?t:s!=null&&!fe(s)?s:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}};Yt=d;d.Anthropic=Yt;d.HUMAN_PROMPT=`

Human:`;d.AI_PROMPT=`

Assistant:`;d.DEFAULT_TIMEOUT=6e5;d.AnthropicError=c;d.APIError=m;d.APIConnectionError=N;d.APIConnectionTimeoutError=J;d.APIUserAbortError=y;d.NotFoundError=oe;d.ConflictError=ae;d.RateLimitError=le;d.BadRequestError=re;d.AuthenticationError=ne;d.InternalServerError=ue;d.PermissionDeniedError=ie;d.UnprocessableEntityError=ce;d.toFile=Nt;d.fileFromPath=Ae;d.Completions=V;d.Messages=I;d.Models=$;d.ModelInfosPage=X;d.Beta=A;var{HUMAN_PROMPT:vn,AI_PROMPT:Rn}=d,Zt=d;var Ze=class{client=null;settings;constructor(e){this.settings=e,this.initClient()}initClient(){this.settings.apiKey&&(this.client=new Zt({apiKey:this.settings.apiKey,dangerouslyAllowBrowser:!0}))}updateSettings(e){this.settings=e,this.initClient()}isConfigured(){return!!this.client&&!!this.settings.apiKey}async sendMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let r=e.map(a=>({role:a.role,content:a.content}));if(this.settings.streamResponses&&s)return this.streamMessage(r,t,s);let o=(await this.client.messages.create({model:this.settings.model,max_tokens:4096,system:t,messages:r})).content.find(a=>a.type==="text");return o?.type==="text"?o.text:""}async streamMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let r="",i=this.client.messages.stream({model:this.settings.model,max_tokens:4096,system:t,messages:e});for await(let o of i)if(o.type==="content_block_delta"&&o.delta.type==="text_delta"){let a=o.delta.text;r+=a,s(a)}return r}};var et=class{settings;preferences=[];constructor(e){this.settings=e}updateSettings(e){this.settings=e}async loadPreferences(){return this.preferences=[{id:"cotton-react",name:"Cotton React Conventions",priority:100,tags:["react","typescript"],content:`## React Conventions

- Use named exports, not default exports
- Use function declarations with forwardRef
- Add displayName for debugging
- Use semantic tokens, never primitives

## Example

\`\`\`tsx
export const CottonButton = forwardRef<HTMLButtonElement, Props>(
  function CottonButton(props, ref) {
    return <button ref={ref} {...props} />;
  }
);
CottonButton.displayName = 'CottonButton';
\`\`\``},{id:"cotton-tokens",name:"Cotton Design Tokens",priority:100,tags:["css","tokens"],content:"## Design Tokens\n\nAlways use semantic tokens:\n- `--cotton-color-text-primary` (not `--cotton-color-gray-900`)\n- `--cotton-color-action-primary` (not `--cotton-color-blue-500`)\n- `--cotton-spacing-4` (not `16px`)\n\n## BEM Naming\n\n```css\n.cotton-btn { }           /* Block */\n.cotton-btn--primary { }  /* Modifier */\n.cotton-btn__icon { }     /* Element */\n```"}],this.preferences}formatForSystemPrompt(){return this.preferences.length===0?"":`## Cotton AI Preferences

The following coding standards and conventions should be followed:

${this.preferences.sort((t,s)=>s.priority-t.priority).map(t=>`### ${t.name}

${t.content}`).join(`

---

`)}`}};var tt=class{app;settings;constructor(e,t){this.app=e,this.settings=t}updateSettings(e){this.settings=e}async buildContext(e,t){if(!e)return null;let s=await this.app.vault.read(e),r=this.app.metadataCache.getFileCache(e)?.frontmatter,i={path:e.path,name:e.basename,content:this.truncateContent(s),frontmatter:r,selection:t};return this.settings.includeBacklinks&&(i.backlinks=this.getBacklinks(e)),i}truncateContent(e){let t=e.split(`
`);return t.length<=this.settings.contextLines?e:t.slice(0,this.settings.contextLines).join(`
`)+`

[...truncated]`}getBacklinks(e){let t=[],s=this.app.metadataCache.resolvedLinks;for(let[r,i]of Object.entries(s))i[e.path]&&t.push(r);return t.slice(0,10)}formatContextForPrompt(e){let t=`## Current Note: ${e.name}

`;return e.frontmatter&&(t+=`### Frontmatter
\`\`\`yaml
${JSON.stringify(e.frontmatter,null,2)}
\`\`\`

`),e.selection&&(t+=`### Selected Text
\`\`\`
${e.selection}
\`\`\`

`),t+=`### Content
\`\`\`markdown
${e.content}
\`\`\`
`,e.backlinks&&e.backlinks.length>0&&(t+=`
### Backlinks
${e.backlinks.map(s=>`- [[${s}]]`).join(`
`)}
`),t}};var v=require("obsidian"),st=class extends v.Modal{plugin;editor;context;inputEl=null;responseEl=null;constructor(e,t,s,r){super(e),this.plugin=t,this.editor=s,this.context=r}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-ask-claude-modal"),e.createEl("h2",{text:"Ask Claude"}),this.context&&e.createEl("p",{text:`Context: ${this.context.name}`,cls:"cotton-context-label"});let t=e.createDiv({cls:"cotton-input-container"});if(this.inputEl=new v.TextAreaComponent(t),this.inputEl.inputEl.addClass("cotton-input"),this.inputEl.setPlaceholder("Ask a question about this note..."),this.inputEl.inputEl.rows=3,this.context?.selection){let o=e.createDiv({cls:"cotton-selection-preview"});o.createEl("strong",{text:"Selected: "}),o.createEl("code",{text:this.context.selection.length>100?this.context.selection.slice(0,100)+"...":this.context.selection})}let s=e.createDiv({cls:"cotton-button-container"});s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),s.createEl("button",{text:"Ask",cls:"mod-cta"}).addEventListener("click",()=>this.handleAsk()),this.responseEl=e.createDiv({cls:"cotton-response"}),this.responseEl.style.display="none",this.inputEl.inputEl.focus(),this.inputEl.inputEl.addEventListener("keydown",o=>{o.key==="Enter"&&(o.metaKey||o.ctrlKey)&&this.handleAsk()})}async handleAsk(){let e=this.inputEl?.getValue();if(!e?.trim()){new v.Notice("Please enter a question");return}if(!this.plugin.claude.isConfigured()){new v.Notice("Claude API key not configured. Check settings.");return}this.responseEl&&(this.responseEl.style.display="block",this.responseEl.empty(),this.responseEl.createEl("p",{text:"Thinking...",cls:"cotton-thinking"}));try{let t=this.plugin.preferences.formatForSystemPrompt(),s=this.context?this.plugin.contextBuilder.formatContextForPrompt(this.context):"",r=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${t}

${s}

Respond concisely and helpfully. Use markdown formatting.`,i=[{role:"user",content:e,timestamp:Date.now()}],o="";if(this.responseEl&&this.responseEl.empty(),o=await this.plugin.claude.sendMessage(i,r,a=>{this.responseEl&&(this.responseEl.textContent=(this.responseEl.textContent||"")+a)}),this.responseEl&&o){this.responseEl.empty();let a=this.responseEl.createDiv({cls:"cotton-response-content"});a.innerHTML=o}}catch(t){new v.Notice(`Error: ${t instanceof Error?t.message:"Unknown error"}`),this.responseEl&&(this.responseEl.empty(),this.responseEl.createEl("p",{text:`Error: ${t instanceof Error?t.message:"Unknown error"}`,cls:"cotton-error"}))}}onClose(){let{contentEl:e}=this;e.empty()}};function es(n){n.addCommand({id:"ask-claude",name:"Ask Claude",editorCallback:async(e,t)=>{let s=e.getSelection(),r=t.file,i=r?await n.contextBuilder.buildContext(r,s||void 0):null;new st(n.app,n,e,i).open()}}),n.addCommand({id:"ask-claude-general",name:"Ask Claude (General)",callback:async()=>{let t=n.app.workspace.getActiveViewOfType(v.MarkdownView)?.file||null,s=t?await n.contextBuilder.buildContext(t):null;new st(n.app,n,null,s).open()}})}var ke=require("obsidian"),Pe="cotton-chat-view",rt=class extends ke.ItemView{plugin;messages=[];inputEl=null;messagesEl=null;isLoading=!1;constructor(e,t){super(e),this.plugin=t}getViewType(){return Pe}getDisplayText(){return"Cotton AI"}getIcon(){return"circle"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("cotton-chat-container");let t=e.createDiv({cls:"cotton-chat-header"});t.createEl("h4",{text:"Cotton AI"});let s=t.createEl("span",{text:this.getModelName(),cls:"cotton-model-badge"});t.createEl("button",{text:"Clear",cls:"cotton-clear-btn"}).addEventListener("click",()=>this.clearChat()),this.messagesEl=e.createDiv({cls:"cotton-chat-messages"});let i=e.createDiv({cls:"cotton-chat-input-container"});this.inputEl=i.createEl("textarea",{cls:"cotton-chat-input",attr:{placeholder:"Ask Claude...",rows:"3"}}),this.inputEl.addEventListener("keydown",h=>{h.key==="Enter"&&(h.metaKey||h.ctrlKey)&&(h.preventDefault(),this.sendMessage())});let o=i.createDiv({cls:"cotton-chat-buttons"});o.createEl("button",{text:"Add Context",cls:"cotton-context-btn"}).addEventListener("click",()=>this.addCurrentNoteContext()),o.createEl("button",{text:"Send",cls:"mod-cta cotton-send-btn"}).addEventListener("click",()=>this.sendMessage()),await this.loadMessages()}async onClose(){await this.saveMessages()}getModelName(){let e=this.plugin.settings.model;return e.includes("sonnet")?"Sonnet 4":e.includes("opus")?"Opus 4":e.includes("haiku")?"Haiku 3.5":"Claude"}async sendMessage(){if(!this.inputEl||this.isLoading)return;let e=this.inputEl.value.trim();if(!e)return;if(!this.plugin.claude.isConfigured()){this.addSystemMessage("API key not configured. Check settings.");return}let t={role:"user",content:e,timestamp:Date.now()};this.messages.push(t),this.renderMessage(t),this.inputEl.value="",this.isLoading=!0;let s=this.addThinkingIndicator();try{let r=this.app.workspace.getActiveFile(),i=r?await this.plugin.contextBuilder.buildContext(r):null,o=this.plugin.preferences.formatForSystemPrompt(),a=i?this.plugin.contextBuilder.formatContextForPrompt(i):"",f=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${o}

${a}

Respond concisely and helpfully. Use markdown formatting.`,h="",p=this.messagesEl?.createDiv({cls:"cotton-message cotton-message-assistant"});s&&s.remove(),await this.plugin.claude.sendMessage(this.messages.filter(F=>F.role!=="system"),f,F=>{h+=F,p&&(p.textContent=h)}),p&&h&&(p.empty(),await ke.MarkdownRenderer.render(this.app,h,p,"",this.plugin));let k={role:"assistant",content:h,timestamp:Date.now()};this.messages.push(k),await this.saveToNote()}catch(r){s&&s.remove(),this.addSystemMessage(`Error: ${r instanceof Error?r.message:"Unknown error"}`)}finally{this.isLoading=!1}}renderMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:`cotton-message cotton-message-${e.role}`});e.role==="user"?t.textContent=e.content:ke.MarkdownRenderer.render(this.app,e.content,t,"",this.plugin),this.messagesEl.scrollTop=this.messagesEl.scrollHeight}addThinkingIndicator(){if(!this.messagesEl)return null;let e=this.messagesEl.createDiv({cls:"cotton-thinking"});return e.textContent="Thinking...",this.messagesEl.scrollTop=this.messagesEl.scrollHeight,e}addSystemMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:"cotton-message cotton-message-system"});t.textContent=e}async addCurrentNoteContext(){let e=this.app.workspace.getActiveFile();if(!e){this.addSystemMessage("No active note to add as context.");return}if(this.inputEl){let t=this.inputEl.value;this.inputEl.value=t+(t?`

`:"")+`[Context: ${e.basename}]`,this.inputEl.focus()}}clearChat(){this.messages=[],this.messagesEl&&this.messagesEl.empty()}async loadMessages(){let e=await this.plugin.loadData();e?.chatHistory&&(this.messages=e.chatHistory,this.messages.forEach(t=>this.renderMessage(t)))}async saveMessages(){let e=await this.plugin.loadData()||{};e.chatHistory=this.messages,await this.plugin.saveData(e)}async saveToNote(){if(this.messages.length===0)return;let e=this.plugin.settings.chatFolder||"Cotton/Chats",t=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),s=this.messages.find(a=>a.role==="user"),r=s?s.content.slice(0,30).replace(/[^a-zA-Z0-9 ]/g,"").trim():"chat",i=`${e}/${t}-${r}.md`,o=`# Cotton AI Chat

`;o+=`Date: ${new Date().toLocaleString()}
`,o+=`Model: ${this.getModelName()}

---

`;for(let a of this.messages)a.role==="user"?o+=`## Question

${a.content}

`:a.role==="assistant"&&(o+=`## Answer

${a.content}

---

`);try{let a=e;this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a);let f=this.app.vault.getAbstractFileByPath(i);f?await this.app.vault.modify(f,o):await this.app.vault.create(i,o)}catch(a){console.error("Failed to save chat to note:",a)}}};var Ct={apiKey:"",model:"claude-sonnet-4-20250514",personalPrefsPath:"",teamPrefsPath:"",streamResponses:!0,contextLines:100,includeBacklinks:!0,chatFolder:"Cotton/Chats"};var nt=class extends ts.Plugin{settings=Ct;claude;preferences;contextBuilder;async onload(){console.log("Loading Cotton AI plugin"),await this.loadSettings(),this.claude=new Ze(this.settings),this.preferences=new et(this.settings),this.contextBuilder=new tt(this.app,this.settings),await this.preferences.loadPreferences(),this.addSettingTab(new Me(this.app,this)),this.registerView(Pe,e=>new rt(e,this)),es(this),this.addCommand({id:"toggle-chat-panel",name:"Toggle Chat Panel",callback:()=>this.toggleChatPanel()}),this.addRibbonIcon("circle","Cotton AI",()=>{this.toggleChatPanel()}),console.log("Cotton AI plugin loaded")}async toggleChatPanel(){let e=this.app.workspace.getLeavesOfType(Pe);if(e.length>0){let t=e[0];t.view.containerEl.isShown()?t.detach():this.app.workspace.revealLeaf(t)}else{let t=this.app.workspace.getLeftLeaf(!1);t&&(await t.setViewState({type:Pe,active:!0}),this.app.workspace.revealLeaf(t))}}onunload(){console.log("Unloading Cotton AI plugin")}async loadSettings(){this.settings=Object.assign({},Ct,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.claude.updateSettings(this.settings),this.preferences.updateSettings(this.settings),this.contextBuilder.updateSettings(this.settings)}};
