"use strict";var lt=Object.defineProperty;var rs=Object.getOwnPropertyDescriptor;var os=Object.getOwnPropertyNames;var is=Object.prototype.hasOwnProperty;var as=(r,e)=>{for(var t in e)lt(r,t,{get:e[t],enumerable:!0})},cs=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of os(e))!is.call(r,n)&&n!==t&&lt(r,n,{get:()=>e[n],enumerable:!(s=rs(e,n))||s.enumerable});return r};var ls=r=>cs(lt({},"__esModule",{value:!0}),r);var Js={};as(Js,{default:()=>it});module.exports=ls(Js);var ns=require("obsidian");var P=require("obsidian"),Ce=class extends P.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Cotton AI Settings"});let s=new P.Setting(e).setName("Claude API Key").addText(n=>n.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.apiKey).onChange(async o=>{this.plugin.settings.apiKey=o,await this.plugin.saveSettings()})).descEl.createDiv();s.appendText("Your Anthropic API key. "),s.createEl("a",{text:"Get your API key",href:"https://console.anthropic.com/settings/keys"}),new P.Setting(e).setName("Model").setDesc("Claude model to use for responses").addDropdown(n=>n.addOption("claude-sonnet-4-20250514","Claude Sonnet 4 (Recommended)").addOption("claude-opus-4-20250514","Claude Opus 4 (Most capable)").addOption("claude-3-5-haiku-20241022","Claude 3.5 Haiku (Fastest)").setValue(this.plugin.settings.model).onChange(async o=>{this.plugin.settings.model=o,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Preferences"}),new P.Setting(e).setName("Personal Preferences Path").setDesc("Path to your personal Cotton preferences (e.g., ~/.cotton/preferences)").addText(n=>n.setPlaceholder("~/.cotton/preferences").setValue(this.plugin.settings.personalPrefsPath).onChange(async o=>{this.plugin.settings.personalPrefsPath=o,await this.plugin.saveSettings()})),new P.Setting(e).setName("Team Preferences Path").setDesc("Path to team Cotton preferences (e.g., .cotton/preferences)").addText(n=>n.setPlaceholder(".cotton/preferences").setValue(this.plugin.settings.teamPrefsPath).onChange(async o=>{this.plugin.settings.teamPrefsPath=o,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Behavior"}),new P.Setting(e).setName("Stream Responses").setDesc("Show responses as they are generated").addToggle(n=>n.setValue(this.plugin.settings.streamResponses).onChange(async o=>{this.plugin.settings.streamResponses=o,await this.plugin.saveSettings()})),new P.Setting(e).setName("Context Lines").setDesc("Number of lines from current note to include as context").addSlider(n=>n.setLimits(0,500,10).setValue(this.plugin.settings.contextLines).setDynamicTooltip().onChange(async o=>{this.plugin.settings.contextLines=o,await this.plugin.saveSettings()})),new P.Setting(e).setName("Include Backlinks").setDesc("Include backlink information in context").addToggle(n=>n.setValue(this.plugin.settings.includeBacklinks).onChange(async o=>{this.plugin.settings.includeBacklinks=o,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Storage"}),new P.Setting(e).setName("Chat Folder").setDesc("Folder to save chat conversations and responses").addText(n=>n.setPlaceholder("Cotton/Chats").setValue(this.plugin.settings.chatFolder).onChange(async o=>{this.plugin.settings.chatFolder=o,await this.plugin.saveSettings()}))}};var U="0.39.0";var Rt=!1,H,ut,us,ds,hs,Tt,ps,Me,dt,Bt,ht,Ae,It;function Ft(r,e={auto:!1}){if(Rt)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${r.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(H)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${r.kind}'\` after \`import '@anthropic-ai/sdk/shims/${H}'\``);Rt=e.auto,H=r.kind,ut=r.fetch,us=r.Request,ds=r.Response,hs=r.Headers,Tt=r.FormData,ps=r.Blob,Me=r.File,dt=r.ReadableStream,Bt=r.getMultipartRequestOptions,ht=r.getDefaultAgent,Ae=r.fileFromPath,It=r.isFsReadStream}var Re=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Nt({manuallyImported:r}={}){let e=r?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n",t,s,n,o;try{t=fetch,s=Request,n=Response,o=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:s,Response:n,Headers:o,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,a)=>({...a,body:new Re(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:i=>!1}}H||Ft(Nt(),{auto:!0});var c=class extends Error{},g=class r extends c{constructor(e,t,s,n){super(`${r.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.request_id=n?.["request-id"],this.error=t}static makeMessage(e,t,s){let n=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new D({message:s,cause:Te(t)});let o=t;return e===400?new oe(e,o,s,n):e===401?new ie(e,o,s,n):e===403?new ae(e,o,s,n):e===404?new ce(e,o,s,n):e===409?new le(e,o,s,n):e===422?new ue(e,o,s,n):e===429?new de(e,o,s,n):e>=500?new he(e,o,s,n):new r(e,o,s,n)}},w=class extends g{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},D=class extends g{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},z=class extends D{constructor({message:e}={}){super({message:e??"Request timed out."})}},oe=class extends g{},ie=class extends g{},ae=class extends g{},ce=class extends g{},le=class extends g{},ue=class extends g{},de=class extends g{},he=class extends g{};var Be=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},W=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},_,B=class{constructor(){_.set(this,void 0),this.buffer=new Uint8Array,Be(this,_,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,s=new Uint8Array(this.buffer.length+t.length);s.set(this.buffer),s.set(t,this.buffer.length),this.buffer=s;let n=[],o;for(;(o=gs(this.buffer,W(this,_,"f")))!=null;){if(o.carriage&&W(this,_,"f")==null){Be(this,_,o.index,"f");continue}if(W(this,_,"f")!=null&&(o.index!==W(this,_,"f")+1||o.carriage)){n.push(this.decodeText(this.buffer.slice(0,W(this,_,"f")-1))),this.buffer=this.buffer.slice(W(this,_,"f")),Be(this,_,null,"f");continue}let i=W(this,_,"f")!==null?o.preceding-1:o.preceding,a=this.decodeText(this.buffer.slice(0,i));n.push(a),this.buffer=this.buffer.slice(o.index),Be(this,_,null,"f")}return n}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new c(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new c(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new c("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};_=new WeakMap;B.NEWLINE_CHARS=new Set([`
`,"\r"]);B.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function gs(r,e){for(let n=e??0;n<r.length;n++){if(r[n]===10)return{preceding:n,index:n+1,carriage:!1};if(r[n]===13)return{preceding:n,index:n+1,carriage:!0}}return null}function $t(r){for(let s=0;s<r.length-1;s++){if(r[s]===10&&r[s+1]===10||r[s]===13&&r[s+1]===13)return s+2;if(r[s]===13&&r[s+1]===10&&s+3<r.length&&r[s+2]===13&&r[s+3]===10)return s+4}return-1}function pe(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var C=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;async function*n(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(let i of ys(e,t)){if(i.event==="completion")try{yield JSON.parse(i.data)}catch(a){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),a}if(i.event==="message_start"||i.event==="message_delta"||i.event==="message_stop"||i.event==="content_block_start"||i.event==="content_block_delta"||i.event==="content_block_stop")try{yield JSON.parse(i.data)}catch(a){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),a}if(i.event!=="ping"&&i.event==="error")throw g.generate(void 0,`SSE Error: ${i.data}`,i.data,ft(e.headers))}o=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{o||t.abort()}}return new r(n,t)}static fromReadableStream(e,t){let s=!1;async function*n(){let i=new B,a=pe(e);for await(let h of a)for(let d of i.decode(h))yield d;for(let h of i.flush())yield h}async function*o(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let i=!1;try{for await(let a of n())i||a&&(yield JSON.parse(a));i=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{i||t.abort()}}return new r(o,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],s=this.iterator(),n=o=>({next:()=>{if(o.length===0){let i=s.next();e.push(i),t.push(i)}return o.shift()}});return[new r(()=>n(e),this.controller),new r(()=>n(t),this.controller)]}toReadableStream(){let e=this,t,s=new TextEncoder;return new dt({async start(){t=e[Symbol.asyncIterator]()},async pull(n){try{let{value:o,done:i}=await t.next();if(i)return n.close();let a=s.encode(JSON.stringify(o)+`
`);n.enqueue(a)}catch(o){n.error(o)}},async cancel(){await t.return?.()}})}};async function*ys(r,e){if(!r.body)throw e.abort(),new c("Attempted to iterate over a response with no body");let t=new pt,s=new B,n=pe(r.body);for await(let o of ws(n))for(let i of s.decode(o)){let a=t.decode(i);a&&(yield a)}for(let o of s.flush()){let i=t.decode(o);i&&(yield i)}}async function*ws(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,n=new Uint8Array(e.length+s.length);n.set(e),n.set(s,e.length),e=n;let o;for(;(o=$t(e))!==-1;)yield e.slice(0,o),e=e.slice(o)}e.length>0&&(yield e)}var pt=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let o={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],o}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=bs(e,":");return n.startsWith(" ")&&(n=n.substring(1)),t==="event"?this.event=n:t==="data"&&this.data.push(n),null}};function bs(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}var xs=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",_s=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&fe(r),fe=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function";async function Dt(r,e,t){if(r=await r,_s(r))return r;if(xs(r)){let n=await r.blob();e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file");let o=fe(n)?[await n.arrayBuffer()]:[n];return new Me(o,e,t)}let s=await Es(r);if(e||(e=vs(r)??"unknown_file"),!t?.type){let n=s[0]?.type;typeof n=="string"&&(t={...t,type:n})}return new Me(s,e,t)}async function Es(r){let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(fe(r))e.push(await r.arrayBuffer());else if(ks(r))for await(let t of r)e.push(t);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${r?.constructor?.name}; props: ${Ss(r)}`);return e}function Ss(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function vs(r){return mt(r.name)||mt(r.filename)||mt(r.path)?.split(/[\\/]/).pop()}var mt=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},ks=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",gt=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody";var Cs=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},Ms=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},Ie;async function Ut(r){let{response:e}=r;if(r.options.stream)return Q("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):C.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let o=await e.json();return Q("response",e.status,e.url,e.headers,o),Ht(o,e)}let n=await e.text();return Q("response",e.status,e.url,e.headers,n),n}function Ht(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var Ne=class r extends Promise{constructor(e,t=Ut){super(s=>{s(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new r(this.responsePromise,async t=>Ht(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},$e=class{constructor({baseURL:e,maxRetries:t=2,timeout:s=6e5,httpAgent:n,fetch:o}){this.baseURL=e,this.maxRetries=yt("maxRetries",t),this.timeout=yt("timeout",s),this.httpAgent=n,this.fetch=o??ut}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Bs(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ds()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(async n=>{let o=n&&fe(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:o}}))}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){e={...e};let{method:s,path:n,query:o,headers:i={}}=e,a=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:gt(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,h=this.calculateContentLength(a),d=this.buildURL(n,o);"timeout"in e&&yt("timeout",e.timeout),e.timeout=e.timeout??this.timeout;let f=e.httpAgent??this.httpAgent??ht(d),E=e.timeout+1e3;typeof f?.options?.timeout=="number"&&E>(f.options.timeout??0)&&(f.options.timeout=E),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let $=this.buildHeaders({options:e,headers:i,contentLength:h,retryCount:t});return{req:{method:s,...a&&{body:a},headers:$,...f&&{agent:f},signal:e.signal??null},url:d,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:s,retryCount:n}){let o={};s&&(o["content-length"]=s);let i=this.defaultHeaders(e);return jt(o,i),jt(o,t),gt(e.body)&&H!=="node"&&delete o["content-type"],Fe(i,"x-stainless-retry-count")===void 0&&Fe(t,"x-stainless-retry-count")===void 0&&(o["x-stainless-retry-count"]=String(n)),Fe(i,"x-stainless-timeout")===void 0&&Fe(t,"x-stainless-timeout")===void 0&&e.timeout&&(o["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(o,t),o}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new c("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,s,n){return g.generate(e,t,s,n)}request(e,t=null){return new Ne(this.makeRequest(e,t))}async makeRequest(e,t){let s=await e,n=s.maxRetries??this.maxRetries;t==null&&(t=n),await this.prepareOptions(s);let{req:o,url:i,timeout:a}=this.buildRequest(s,{retryCount:n-t});if(await this.prepareRequest(o,{url:i,options:s}),Q("request",i,s,o.headers),s.signal?.aborted)throw new w;let h=new AbortController,d=await this.fetchWithTimeout(i,o,a,h).catch(Te);if(d instanceof Error){if(s.signal?.aborted)throw new w;if(t)return this.retryRequest(s,t);throw d.name==="AbortError"?new z:new D({cause:d})}let f=ft(d.headers);if(!d.ok){if(t&&this.shouldRetry(d)){let ct=`retrying, ${t} attempts remaining`;return Q(`response (error; ${ct})`,d.status,i,f),this.retryRequest(s,t,f)}let E=await d.text().catch(ct=>Te(ct).message),$=Is(E),at=$?void 0:E;throw Q(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,d.status,i,f,at),this.makeStatusError(d.status,$,at,f)}return{response:d,options:s,controller:h}}requestAPIList(e,t){let s=this.makeRequest(t,null);return new wt(this,s,e)}buildURL(e,t){let s=Ns(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return me(n)||(t={...n,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s<"u").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new c(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,s,n){let{signal:o,...i}=t||{};o&&o.addEventListener("abort",()=>n.abort());let a=setTimeout(()=>n.abort(),s),h={signal:n.signal,...i};h.method&&(h.method=h.method.toUpperCase());let d=60*1e3,f=setTimeout(()=>{if(h&&h?.agent?.sockets)for(let E of Object.values(h?.agent?.sockets).flat())E?.setKeepAlive&&E.setKeepAlive(!0,d)},d);return this.fetch.call(void 0,e,h).finally(()=>{clearTimeout(a),clearTimeout(f)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s){let n,o=s?.["retry-after-ms"];if(o){let a=parseFloat(o);Number.isNaN(a)||(n=a)}let i=s?.["retry-after"];if(i&&!n){let a=parseFloat(i);Number.isNaN(a)?n=Date.parse(i)-Date.now():n=a*1e3}if(!(n&&0<=n&&n<60*1e3)){let a=e.maxRetries??this.maxRetries;n=this.calculateDefaultRetryTimeoutMillis(t,a)}return await $s(n),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let o=t-e,i=Math.min(.5*Math.pow(2,o),8),a=1-Math.random()*.25;return i*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${U}`}},De=class{constructor(e,t,s,n){Ie.set(this,void 0),Cs(this,Ie,e,"f"),this.options=n,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new c("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let s=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[n,o]of s)e.url.searchParams.set(n,o);t.query=void 0,t.path=e.url.toString()}return await Ms(this,Ie,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ie=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},wt=class extends Ne{constructor(e,t,s){super(t,async n=>new s(e,n.response,await Ut(n),n.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},ft=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){let s=t.toString();return e[s.toLowerCase()]||e[s]}}),As={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},S=r=>typeof r=="object"&&r!==null&&!me(r)&&Object.keys(r).every(e=>Wt(As,e)),Rs=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":Lt(Deno.build.os),"X-Stainless-Arch":Ot(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":Lt(process.platform),"X-Stainless-Arch":Ot(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let r=Ts();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":U,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Ts(){if(typeof navigator>"u"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let s=t.exec(navigator.userAgent);if(s){let n=s[1]||0,o=s[2]||0,i=s[3]||0;return{browser:e,version:`${n}.${o}.${i}`}}}return null}var Ot=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",Lt=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),qt,Bs=()=>qt??(qt=Rs()),Is=r=>{try{return JSON.parse(r)}catch{return}},Fs=/^[a-z][a-z0-9+.-]*:/i,Ns=r=>Fs.test(r),$s=r=>new Promise(e=>setTimeout(e,r)),yt=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new c(`${r} must be an integer`);if(e<0)throw new c(`${r} must be a positive integer`);return e},Te=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(String(r))};var Oe=r=>{if(typeof process<"u")return process.env?.[r]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(r)?.trim()};function me(r){if(!r)return!0;for(let e in r)return!1;return!0}function Wt(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function jt(r,e){for(let t in e){if(!Wt(e,t))continue;let s=t.toLowerCase();if(!s)continue;let n=e[t];n===null?delete r[s]:n!==void 0&&(r[s]=n)}}function Q(r,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`Anthropic:DEBUG:${r}`,...e)}var Ds=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),Vt=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Os=r=>typeof r?.get=="function";var Fe=(r,e)=>{let t=e.toLowerCase();if(Os(r)){let s=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(n,o,i)=>o+i.toUpperCase());for(let n of[e,t,e.toUpperCase(),s]){let o=r.get(n);if(o)return o}}for(let[s,n]of Object.entries(r))if(s.toLowerCase()===t)return Array.isArray(n)?(n.length<=1||console.warn(`Received ${n.length} entries for the ${e} header, using the first entry.`),n[0]):n};var M=class extends De{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){if(this.options.query?.before_id){let t=this.first_id;return t?{params:{before_id:t}}:null}let e=this.last_id;return e?{params:{after_id:e}}:null}};var y=class{constructor(e){this._client=e}};var V=class extends y{retrieve(e,t){return this._client.get(`/v1/models/${e}?beta=true`,t)}list(e={},t){return S(e)?this.list({},e):this._client.getAPIList("/v1/models?beta=true",Y,{query:e,...t})}},Y=class extends M{};V.BetaModelInfosPage=Y;var Z=class r{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new B;for await(let t of this.iterator)for(let s of e.decode(t))yield JSON.parse(s);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new c("Attempted to iterate over a response with no body");return new r(pe(e.body),t)}};var K=class extends y{create(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/batches?beta=true",{body:n,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}retrieve(e,t={},s){if(S(t))return this.retrieve(e,{},t);let{betas:n}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}list(e={},t){if(S(e))return this.list({},e);let{betas:s,...n}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",ee,{query:n,...t,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}delete(e,t={},s){if(S(t))return this.delete(e,{},t);let{betas:n}=t;return this._client.delete(`/v1/messages/batches/${e}?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}cancel(e,t={},s){if(S(t))return this.cancel(e,{},t);let{betas:n}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...s,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...s?.headers}})}async results(e,t={},s){if(S(t))return this.results(e,{},t);let n=await this.retrieve(e);if(!n.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);let{betas:o}=t;return this._client.get(n.results_url,{...s,headers:{"anthropic-beta":[...o??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...s?.headers},__binaryResponse:!0})._thenUnwrap((i,a)=>Z.fromResponse(a.response,a.controller))}},ee=class extends M{};K.BetaMessageBatchesPage=ee;var Us=r=>{let e=0,t=[];for(;e<r.length;){let s=r[e];if(s==="\\"){e++;continue}if(s==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(s==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(s==="["){t.push({type:"paren",value:"["}),e++;continue}if(s==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(s===":"){t.push({type:"separator",value:":"}),e++;continue}if(s===","){t.push({type:"delimiter",value:","}),e++;continue}if(s==='"'){let a="",h=!1;for(s=r[++e];s!=='"';){if(e===r.length){h=!0;break}if(s==="\\"){if(e++,e===r.length){h=!0;break}a+=s+r[e],s=r[++e]}else a+=s,s=r[++e]}s=r[++e],h||t.push({type:"string",value:a});continue}if(s&&/\s/.test(s)){e++;continue}let o=/[0-9]/;if(s&&o.test(s)||s==="-"||s==="."){let a="";for(s==="-"&&(a+=s,s=r[++e]);s&&o.test(s)||s===".";)a+=s,s=r[++e];t.push({type:"number",value:a});continue}let i=/[a-z]/i;if(s&&i.test(s)){let a="";for(;s&&i.test(s)&&e!==r.length;)a+=s,s=r[++e];if(a=="true"||a=="false"||a==="null")t.push({type:"name",value:a});else{e++;continue}continue}e++}return t},te=r=>{if(r.length===0)return r;let e=r[r.length-1];switch(e.type){case"separator":return r=r.slice(0,r.length-1),te(r);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return r=r.slice(0,r.length-1),te(r);case"string":let s=r[r.length-2];if(s?.type==="delimiter")return r=r.slice(0,r.length-1),te(r);if(s?.type==="brace"&&s.value==="{")return r=r.slice(0,r.length-1),te(r);break;case"delimiter":return r=r.slice(0,r.length-1),te(r);break}return r},Hs=r=>{let e=[];return r.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?r.push({type:"brace",value:"}"}):t==="]"&&r.push({type:"paren",value:"]"})}),r},Ws=r=>{let e="";return r.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Le=r=>JSON.parse(Ws(Hs(te(Us(r)))));var b=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},l=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},v,O,ge,qe,ye,we,je,be,I,xe,Ue,He,se,We,Ve,bt,Kt,xt,_t,Et,St,Xt,Jt="__json_buf",Ke=class r{constructor(){v.add(this),this.messages=[],this.receivedMessages=[],O.set(this,void 0),this.controller=new AbortController,ge.set(this,void 0),qe.set(this,()=>{}),ye.set(this,()=>{}),we.set(this,void 0),je.set(this,()=>{}),be.set(this,()=>{}),I.set(this,{}),xe.set(this,!1),Ue.set(this,!1),He.set(this,!1),se.set(this,!1),We.set(this,void 0),Ve.set(this,void 0),xt.set(this,e=>{if(b(this,Ue,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new w),e instanceof w)return b(this,He,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),b(this,ge,new Promise((e,t)=>{b(this,qe,e,"f"),b(this,ye,t,"f")}),"f"),b(this,we,new Promise((e,t)=>{b(this,je,e,"f"),b(this,be,t,"f")}),"f"),l(this,ge,"f").catch(()=>{}),l(this,we,"f").catch(()=>{})}get response(){return l(this,We,"f")}get request_id(){return l(this,Ve,"f")}async withResponse(){let e=await l(this,ge,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let o of t.messages)n._addMessageParam(o);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},l(this,xt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),l(this,v,"m",_t).call(this);let{response:o,data:i}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(o);for await(let a of i)l(this,v,"m",Et).call(this,a);if(i.controller.signal?.aborted)throw new w;l(this,v,"m",St).call(this)}_connected(e){this.ended||(b(this,We,e,"f"),b(this,Ve,e?.headers.get("request-id"),"f"),l(this,qe,"f").call(this,e),this._emit("connect"))}get ended(){return l(this,xe,"f")}get errored(){return l(this,Ue,"f")}get aborted(){return l(this,He,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,I,"f")[e]||(l(this,I,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=l(this,I,"f")[e];if(!s)return this;let n=s.findIndex(o=>o.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(l(this,I,"f")[e]||(l(this,I,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{b(this,se,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){b(this,se,!0,"f"),await l(this,we,"f")}get currentMessage(){return l(this,O,"f")}async finalMessage(){return await this.done(),l(this,v,"m",bt).call(this)}async finalText(){return await this.done(),l(this,v,"m",Kt).call(this)}_emit(e,...t){if(l(this,xe,"f"))return;e==="end"&&(b(this,xe,!0,"f"),l(this,je,"f").call(this));let s=l(this,I,"f")[e];if(s&&(l(this,I,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!l(this,se,"f")&&!s?.length&&Promise.reject(n),l(this,ye,"f").call(this,n),l(this,be,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!l(this,se,"f")&&!s?.length&&Promise.reject(n),l(this,ye,"f").call(this,n),l(this,be,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",l(this,v,"m",bt).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,v,"m",_t).call(this),this._connected(null);let n=C.fromReadableStream(e,this.controller);for await(let o of n)l(this,v,"m",Et).call(this,o);if(n.controller.signal?.aborted)throw new w;l(this,v,"m",St).call(this)}[(O=new WeakMap,ge=new WeakMap,qe=new WeakMap,ye=new WeakMap,we=new WeakMap,je=new WeakMap,be=new WeakMap,I=new WeakMap,xe=new WeakMap,Ue=new WeakMap,He=new WeakMap,se=new WeakMap,We=new WeakMap,Ve=new WeakMap,xt=new WeakMap,v=new WeakSet,bt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Kt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},_t=function(){this.ended||b(this,O,void 0,"f")},Et=function(t){if(this.ended)return;let s=l(this,v,"m",Xt).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let n=s.content.at(-1);switch(t.delta.type){case"text_delta":{n.type==="text"&&this._emit("text",t.delta.text,n.text||"");break}case"citations_delta":{n.type==="text"&&this._emit("citation",t.delta.citation,n.citations??[]);break}case"input_json_delta":{n.type==="tool_use"&&n.input&&this._emit("inputJson",t.delta.partial_json,n.input);break}case"thinking_delta":{n.type==="thinking"&&this._emit("thinking",t.delta.thinking,n.thinking);break}case"signature_delta":{n.type==="thinking"&&this._emit("signature",n.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{b(this,O,s,"f");break}case"content_block_start":case"message_delta":break}},St=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=l(this,O,"f");if(!t)throw new c("request ended without sending any chunks");return b(this,O,void 0,"f"),t},Xt=function(t){let s=l(this,O,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let n=s.content.at(t.index);switch(t.delta.type){case"text_delta":{n?.type==="text"&&(n.text+=t.delta.text);break}case"citations_delta":{n?.type==="text"&&(n.citations??(n.citations=[]),n.citations.push(t.delta.citation));break}case"input_json_delta":{if(n?.type==="tool_use"){let o=n[Jt]||"";o+=t.delta.partial_json,Object.defineProperty(n,Jt,{value:o,enumerable:!1,writable:!0}),o&&(n.input=Le(o))}break}case"thinking_delta":{n?.type==="thinking"&&(n.thinking+=t.delta.thinking);break}case"signature_delta":{n?.type==="thinking"&&(n.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let o=t.shift();o?o.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((o,i)=>t.push({resolve:o,reject:i})).then(o=>o?{value:o,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new C(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Gt={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"},L=class extends y{constructor(){super(...arguments),this.batches=new K(this._client)}create(e,t){let{betas:s,...n}=e;return n.model in Gt&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${Gt[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:n,timeout:this._client._options.timeout??(n.stream?6e5:this._client._calculateNonstreamingTimeout(n.max_tokens)),...t,headers:{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0,...t?.headers},stream:e.stream??!1})}stream(e,t){return Ke.createMessage(this,e,t)}countTokens(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:n,...t,headers:{"anthropic-beta":[...s??[],"token-counting-2024-11-01"].toString(),...t?.headers}})}};L.Batches=K;L.BetaMessageBatchesPage=ee;var A=class extends y{constructor(){super(...arguments),this.models=new V(this._client),this.messages=new L(this._client)}};A.Models=V;A.BetaModelInfosPage=Y;A.Messages=L;var X=class extends y{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}};var J=class extends y{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/v1/messages/batches/${e}`,t)}list(e={},t){return S(e)?this.list({},e):this._client.getAPIList("/v1/messages/batches",ne,{query:e,...t})}delete(e,t){return this._client.delete(`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let s=await this.retrieve(e);if(!s.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})._thenUnwrap((n,o)=>Z.fromResponse(o.response,o.controller))}},ne=class extends M{};J.MessageBatchesPage=ne;var x=function(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},u=function(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)},k,q,_e,Xe,Ee,Se,Je,ve,F,ke,Ge,ze,re,Qe,Ye,vt,zt,kt,Pt,Ct,Mt,Qt,Yt="__json_buf",Ze=class r{constructor(){k.add(this),this.messages=[],this.receivedMessages=[],q.set(this,void 0),this.controller=new AbortController,_e.set(this,void 0),Xe.set(this,()=>{}),Ee.set(this,()=>{}),Se.set(this,void 0),Je.set(this,()=>{}),ve.set(this,()=>{}),F.set(this,{}),ke.set(this,!1),Ge.set(this,!1),ze.set(this,!1),re.set(this,!1),Qe.set(this,void 0),Ye.set(this,void 0),kt.set(this,e=>{if(x(this,Ge,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new w),e instanceof w)return x(this,ze,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){let t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),x(this,_e,new Promise((e,t)=>{x(this,Xe,e,"f"),x(this,Ee,t,"f")}),"f"),x(this,Se,new Promise((e,t)=>{x(this,Je,e,"f"),x(this,ve,t,"f")}),"f"),u(this,_e,"f").catch(()=>{}),u(this,Se,"f").catch(()=>{})}get response(){return u(this,Qe,"f")}get request_id(){return u(this,Ye,"f")}async withResponse(){let e=await u(this,_e,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new r;for(let o of t.messages)n._addMessageParam(o);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},u(this,kt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),u(this,k,"m",Pt).call(this);let{response:o,data:i}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(o);for await(let a of i)u(this,k,"m",Ct).call(this,a);if(i.controller.signal?.aborted)throw new w;u(this,k,"m",Mt).call(this)}_connected(e){this.ended||(x(this,Qe,e,"f"),x(this,Ye,e?.headers.get("request-id"),"f"),u(this,Xe,"f").call(this,e),this._emit("connect"))}get ended(){return u(this,ke,"f")}get errored(){return u(this,Ge,"f")}get aborted(){return u(this,ze,"f")}abort(){this.controller.abort()}on(e,t){return(u(this,F,"f")[e]||(u(this,F,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=u(this,F,"f")[e];if(!s)return this;let n=s.findIndex(o=>o.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(u(this,F,"f")[e]||(u(this,F,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{x(this,re,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){x(this,re,!0,"f"),await u(this,Se,"f")}get currentMessage(){return u(this,q,"f")}async finalMessage(){return await this.done(),u(this,k,"m",vt).call(this)}async finalText(){return await this.done(),u(this,k,"m",zt).call(this)}_emit(e,...t){if(u(this,ke,"f"))return;e==="end"&&(x(this,ke,!0,"f"),u(this,Je,"f").call(this));let s=u(this,F,"f")[e];if(s&&(u(this,F,"f")[e]=s.filter(n=>!n.once),s.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!u(this,re,"f")&&!s?.length&&Promise.reject(n),u(this,Ee,"f").call(this,n),u(this,ve,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!u(this,re,"f")&&!s?.length&&Promise.reject(n),u(this,Ee,"f").call(this,n),u(this,ve,"f").call(this,n),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",u(this,k,"m",vt).call(this))}async _fromReadableStream(e,t){let s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),u(this,k,"m",Pt).call(this),this._connected(null);let n=C.fromReadableStream(e,this.controller);for await(let o of n)u(this,k,"m",Ct).call(this,o);if(n.controller.signal?.aborted)throw new w;u(this,k,"m",Mt).call(this)}[(q=new WeakMap,_e=new WeakMap,Xe=new WeakMap,Ee=new WeakMap,Se=new WeakMap,Je=new WeakMap,ve=new WeakMap,F=new WeakMap,ke=new WeakMap,Ge=new WeakMap,ze=new WeakMap,re=new WeakMap,Qe=new WeakMap,Ye=new WeakMap,kt=new WeakMap,k=new WeakSet,vt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},zt=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new c("stream ended without producing a content block with type=text");return t.join(" ")},Pt=function(){this.ended||x(this,q,void 0,"f")},Ct=function(t){if(this.ended)return;let s=u(this,k,"m",Qt).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{let n=s.content.at(-1);switch(t.delta.type){case"text_delta":{n.type==="text"&&this._emit("text",t.delta.text,n.text||"");break}case"citations_delta":{n.type==="text"&&this._emit("citation",t.delta.citation,n.citations??[]);break}case"input_json_delta":{n.type==="tool_use"&&n.input&&this._emit("inputJson",t.delta.partial_json,n.input);break}case"thinking_delta":{n.type==="thinking"&&this._emit("thinking",t.delta.thinking,n.thinking);break}case"signature_delta":{n.type==="thinking"&&this._emit("signature",n.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{x(this,q,s,"f");break}case"content_block_start":case"message_delta":break}},Mt=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let t=u(this,q,"f");if(!t)throw new c("request ended without sending any chunks");return x(this,q,void 0,"f"),t},Qt=function(t){let s=u(this,q,"f");if(t.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new c(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{let n=s.content.at(t.index);switch(t.delta.type){case"text_delta":{n?.type==="text"&&(n.text+=t.delta.text);break}case"citations_delta":{n?.type==="text"&&(n.citations??(n.citations=[]),n.citations.push(t.delta.citation));break}case"input_json_delta":{if(n?.type==="tool_use"){let o=n[Yt]||"";o+=t.delta.partial_json,Object.defineProperty(n,Yt,{value:o,enumerable:!1,writable:!0}),o&&(n.input=Le(o))}break}case"thinking_delta":{n?.type==="thinking"&&(n.thinking+=t.delta.thinking);break}case"signature_delta":{n?.type==="thinking"&&(n.signature=t.delta.signature);break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",n=>{let o=t.shift();o?o.resolve(n):e.push(n)}),this.on("end",()=>{s=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),this.on("error",n=>{s=!0;for(let o of t)o.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((o,i)=>t.push({resolve:o,reject:i})).then(o=>o?{value:o,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new C(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var N=class extends y{constructor(){super(...arguments),this.batches=new J(this._client)}create(e,t){return e.model in Zt&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Zt[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??(e.stream?6e5:this._client._calculateNonstreamingTimeout(e.max_tokens)),...t,stream:e.stream??!1})}stream(e,t){return Ze.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}},Zt={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};N.Batches=J;N.MessageBatchesPage=ne;var j=class extends y{retrieve(e,t){return this._client.get(`/v1/models/${e}`,t)}list(e={},t){return S(e)?this.list({},e):this._client.getAPIList("/v1/models",G,{query:e,...t})}},G=class extends M{};j.ModelInfosPage=G;var es,p=class extends $e{constructor({baseURL:e=Oe("ANTHROPIC_BASE_URL"),apiKey:t=Oe("ANTHROPIC_API_KEY")??null,authToken:s=Oe("ANTHROPIC_AUTH_TOKEN")??null,...n}={}){let o={apiKey:t,authToken:s,...n,baseURL:e||"https://api.anthropic.com"};if(!o.dangerouslyAllowBrowser&&Vt())throw new c(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new X(this),this.messages=new N(this),this.models=new j(this),this.beta=new A(this),this._options=o,this.apiKey=t,this.authToken=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){let t=this.apiKeyAuth(e),s=this.bearerAuth(e);return t!=null&&!me(t)?t:s!=null&&!me(s)?s:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}};es=p;p.Anthropic=es;p.HUMAN_PROMPT=`

Human:`;p.AI_PROMPT=`

Assistant:`;p.DEFAULT_TIMEOUT=6e5;p.AnthropicError=c;p.APIError=g;p.APIConnectionError=D;p.APIConnectionTimeoutError=z;p.APIUserAbortError=w;p.NotFoundError=ce;p.ConflictError=le;p.RateLimitError=de;p.BadRequestError=oe;p.AuthenticationError=ie;p.InternalServerError=he;p.PermissionDeniedError=ae;p.UnprocessableEntityError=ue;p.toFile=Dt;p.fileFromPath=Ae;p.Completions=X;p.Messages=N;p.Models=j;p.ModelInfosPage=G;p.Beta=A;var{HUMAN_PROMPT:Tr,AI_PROMPT:Br}=p,ts=p;var et=class{client=null;settings;constructor(e){this.settings=e,this.initClient()}initClient(){this.settings.apiKey&&(this.client=new ts({apiKey:this.settings.apiKey,dangerouslyAllowBrowser:!0}))}updateSettings(e){this.settings=e,this.initClient()}isConfigured(){return!!this.client&&!!this.settings.apiKey}async sendMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let n=e.map(a=>({role:a.role,content:a.content}));if(this.settings.streamResponses&&s)return this.streamMessage(n,t,s);let i=(await this.client.messages.create({model:this.settings.model,max_tokens:4096,system:t,messages:n})).content.find(a=>a.type==="text");return i?.type==="text"?i.text:""}async streamMessage(e,t,s){if(!this.client)throw new Error("Claude API key not configured");let n="",o=this.client.messages.stream({model:this.settings.model,max_tokens:4096,system:t,messages:e});for await(let i of o)if(i.type==="content_block_delta"&&i.delta.type==="text_delta"){let a=i.delta.text;n+=a,s(a)}return n}};var tt=class{settings;preferences=[];constructor(e){this.settings=e}updateSettings(e){this.settings=e}async loadPreferences(){return this.preferences=[{id:"cotton-react",name:"Cotton React Conventions",priority:100,tags:["react","typescript"],content:`## React Conventions

- Use named exports, not default exports
- Use function declarations with forwardRef
- Add displayName for debugging
- Use semantic tokens, never primitives

## Example

\`\`\`tsx
export const CottonButton = forwardRef<HTMLButtonElement, Props>(
  function CottonButton(props, ref) {
    return <button ref={ref} {...props} />;
  }
);
CottonButton.displayName = 'CottonButton';
\`\`\``},{id:"cotton-tokens",name:"Cotton Design Tokens",priority:100,tags:["css","tokens"],content:"## Design Tokens\n\nAlways use semantic tokens:\n- `--cotton-color-text-primary` (not `--cotton-color-gray-900`)\n- `--cotton-color-action-primary` (not `--cotton-color-blue-500`)\n- `--cotton-spacing-4` (not `16px`)\n\n## BEM Naming\n\n```css\n.cotton-btn { }           /* Block */\n.cotton-btn--primary { }  /* Modifier */\n.cotton-btn__icon { }     /* Element */\n```"}],this.preferences}formatForSystemPrompt(){return this.preferences.length===0?"":`## Cotton AI Preferences

The following coding standards and conventions should be followed:

${this.preferences.sort((t,s)=>s.priority-t.priority).map(t=>`### ${t.name}

${t.content}`).join(`

---

`)}`}};var st=class{app;settings;constructor(e,t){this.app=e,this.settings=t}updateSettings(e){this.settings=e}async buildContext(e,t){if(!e)return null;let s=await this.app.vault.read(e),n=this.app.metadataCache.getFileCache(e)?.frontmatter,o={path:e.path,name:e.basename,content:this.truncateContent(s),frontmatter:n,selection:t};return this.settings.includeBacklinks&&(o.backlinks=this.getBacklinks(e)),o}truncateContent(e){let t=e.split(`
`);return t.length<=this.settings.contextLines?e:t.slice(0,this.settings.contextLines).join(`
`)+`

[...truncated]`}getBacklinks(e){let t=[],s=this.app.metadataCache.resolvedLinks;for(let[n,o]of Object.entries(s))o[e.path]&&t.push(n);return t.slice(0,10)}formatContextForPrompt(e){let t=`## Current Note: ${e.name}

`;return e.frontmatter&&(t+=`### Frontmatter
\`\`\`yaml
${JSON.stringify(e.frontmatter,null,2)}
\`\`\`

`),e.selection&&(t+=`### Selected Text
\`\`\`
${e.selection}
\`\`\`

`),t+=`### Content
\`\`\`markdown
${e.content}
\`\`\`
`,e.backlinks&&e.backlinks.length>0&&(t+=`
### Backlinks
${e.backlinks.map(s=>`- [[${s}]]`).join(`
`)}
`),t}};var R=require("obsidian"),nt=class extends R.Modal{plugin;editor;context;inputEl=null;responseEl=null;constructor(e,t,s,n){super(e),this.plugin=t,this.editor=s,this.context=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-ask-claude-modal"),e.createEl("h2",{text:"Ask Claude"}),this.context&&e.createEl("p",{text:`Context: ${this.context.name}`,cls:"cotton-context-label"});let t=e.createDiv({cls:"cotton-input-container"});if(this.inputEl=new R.TextAreaComponent(t),this.inputEl.inputEl.addClass("cotton-input"),this.inputEl.setPlaceholder("Ask a question about this note..."),this.inputEl.inputEl.rows=3,this.context?.selection){let i=e.createDiv({cls:"cotton-selection-preview"});i.createEl("strong",{text:"Selected: "}),i.createEl("code",{text:this.context.selection.length>100?this.context.selection.slice(0,100)+"...":this.context.selection})}let s=e.createDiv({cls:"cotton-button-container"});s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),s.createEl("button",{text:"Ask",cls:"mod-cta"}).addEventListener("click",()=>this.handleAsk()),this.responseEl=e.createDiv({cls:"cotton-response"}),this.responseEl.style.display="none",this.inputEl.inputEl.focus(),this.inputEl.inputEl.addEventListener("keydown",i=>{i.key==="Enter"&&(i.metaKey||i.ctrlKey)&&this.handleAsk()})}async handleAsk(){let e=this.inputEl?.getValue();if(!e?.trim()){new R.Notice("Please enter a question");return}if(!this.plugin.claude.isConfigured()){new R.Notice("Claude API key not configured. Check settings.");return}this.responseEl&&(this.responseEl.style.display="block",this.responseEl.empty(),this.responseEl.createEl("p",{text:"Thinking...",cls:"cotton-thinking"}));try{let t=this.plugin.preferences.formatForSystemPrompt(),s=this.context?this.plugin.contextBuilder.formatContextForPrompt(this.context):"",n=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${t}

${s}

Respond concisely and helpfully. Use markdown formatting.`,o=[{role:"user",content:e,timestamp:Date.now()}],i="";if(this.responseEl&&this.responseEl.empty(),i=await this.plugin.claude.sendMessage(o,n,a=>{this.responseEl&&(this.responseEl.textContent=(this.responseEl.textContent||"")+a)}),this.responseEl&&i){this.responseEl.empty();let a=this.responseEl.createDiv({cls:"cotton-response-content"});a.innerHTML=i}}catch(t){new R.Notice(`Error: ${t instanceof Error?t.message:"Unknown error"}`),this.responseEl&&(this.responseEl.empty(),this.responseEl.createEl("p",{text:`Error: ${t instanceof Error?t.message:"Unknown error"}`,cls:"cotton-error"}))}}onClose(){let{contentEl:e}=this;e.empty()}};function ss(r){r.addCommand({id:"ask-claude",name:"Ask Claude",editorCallback:async(e,t)=>{let s=e.getSelection(),n=t.file,o=n?await r.contextBuilder.buildContext(n,s||void 0):null;new nt(r.app,r,e,o).open()}}),r.addCommand({id:"ask-claude-general",name:"Ask Claude (General)",callback:async()=>{let t=r.app.workspace.getActiveViewOfType(R.MarkdownView)?.file||null,s=t?await r.contextBuilder.buildContext(t):null;new nt(r.app,r,null,s).open()}})}var T=require("obsidian");var m=require("obsidian"),rt=class extends m.Modal{plugin;message;constructor(e,t,s){super(e),this.plugin=t,this.message=s}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Save Response"});let t=e.createDiv({cls:"cotton-save-options"}),s=[{id:"quick-save",label:"Quick Save",description:`Save to ${this.plugin.settings.chatFolder}/Responses`,icon:"zap",action:()=>this.quickSave()},{id:"current-note",label:"Append to Current Note",description:"Add response to the active note",icon:"file-plus",action:()=>this.appendToCurrentNote()},{id:"new-note",label:"Create New Note",description:"Save as a new note with custom name",icon:"file-text",action:()=>this.createNewNote()},{id:"browse",label:"Browse...",description:"Choose a specific folder",icon:"folder",action:()=>this.browseForFolder()}];for(let n of s){let o=t.createDiv({cls:"cotton-save-option"});o.addEventListener("click",async()=>{await n.action()});let i=o.createDiv({cls:"cotton-save-option-icon"});(0,m.setIcon)(i,n.icon);let a=o.createDiv({cls:"cotton-save-option-text"});a.createDiv({cls:"cotton-save-option-label",text:n.label}),a.createDiv({cls:"cotton-save-option-desc",text:n.description})}}formatResponseContent(){let e=new Date,t=e.toISOString(),s=e.toLocaleString();return`---
source: cotton-ai
saved: ${t}
model: ${this.getModelName()}
---

${this.message.content}

---
*Saved from Cotton AI on ${s}*
`}getModelName(){let e=this.plugin.settings.model;return e.includes("sonnet")?"Sonnet 4":e.includes("opus")?"Opus 4":e.includes("haiku")?"Haiku 3.5":"Claude"}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}generateFilename(){let e=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),t=this.message.content.slice(0,30).replace(/[^a-zA-Z0-9 ]/g,"").trim().replace(/\s+/g,"-")||"response";return`${e}-${t}`}async quickSave(){try{let e=this.plugin.settings.chatFolder||"Cotton/Chats",t=`${e}/Responses`;await this.ensureFolderExists(e),await this.ensureFolderExists(t);let s=`${t}/${this.generateFilename()}.md`,n=this.formatResponseContent();await this.app.vault.create(s,n),new m.Notice(`Saved to ${s}`),this.close()}catch(e){new m.Notice(`Failed to save: ${e instanceof Error?e.message:"Unknown error"}`)}}async appendToCurrentNote(){try{let e=this.app.workspace.getActiveFile();if(!e){new m.Notice("No active note to append to");return}let t=await this.app.vault.read(e),s=`

---

## AI Response

${this.message.content}

*Added from Cotton AI on ${new Date().toLocaleString()}*
`;await this.app.vault.modify(e,t+s),new m.Notice(`Appended to ${e.basename}`),this.close()}catch(e){new m.Notice(`Failed to append: ${e instanceof Error?e.message:"Unknown error"}`)}}async createNewNote(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Create New Note"});let t=e.createDiv({cls:"cotton-save-input-container"});t.createEl("label",{text:"Note name:",cls:"cotton-save-label"});let s=t.createEl("input",{type:"text",cls:"cotton-save-input",value:this.generateFilename()});t.createEl("label",{text:"Folder:",cls:"cotton-save-label"});let n=t.createEl("input",{type:"text",cls:"cotton-save-input",value:this.plugin.settings.chatFolder||"Cotton/Chats"}),o=e.createDiv({cls:"cotton-save-buttons"});o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),o.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",async()=>{let h=s.value.trim(),d=n.value.trim();if(!h){new m.Notice("Please enter a note name");return}try{await this.ensureFolderExists(d);let f=`${d}/${h}.md`,E=this.formatResponseContent();await this.app.vault.create(f,E),new m.Notice(`Created ${f}`),this.close()}catch(f){new m.Notice(`Failed to create: ${f instanceof Error?f.message:"Unknown error"}`)}}),s.focus(),s.select()}async browseForFolder(){let{contentEl:e}=this;e.empty(),e.addClass("cotton-save-modal"),e.createEl("h3",{text:"Select Folder"});let t=e.createDiv({cls:"cotton-folder-list"}),s=this.getAllFolders(),n=t.createDiv({cls:"cotton-folder-option"});(0,m.setIcon)(n.createSpan(),"home"),n.createSpan({text:" / (root)"}),n.addEventListener("click",()=>this.saveToFolder(""));for(let i of s){let a=t.createDiv({cls:"cotton-folder-option"});(0,m.setIcon)(a.createSpan(),"folder"),a.createSpan({text:` ${i.path}`}),a.addEventListener("click",()=>this.saveToFolder(i.path))}e.createEl("button",{text:"Cancel",cls:"cotton-cancel-btn"}).addEventListener("click",()=>this.close())}getAllFolders(){let e=[],t=this.app.vault.getRoot(),s=n=>{for(let o of n.children)o instanceof m.TFolder&&(e.push(o),s(o))};return s(t),e.sort((n,o)=>n.path.localeCompare(o.path))}async saveToFolder(e){try{let t=e?`${e}/${this.generateFilename()}.md`:`${this.generateFilename()}.md`,s=this.formatResponseContent();await this.app.vault.create(t,s),new m.Notice(`Saved to ${t}`),this.close()}catch(t){new m.Notice(`Failed to save: ${t instanceof Error?t.message:"Unknown error"}`)}}onClose(){let{contentEl:e}=this;e.empty()}};var Pe="cotton-chat-view",ot=class extends T.ItemView{plugin;messages=[];inputEl=null;messagesEl=null;isLoading=!1;constructor(e,t){super(e),this.plugin=t}getViewType(){return Pe}getDisplayText(){return"Cotton AI"}getIcon(){return"circle"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("cotton-chat-container");let t=e.createDiv({cls:"cotton-chat-header"});t.createEl("h4",{text:"Cotton AI"});let s=t.createEl("span",{text:this.getModelName(),cls:"cotton-model-badge"});t.createEl("button",{text:"Clear",cls:"cotton-clear-btn"}).addEventListener("click",()=>this.clearChat()),this.messagesEl=e.createDiv({cls:"cotton-chat-messages"});let o=e.createDiv({cls:"cotton-chat-input-container"});this.inputEl=o.createEl("textarea",{cls:"cotton-chat-input",attr:{placeholder:"Ask Claude...",rows:"3"}}),this.inputEl.addEventListener("keydown",d=>{d.key==="Enter"&&(d.metaKey||d.ctrlKey)&&(d.preventDefault(),this.sendMessage())});let i=o.createDiv({cls:"cotton-chat-buttons"});i.createEl("button",{text:"Add Context",cls:"cotton-context-btn"}).addEventListener("click",()=>this.addCurrentNoteContext()),i.createEl("button",{text:"Send",cls:"mod-cta cotton-send-btn"}).addEventListener("click",()=>this.sendMessage()),await this.loadMessages()}async onClose(){await this.saveMessages()}getModelName(){let e=this.plugin.settings.model;return e.includes("sonnet")?"Sonnet 4":e.includes("opus")?"Opus 4":e.includes("haiku")?"Haiku 3.5":"Claude"}async sendMessage(){if(!this.inputEl||this.isLoading)return;let e=this.inputEl.value.trim();if(!e)return;if(!this.plugin.claude.isConfigured()){this.addSystemMessage("API key not configured. Check settings.");return}let t={role:"user",content:e,timestamp:Date.now()};this.messages.push(t),this.renderMessage(t),this.inputEl.value="",this.isLoading=!0;let s=this.addThinkingIndicator();try{let n=this.app.workspace.getActiveFile(),o=n?await this.plugin.contextBuilder.buildContext(n):null,i=this.plugin.preferences.formatForSystemPrompt(),a=o?this.plugin.contextBuilder.formatContextForPrompt(o):"",h=`You are a helpful AI assistant integrated with Obsidian. You help users with their notes and coding tasks.

${i}

${a}

Respond concisely and helpfully. Use markdown formatting.`,d="",f=this.messagesEl?.createDiv({cls:"cotton-message cotton-message-assistant"});s&&s.remove(),await this.plugin.claude.sendMessage(this.messages.filter($=>$.role!=="system"),h,$=>{d+=$,f&&(f.textContent=d)}),f&&d&&(f.empty(),await T.MarkdownRenderer.render(this.app,d,f,"",this.plugin));let E={role:"assistant",content:d,timestamp:Date.now()};this.messages.push(E),await this.saveToNote()}catch(n){s&&s.remove(),this.addSystemMessage(`Error: ${n instanceof Error?n.message:"Unknown error"}`)}finally{this.isLoading=!1}}renderMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:`cotton-message cotton-message-${e.role}`});if(e.role==="user")t.textContent=e.content;else{let s=t.createDiv({cls:"cotton-message-actions"}),n=s.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Copy to clipboard"}});(0,T.setIcon)(n,"copy"),n.addEventListener("click",()=>this.copyToClipboard(e.content));let o=s.createEl("button",{cls:"cotton-action-icon",attr:{"aria-label":"Save to note"}});(0,T.setIcon)(o,"save"),o.addEventListener("click",()=>this.openSaveModal(e));let i=t.createDiv({cls:"cotton-message-content"});T.MarkdownRenderer.render(this.app,e.content,i,"",this.plugin)}this.messagesEl.scrollTop=this.messagesEl.scrollHeight}async copyToClipboard(e){await navigator.clipboard.writeText(e),new T.Notice("Copied to clipboard")}openSaveModal(e){new rt(this.app,this.plugin,e).open()}addThinkingIndicator(){if(!this.messagesEl)return null;let e=this.messagesEl.createDiv({cls:"cotton-thinking"});return e.textContent="Thinking...",this.messagesEl.scrollTop=this.messagesEl.scrollHeight,e}addSystemMessage(e){if(!this.messagesEl)return;let t=this.messagesEl.createDiv({cls:"cotton-message cotton-message-system"});t.textContent=e}async addCurrentNoteContext(){let e=this.app.workspace.getActiveFile();if(!e){this.addSystemMessage("No active note to add as context.");return}if(this.inputEl){let t=this.inputEl.value;this.inputEl.value=t+(t?`

`:"")+`[Context: ${e.basename}]`,this.inputEl.focus()}}clearChat(){this.messages=[],this.messagesEl&&this.messagesEl.empty()}async loadMessages(){let e=await this.plugin.loadData();e?.chatHistory&&(this.messages=e.chatHistory,this.messages.forEach(t=>this.renderMessage(t)))}async saveMessages(){let e=await this.plugin.loadData()||{};e.chatHistory=this.messages,await this.plugin.saveData(e)}async saveToNote(){if(this.messages.length===0)return;let e=this.plugin.settings.chatFolder||"Cotton/Chats",t=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),s=this.messages.find(a=>a.role==="user"),n=s?s.content.slice(0,30).replace(/[^a-zA-Z0-9 ]/g,"").trim():"chat",o=`${e}/${t}-${n}.md`,i=`# Cotton AI Chat

`;i+=`Date: ${new Date().toLocaleString()}
`,i+=`Model: ${this.getModelName()}

---

`;for(let a of this.messages)a.role==="user"?i+=`## Question

${a.content}

`:a.role==="assistant"&&(i+=`## Answer

${a.content}

---

`);try{let a=e;this.app.vault.getAbstractFileByPath(a)||await this.app.vault.createFolder(a);let h=this.app.vault.getAbstractFileByPath(o);h?await this.app.vault.modify(h,i):await this.app.vault.create(o,i)}catch(a){console.error("Failed to save chat to note:",a)}}};var At={apiKey:"",model:"claude-sonnet-4-20250514",personalPrefsPath:"",teamPrefsPath:"",streamResponses:!0,contextLines:100,includeBacklinks:!0,chatFolder:"Cotton/Chats"};var it=class extends ns.Plugin{settings=At;claude;preferences;contextBuilder;async onload(){console.log("Loading Cotton AI plugin"),await this.loadSettings(),this.claude=new et(this.settings),this.preferences=new tt(this.settings),this.contextBuilder=new st(this.app,this.settings),await this.preferences.loadPreferences(),this.addSettingTab(new Ce(this.app,this)),this.registerView(Pe,e=>new ot(e,this)),ss(this),this.addCommand({id:"toggle-chat-panel",name:"Toggle Chat Panel",callback:()=>this.toggleChatPanel()}),this.addRibbonIcon("circle","Cotton AI",()=>{this.toggleChatPanel()}),console.log("Cotton AI plugin loaded")}async toggleChatPanel(){let e=this.app.workspace.getLeavesOfType(Pe);if(e.length>0){let t=e[0];t.view.containerEl.isShown()?t.detach():this.app.workspace.revealLeaf(t)}else{let t=this.app.workspace.getLeftLeaf(!1);t&&(await t.setViewState({type:Pe,active:!0}),this.app.workspace.revealLeaf(t))}}onunload(){console.log("Unloading Cotton AI plugin")}async loadSettings(){this.settings=Object.assign({},At,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.claude.updateSettings(this.settings),this.preferences.updateSettings(this.settings),this.contextBuilder.updateSettings(this.settings)}};
